<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>8 Special Tasks | mlr3 book</title>
<meta name="author" content="Marc Becker">
<meta name="author" content="Martin Binder">
<meta name="author" content="Bernd Bischl">
<meta name="author" content="Lars Kotthoff">
<meta name="author" content="Michel Lang">
<meta name="author" content="Florian Pfisterer">
<meta name="author" content="Nicholas G. Reich">
<meta name="author" content="Jakob Richter">
<meta name="author" content="Patrick Schratz">
<meta name="author" content="Raphael Sonabend">
<meta name="author" content="Damir Pulatov">
<meta name="description" content="This chapter explores the different functions of mlr3 when dealing with specific data sets that require further statistical modification to undertake sensible analysis. Following topics are...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="8 Special Tasks | mlr3 book">
<meta property="og:type" content="book">
<meta property="og:url" content="https://mlr3book.mlr-org.com/special-tasks.html">
<meta property="og:image" content="https://mlr3book.mlr-org.com//block.png">
<meta property="og:description" content="This chapter explores the different functions of mlr3 when dealing with specific data sets that require further statistical modification to undertake sensible analysis. Following topics are...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="8 Special Tasks | mlr3 book">
<meta name="twitter:description" content="This chapter explores the different functions of mlr3 when dealing with specific data sets that require further statistical modification to undertake sensible analysis. Following topics are...">
<meta name="twitter:image" content="https://mlr3book.mlr-org.com//block.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">mlr3 book</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Quickstart</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction and Overview</a></li>
<li><a class="" href="basics.html"><span class="header-section-number">2</span> Basics</a></li>
<li><a class="" href="perf-eval-cmp.html"><span class="header-section-number">3</span> Performance Evaluation and Comparison</a></li>
<li><a class="" href="optimization.html"><span class="header-section-number">4</span> Model Optimization</a></li>
<li><a class="" href="pipelines.html"><span class="header-section-number">5</span> Pipelines</a></li>
<li><a class="" href="technical.html"><span class="header-section-number">6</span> Technical</a></li>
<li><a class="" href="extending.html"><span class="header-section-number">7</span> Extending</a></li>
<li><a class="active" href="special-tasks.html"><span class="header-section-number">8</span> Special Tasks</a></li>
<li><a class="" href="interpretation.html"><span class="header-section-number">9</span> Model Interpretation</a></li>
<li><a class="" href="appendix.html"><span class="header-section-number">10</span> Appendix</a></li>
<li><a class="" href="citation-info.html">Citation Info</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/mlr-org/mlr3book">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="special-tasks" class="section level1" number="8">
<h1>
<span class="header-section-number">8</span> Special Tasks<a class="anchor" aria-label="anchor" href="#special-tasks"><i class="fas fa-link"></i></a>
</h1>
<p>This chapter explores the different functions of <code>mlr3</code> when dealing with specific data sets that require further statistical modification to undertake sensible analysis.
Following topics are discussed:</p>
<p><strong>Survival Analysis</strong></p>
<p>This sub-chapter explains how to conduct sound <a href="special-tasks.html#survival">survival analysis</a> in mlr3.
<a href="special-tasks.html#survival">Survival analysis</a> is used to monitor the period of time until a specific event takes places.
This specific event could be e.g. death, transmission of a disease, marriage or divorce.
Two considerations are important when conducting <a href="special-tasks.html#survival">survival analysis</a>:</p>
<ul>
<li>Whether the event occurred within the frame of the given data</li>
<li>How much time it took until the event occurred</li>
</ul>
<p>In summary, this sub-chapter explains how to account for these considerations and conduct survival analysis using the <code>mlr3proba</code> extension package.</p>
<p><strong>Density Estimation</strong></p>
<p>This sub-chapter explains how to conduct (unconditional) <a href="special-tasks.html#density">density estimation</a> in mlr3.
<a href="special-tasks.html#density">Density estimation</a> is used to estimate the probability density function of a continuous variable. Unconditional density estimation is an unsupervised task so there is no ‘value’ to predict, instead densities are <em>estimated</em>.</p>
<p>This sub-chapter explains how to estimate probability distributions for continuous variables using the <code>mlr3proba</code> extension package.</p>
<p><strong>Spatiotemporal Analysis</strong></p>
<p><a href="special-tasks.html#spatiotemporal">Spatiotemporal analysis</a> data observations entail reference information about spatial and temporal characteristics.
One of the largest issues of <a href="special-tasks.html#spatiotemporal">spatiotemporal data analysis</a> is the inevitable presence of auto-correlation in the data.
Auto-correlation is especially severe in data with marginal spatiotemporal variation.
The sub-chapter on <a href="special-tasks.html#spatiotemporal">Spatiotemporal analysis</a> provides instructions on how to account for spatiotemporal data.</p>
<p><strong>Ordinal Analysis</strong></p>
<p>This is work in progress.
See <a href="https://github.com/mlr-org/mlr3ordinal">mlr3ordinal</a> for the current state.</p>
<p><strong>Functional Analysis</strong></p>
<p><a href="special-tasks.html#functional">Functional analysis</a> contains data that consists of curves varying over a continuum e.g. time, frequency or wavelength.
This type of analysis is frequently used when examining measurements over various time points.
Steps on how to accommodate functional data structures in mlr3 are explained in the <a href="special-tasks.html#functional">functional analysis</a> sub-chapter.</p>
<p><strong>Multilabel Classification</strong></p>
<p><a href="special-tasks.html#multilabel">Multilabel classification</a> deals with objects that can belong to more than one category at the same time.
Numerous target labels are attributed to a single observation.
Working with multilabel data requires one to use modified algorithms, to accommodate data specific characteristics.
Two approaches to <a href="special-tasks.html#multilabel">multilabel classification</a> are prominently used:</p>
<ul>
<li>The problem transformation method</li>
<li>The algorithm adaption method</li>
</ul>
<p>Instructions on how to deal with <a href="special-tasks.html#multilabel">multilabel classification</a> in mlr3 can be found in this sub-chapter.</p>
<p><strong>Cost Sensitive Classification</strong></p>
<p>This sub-chapter deals with the implementation of <a href="special-tasks.html#cost-sens">cost-sensitive classification</a>.
Regular classification aims to minimize the misclassification rate and thus all types of misclassification errors are deemed equally severe.
<a href="special-tasks.html#cost-sens">Cost-sensitive classification</a> is a setting where the costs caused by different kinds of errors are not assumed to be equal.
The objective is to minimize the expected costs.</p>
<p>Analytical data for a big credit institution is used as a use case to illustrate the different features.
Firstly, the sub-chapter provides guidance on how to implement a first model.
Subsequently, the sub-chapter contains instructions on how to modify cost sensitivity measures, thresholding and threshold tuning.</p>
<p><strong>Cluster Analysis</strong></p>
<p><a href="special-tasks.html#cluster">Cluster analysis</a> aims to group data into clusters such that objects that are similar end up in the same cluster.<br>
Fundamentally, clustering and classification are similar.
However, clustering is an unsupervised task because observations do not contain true labels while in classification, labels are needed in order to train a model.</p>
<p>This sub-chapter explains how to perform <a href="special-tasks.html#cluster">cluster analysis</a> in mlr3 with the help of <code>mlr3cluster</code> extension package.</p>

<div id="survival" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> Survival Analysis<a class="anchor" aria-label="anchor" href="#survival"><i class="fas fa-link"></i></a>
</h2>
<p>Survival analysis is a sub-field of supervised machine learning in which the aim is to predict the survival distribution of a given individual.
Arguably the main feature of survival analysis is that unlike classification and regression, learners are trained on two features:</p>
<ol style="list-style-type: decimal">
<li>the time until the event takes place</li>
<li>the event type: either censoring or death.</li>
</ol>
<p>At a particular time-point, an individual is either: alive, dead, or censored.
Censoring occurs if it is unknown if an individual is alive or dead.
For example, say we are interested in patients in hospital and every day it is recorded if they are alive or dead, then after a patient leaves it is unknown if they are alive or dead, hence they are censored.
If there was no censoring, then ordinary regression analysis could be used instead.
Furthermore, survival data contains solely positive values and therefore needs to be transformed to avoid biases.</p>
<p>Note that survival analysis accounts for both censored and uncensored observations while adjusting respective model parameters.</p>
<p>The package <a href="https://mlr3proba.mlr-org.com">mlr3proba</a> <span class="citation">(<a href="references.html#ref-mlr3proba" role="doc-biblioref">Sonabend et al. 2021</a>)</span> extends <a href="https://mlr3.mlr-org.com">mlr3</a> with the following objects for survival analysis:</p>
<ul>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/TaskSurv.html"><code>TaskSurv</code></a> to define (censored) survival tasks</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/LearnerSurv.html"><code>LearnerSurv</code></a> as base class for survival learners</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/PredictionSurv.html"><code>PredictionSurv</code></a> as specialized class for <a href="https://mlr3.mlr-org.com/reference/Prediction.html"><code>Prediction</code></a> objects</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/MeasureSurv.html"><code>MeasureSurv</code></a> as specialized class for performance measures</li>
</ul>
<p>For a good introduction to survival analysis see <em>Modelling Survival Data in Medical Research</em> <span class="citation">(<a href="references.html#ref-Collett2014" role="doc-biblioref">Collett 2014</a>)</span>.</p>
<div id="tasksurv" class="section level3" number="8.1.1">
<h3>
<span class="header-section-number">8.1.1</span> TaskSurv<a class="anchor" aria-label="anchor" href="#tasksurv"><i class="fas fa-link"></i></a>
</h3>
<p>Unlike <code>TaskClassif</code> and <code>TaskRegr</code> which have a single ‘target’ argument, <code>TaskSurv</code> mimics the
<code><a href="https://rdrr.io/pkg/survival/man/Surv.html">survival::Surv</a></code> object and has three-four target arguments (dependent on censoring type).
A <code>TaskSurv</code> can be constructed with the function <a href="https://mlr3proba.mlr-org.com/reference/as_task_surv.html"><code>as_task_surv()</code></a>:</p>
<div class="sourceCode" id="cb717"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3.mlr-org.com">"mlr3"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3proba.mlr-org.com">"mlr3proba"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/therneau/survival">"survival"</a></span><span class="op">)</span>

<span class="fu"><a href="https://mlr3proba.mlr-org.com/reference/as_task_surv.html">as_task_surv</a></span><span class="op">(</span><span class="fu">survival</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survival/man/bladder.html">bladder2</a></span><span class="op">[</span>, <span class="op">-</span><span class="fl">1L</span><span class="op">]</span>, id <span class="op">=</span> <span class="st">"interval_censored"</span>,
  time <span class="op">=</span> <span class="st">"start"</span>, time2 <span class="op">=</span> <span class="st">"stop"</span>, type <span class="op">=</span> <span class="st">"interval"</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;TaskSurv:interval_censored&gt; (178 x 7)
## * Target: start, stop, event
## * Properties: -
## * Features (4):
##   - dbl (2): enum, rx
##   - int (2): number, size</code></pre>
<div class="sourceCode" id="cb719"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># type = "right" is default</span>
<span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3proba.mlr-org.com/reference/as_task_surv.html">as_task_surv</a></span><span class="op">(</span><span class="fu">survival</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survival/man/rats.html">rats</a></span>, id <span class="op">=</span> <span class="st">"right_censored"</span>,
  time <span class="op">=</span> <span class="st">"time"</span>, event <span class="op">=</span> <span class="st">"status"</span>, type <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">task</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;TaskSurv:right_censored&gt; (300 x 5)
## * Target: time, status
## * Properties: -
## * Features (3):
##   - int (1): litter
##   - dbl (1): rx
##   - chr (1): sex</code></pre>
<div class="sourceCode" id="cb721"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># the target column is a survival object:</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="fu">truth</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 101+  49  104+  91+ 104+ 102+</code></pre>
<div class="sourceCode" id="cb723"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># kaplan-meier plot</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3viz.mlr-org.com">"mlr3viz"</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">task</span><span class="op">)</span></code></pre></div>
<pre><code>## Registered S3 method overwritten by 'GGally':
##   method from   
##   +.gg   ggplot2</code></pre>
<div class="inline-figure"><img src="08-special-survival_files/figure-html/07-special-survival-001-1.svg" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="predict-types---crank-lp-and-distr" class="section level3" number="8.1.2">
<h3>
<span class="header-section-number">8.1.2</span> Predict Types - crank, lp, and distr<a class="anchor" aria-label="anchor" href="#predict-types---crank-lp-and-distr"><i class="fas fa-link"></i></a>
</h3>
<p>Every <code>PredictionSurv</code> object can predict one or more of:</p>
<ul>
<li>
<code>lp</code> - Linear predictor calculated as the fitted coefficients multiplied by the test data.</li>
<li>
<code>distr</code> - Predicted survival distribution, either discrete or continuous. Implemented in <a href="https://cran.r-project.org/package=distr6">distr6</a>.</li>
<li>
<code>crank</code> - Continuous risk ranking.</li>
</ul>
<p><code>lp</code> and <code>crank</code> can be used with measures of discrimination such as the concordance index.
Whilst <code>lp</code> is a specific mathematical prediction, <code>crank</code> is any continuous ranking that identifies who is more or less likely to experience the event.
So far the only implemented learner that only returns a continuous ranking is <code>surv.svm</code>.
If a <code>PredictionSurv</code> returns an <code>lp</code> then the <code>crank</code> is identical to this.
Otherwise <code>crank</code> is calculated as the expectation of the predicted survival distribution.
Note that for linear proportional hazards models, the ranking (but not necessarily the <code>crank</code> score itself) given by <code>lp</code> and the expectation of <code>distr</code>, is identical.</p>
<p>The example below uses the <a href="https://mlr3proba.mlr-org.com/reference/mlr_tasks_rats.html"><code>rats</code></a> task shipped with <a href="https://mlr3proba.mlr-org.com">mlr3proba</a>.</p>
<div class="sourceCode" id="cb725"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"rats"</span><span class="op">)</span>
<span class="va">learn</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"surv.coxph"</span><span class="op">)</span>

<span class="va">train_set</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="va">nrow</span>, <span class="fl">0.8</span> <span class="op">*</span> <span class="va">task</span><span class="op">$</span><span class="va">nrow</span><span class="op">)</span>
<span class="va">test_set</span> <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="va">nrow</span><span class="op">)</span>, <span class="va">train_set</span><span class="op">)</span>

<span class="va">learn</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span>, row_ids <span class="op">=</span> <span class="va">train_set</span><span class="op">)</span>
<span class="va">prediction</span> <span class="op">=</span> <span class="va">learn</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span>, row_ids <span class="op">=</span> <span class="va">test_set</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;PredictionSurv&gt; for 60 observations:
##     row_ids time status   crank      lp     distr
##           1  101  FALSE  0.3492  0.3492 &lt;list[1]&gt;
##           8  102  FALSE -0.4183 -0.4183 &lt;list[1]&gt;
##          15  104  FALSE -0.4003 -0.4003 &lt;list[1]&gt;
## ---                                              
##         291  104  FALSE  0.4282  0.4282 &lt;list[1]&gt;
##         292  104  FALSE -1.7897 -1.7897 &lt;list[1]&gt;
##         295  104  FALSE  1.2318  1.2318 &lt;list[1]&gt;</code></pre>
</div>
<div id="composition" class="section level3" number="8.1.3">
<h3>
<span class="header-section-number">8.1.3</span> Composition<a class="anchor" aria-label="anchor" href="#composition"><i class="fas fa-link"></i></a>
</h3>
<p>Finally we take a look at the <code>PipeOp</code>s implemented in <a href="https://mlr3proba.mlr-org.com">mlr3proba</a>, which are used for composition of predict types.
For example, a predict linear predictor does not have a lot of meaning by itself, but it can be composed into a survival distribution.
See <a href="https://mlr3pipelines.mlr-org.com">mlr3pipelines</a> for full tutorials and details on <code>PipeOp</code>s.</p>
<div class="sourceCode" id="cb727"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3pipelines.mlr-org.com">"mlr3pipelines"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3learners.mlr-org.com">"mlr3learners"</a></span><span class="op">)</span>
<span class="co"># PipeOpDistrCompositor - Train one model with a baseline distribution,</span>
<span class="co"># (Kaplan-Meier or Nelson-Aalen), and another with a predicted linear predictor.</span>
<span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"rats"</span><span class="op">)</span>
<span class="co"># remove the factor column for support with glmnet</span>
<span class="va">task</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"litter"</span>, <span class="st">"rx"</span><span class="op">)</span><span class="op">)</span>
<span class="va">learner_lp</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"surv.glmnet"</span><span class="op">)</span>
<span class="va">learner_distr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"surv.kaplan"</span><span class="op">)</span>
<span class="va">prediction_lp</span> <span class="op">=</span> <span class="va">learner_lp</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>
<span class="va">prediction_distr</span> <span class="op">=</span> <span class="va">learner_distr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>
<span class="va">prediction_lp</span><span class="op">$</span><span class="va">distr</span>

<span class="co"># Doesn't need training. Base = baseline distribution. ph = Proportional hazards.</span>

<span class="va">pod</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com//reference/po.html">po</a></span><span class="op">(</span><span class="st">"compose_distr"</span>, form <span class="op">=</span> <span class="st">"ph"</span>, overwrite <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">prediction</span> <span class="op">=</span> <span class="va">pod</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>base <span class="op">=</span> <span class="va">prediction_distr</span>, pred <span class="op">=</span> <span class="va">prediction_lp</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">output</span>

<span class="co"># Now we have a predicted distr!</span>

<span class="va">prediction</span><span class="op">$</span><span class="va">distr</span>

<span class="co"># This can all be simplified by using the distrcompose pipeline</span>

<span class="va">glm.distr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com//reference/ppl.html">ppl</a></span><span class="op">(</span><span class="st">"distrcompositor"</span>, learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"surv.glmnet"</span><span class="op">)</span>,
  estimator <span class="op">=</span> <span class="st">"kaplan"</span>, form <span class="op">=</span> <span class="st">"ph"</span>, overwrite <span class="op">=</span> <span class="cn">FALSE</span>, graph_learner <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">glm.distr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></code></pre></div>
</div>
<div id="benchmark-experiment" class="section level3" number="8.1.4">
<h3>
<span class="header-section-number">8.1.4</span> Benchmark Experiment<a class="anchor" aria-label="anchor" href="#benchmark-experiment"><i class="fas fa-link"></i></a>
</h3>
<p>Finally, we conduct a small benchmark study on the <a href="https://mlr3proba.mlr-org.com/reference/mlr_tasks_rats.html"><code>rats</code></a> task using some of the integrated survival learners:</p>
<div class="sourceCode" id="cb728"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3learners.mlr-org.com">"mlr3learners"</a></span><span class="op">)</span>

<span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"rats"</span><span class="op">)</span>

<span class="co"># some integrated learners</span>
<span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrns</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"surv.coxph"</span>, <span class="st">"surv.kaplan"</span>, <span class="st">"surv.ranger"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">learners</span><span class="op">)</span></code></pre></div>
<pre><code>## [[1]]
## &lt;LearnerSurvCoxPH:surv.coxph&gt;
## * Model: -
## * Parameters: list()
## * Packages: mlr3, survival, distr6
## * Predict Type: distr
## * Feature types: logical, integer, numeric, factor
## * Properties: weights
## 
## [[2]]
## &lt;LearnerSurvKaplan:surv.kaplan&gt;
## * Model: -
## * Parameters: list()
## * Packages: mlr3, survival, distr6
## * Predict Type: crank
## * Feature types: logical, integer, numeric, character, factor, ordered
## * Properties: missings
## 
## [[3]]
## &lt;LearnerSurvRanger:surv.ranger&gt;
## * Model: -
## * Parameters: num.threads=1
## * Packages: mlr3, mlr3learners, ranger
## * Predict Type: distr
## * Feature types: logical, integer, numeric, character, factor, ordered
## * Properties: importance, oob_error, weights</code></pre>
<div class="sourceCode" id="cb730"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Harrell's C-Index for survival</span>
<span class="va">measure</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"surv.cindex"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">measure</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;MeasureSurvCindex:surv.harrell_c&gt;
## * Packages: mlr3
## * Range: [0, 1]
## * Minimize: FALSE
## * Average: macro
## * Parameters: list()
## * Properties: -
## * Predict type: crank
## * Return type: Score</code></pre>
<div class="sourceCode" id="cb732"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learners</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="va">measure</span><span class="op">)</span></code></pre></div>
<pre><code>##    nr      resample_result task_id  learner_id resampling_id iters
## 1:  1 &lt;ResampleResult[22]&gt;    rats  surv.coxph            cv     3
## 2:  2 &lt;ResampleResult[22]&gt;    rats surv.kaplan            cv     3
## 3:  3 &lt;ResampleResult[22]&gt;    rats surv.ranger            cv     3
##    surv.harrell_c
## 1:         0.7671
## 2:         0.5000
## 3:         0.7737</code></pre>
<div class="sourceCode" id="cb734"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">bmr</span>, measure <span class="op">=</span> <span class="va">measure</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-special-survival_files/figure-html/07-special-survival-004-1.svg" width="672" style="display: block; margin: auto;"></div>
<p>The experiment indicates that both the Cox PH and the random forest have better discrimination than the Kaplan-Meier baseline estimator, but that the machine learning random forest is not consistently better than the interpretable Cox PH.</p>

</div>
</div>
<div id="density" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> Density Estimation<a class="anchor" aria-label="anchor" href="#density"><i class="fas fa-link"></i></a>
</h2>
<p>Density estimation is the learning task to find the unknown distribution from which an i.i.d. data set is generated.
We interpret this broadly, with this distribution not necessarily being continuous (so may possess a mass not density).
The conditional case, where a distribution is predicted conditional on covariates, is known as ‘probabilistic supervised regression’, and will be implemented in <a href="https://mlr3proba.mlr-org.com">mlr3proba</a> in the near-future.
Unconditional density estimation is viewed as an unsupervised task.
For a good overview to density estimation see <em>Density estimation for statistics and data analysis</em> <span class="citation">(<a href="references.html#ref-Silverman1986" role="doc-biblioref">Silverman 1986</a>)</span>.</p>
<p>The package <a href="https://mlr3proba.mlr-org.com">mlr3proba</a> extends <a href="https://mlr3.mlr-org.com">mlr3</a> with the following objects for density estimation:</p>
<ul>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/TaskDens.html"><code>TaskDens</code></a> to define density tasks</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/LearnerDens.html"><code>LearnerDens</code></a> as base class for density estimators</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/PredictionDens.html"><code>PredictionDens</code></a> as specialized class for <a href="https://mlr3.mlr-org.com/reference/Prediction.html"><code>Prediction</code></a> objects</li>
<li>
<a href="https://mlr3proba.mlr-org.com/reference/MeasureDens.html"><code>MeasureDens</code></a> as specialized class for performance measures</li>
</ul>
<p>In this example we demonstrate the basic functionality of the package on the <a href="https://www.rdocumentation.org/packages/datasets/topics/faithful"><code>faithful</code></a> data from the datasets package.
This task ships as pre-defined <a href="https://mlr3proba.mlr-org.com/reference/TaskDens.html"><code>TaskDens</code></a> with <a href="https://mlr3proba.mlr-org.com">mlr3proba</a>.</p>
<div class="sourceCode" id="cb735"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3.mlr-org.com">"mlr3"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3proba.mlr-org.com">"mlr3proba"</a></span><span class="op">)</span>

<span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"precip"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">task</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;TaskDens:precip&gt; (70 x 1)
## * Target: -
## * Properties: -
## * Features (1):
##   - dbl (1): precip</code></pre>
<div class="sourceCode" id="cb737"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># histogram and density plot</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3viz.mlr-org.com">"mlr3viz"</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">task</span>, type <span class="op">=</span> <span class="st">"overlay"</span><span class="op">)</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<div class="inline-figure"><img src="08-special-density_files/figure-html/07-special-density-001-1.svg" width="672" style="display: block; margin: auto;"></div>
<p>Unconditional density estimation is an unsupervised method.
Hence, <code>TaskDens</code> is an unsupervised task which inherits directly from <code>Task</code> unlike <code>TaskClassif</code> and <code>TaskRegr</code>.
However, <code>TaskDens</code> still has a <code>target</code> argument and a <code>$truth</code> field defined by:</p>
<ul>
<li>
<code>target</code> - the name of the variable in the data for which to estimate density</li>
<li>
<code>$truth</code> - the values of the <code>target</code> column (which is <em>not</em> the true density, which is always unknown)</li>
</ul>
<div id="train-and-predict-1" class="section level3" number="8.2.1">
<h3>
<span class="header-section-number">8.2.1</span> Train and Predict<a class="anchor" aria-label="anchor" href="#train-and-predict-1"><i class="fas fa-link"></i></a>
</h3>
<p>Density learners have <code>train</code> and <code>predict</code> methods, though being unsupervised, ‘prediction’ is actually ‘estimation’.
In training, a <a href="https://cran.r-project.org/package=distr6">distr6</a> object is created,
<a href="https://alan-turing-institute.github.io/distr6/">see here</a> for full tutorials on how to access the probability density function, <code>pdf</code>, cumulative distribution function, <code>cdf</code>, and other important fields and methods.
The predict method is simply a wrapper around <code>self$model$pdf</code> and if available <code>self$model$cdf</code>, i.e. evaluates the pdf/cdf at given points.
Note that in prediction the points to evaluate the pdf and cdf are determined by the <code>target</code> column in the <code>TaskDens</code> object used for testing.</p>
<div class="sourceCode" id="cb739"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create task and learner</span>

<span class="va">task_faithful</span> <span class="op">=</span> <span class="va"><a href="https://mlr3proba.mlr-org.com/reference/TaskDens.html">TaskDens</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"eruptions"</span>, backend <span class="op">=</span> <span class="fu">datasets</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/datasets/faithful.html">faithful</a></span><span class="op">$</span><span class="va">eruptions</span><span class="op">)</span>
<span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"dens.hist"</span><span class="op">)</span>

<span class="co"># train/test split</span>
<span class="va">train_set</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">task_faithful</span><span class="op">$</span><span class="va">nrow</span>, <span class="fl">0.8</span> <span class="op">*</span> <span class="va">task_faithful</span><span class="op">$</span><span class="va">nrow</span><span class="op">)</span>
<span class="va">test_set</span> <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">task_faithful</span><span class="op">$</span><span class="va">nrow</span><span class="op">)</span>, <span class="va">train_set</span><span class="op">)</span>

<span class="co"># fitting KDE and model inspection</span>
<span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task_faithful</span>, row_ids <span class="op">=</span> <span class="va">train_set</span><span class="op">)</span>
<span class="va">learner</span><span class="op">$</span><span class="va">model</span></code></pre></div>
<pre><code>## $distr
## Histogram() 
## 
## $hist
## $breaks
## [1] 1.5 2.0 2.5 3.0 3.5 4.0 4.5 5.0 5.5
## 
## $counts
## [1] 39 34  4  6 23 58 49  4
## 
## $density
## [1] 0.35945 0.31336 0.03687 0.05530 0.21198 0.53456 0.45161 0.03687
## 
## $mids
## [1] 1.75 2.25 2.75 3.25 3.75 4.25 4.75 5.25
## 
## $xname
## [1] "dat"
## 
## $equidist
## [1] TRUE
## 
## attr(,"class")
## [1] "histogram"
## 
## attr(,"class")
## [1] "dens.hist"</code></pre>
<div class="sourceCode" id="cb741"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">learner</span><span class="op">$</span><span class="va">model</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "dens.hist"</code></pre>
<div class="sourceCode" id="cb743"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># make predictions for new data</span>
<span class="va">prediction</span> <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task_faithful</span>, row_ids <span class="op">=</span> <span class="va">test_set</span><span class="op">)</span></code></pre></div>
<p>Every <code>PredictionDens</code> object can estimate:</p>
<ul>
<li>
<code>pdf</code> - probability density function</li>
</ul>
<p>Some learners can estimate:</p>
<ul>
<li>
<code>cdf</code> - cumulative distribution function</li>
</ul>
</div>
<div id="benchmark-experiment-1" class="section level3" number="8.2.2">
<h3>
<span class="header-section-number">8.2.2</span> Benchmark Experiment<a class="anchor" aria-label="anchor" href="#benchmark-experiment-1"><i class="fas fa-link"></i></a>
</h3>
<p>Finally, we conduct a small benchmark study on the <a href="https://mlr3proba.mlr-org.com/reference/mlr_tasks_precip.html"><code>precip</code></a> task using some of the integrated survival learners:</p>
<div class="sourceCode" id="cb744"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># some integrated learners</span>
<span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrns</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dens.hist"</span>, <span class="st">"dens.kde"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">learners</span><span class="op">)</span></code></pre></div>
<pre><code>## [[1]]
## &lt;LearnerDensHistogram:dens.hist&gt;
## * Model: -
## * Parameters: list()
## * Packages: mlr3, distr6
## * Predict Type: pdf
## * Feature types: integer, numeric
## * Properties: -
## 
## [[2]]
## &lt;LearnerDensKDE:dens.kde&gt;
## * Model: -
## * Parameters: kernel=Epan, bandwidth=silver
## * Packages: mlr3, distr6
## * Predict Type: pdf
## * Feature types: integer, numeric
## * Properties: missings</code></pre>
<div class="sourceCode" id="cb746"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Logloss for probabilistic predictions</span>
<span class="va">measure</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"dens.logloss"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">measure</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;MeasureDensLogloss:dens.logloss&gt;
## * Packages: mlr3
## * Range: [0, Inf]
## * Minimize: TRUE
## * Average: macro
## * Parameters: list()
## * Properties: -
## * Predict type: pdf</code></pre>
<div class="sourceCode" id="cb748"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learners</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="va">measure</span><span class="op">)</span></code></pre></div>
<pre><code>##    nr      resample_result task_id learner_id resampling_id iters dens.logloss
## 1:  1 &lt;ResampleResult[22]&gt;  precip  dens.hist            cv     3        4.396
## 2:  2 &lt;ResampleResult[22]&gt;  precip   dens.kde            cv     3        4.818</code></pre>
<div class="sourceCode" id="cb750"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">bmr</span>, measure <span class="op">=</span> <span class="va">measure</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-special-density_files/figure-html/07-special-density-003-1.svg" width="672" style="display: block; margin: auto;"></div>
<p>The results of this experiment show that the sophisticated Penalized Density Estimator does not outperform the baseline Histogram, but that the Kernel Density Estimator has at least consistently <code>better</code> (i.e. lower logloss) results.</p>

</div>
</div>
<div id="spatiotemporal" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> Spatiotemporal Analysis<a class="anchor" aria-label="anchor" href="#spatiotemporal"><i class="fas fa-link"></i></a>
</h2>
<p>Data observations may entail reference information about spatial or temporal characteristics.
Spatial information is stored as coordinates, usually named “x” and “y” or “lat”/“lon”.
Treating spatiotemporal data using non-spatial data methods can lead to over-optimistic performance estimates.
Hence, methods specifically designed to account for the special nature of spatiotemporal data are needed.</p>
<p>In the <a href="https://cran.r-project.org/package=mlr3">mlr3</a> framework, the following packages relate to this field:</p>
<ul>
<li>
<a href="https://github.com/mlr-org/mlr3spatiotemporal">mlr3spatiotemporal</a> (biased-reduced performance estimation)</li>
<li>
<a href="https://github.com/mlr-org/mlr3forecasting">mlr3forecasting</a> (time-series support)</li>
<li>
<a href="https://github.com/mlr-org/mlr3spatial">mlr3spatial</a> (spatial prediction support)</li>
</ul>
<p>The following (sub-)sections introduce the potential pitfalls of spatiotemporal data in machine learning and how to account for it.
Note that not all functionality will be covered, and that some of the used packages are still in early lifecycles.
If you want to contribute to one of the packages mentioned above, please contact <a href="https://github.com/pat-s">Patrick Schratz</a>.</p>
<div id="creating-a-spatial-task" class="section level3" number="8.3.1">
<h3>
<span class="header-section-number">8.3.1</span> Creating a spatial Task<a class="anchor" aria-label="anchor" href="#creating-a-spatial-task"><i class="fas fa-link"></i></a>
</h3>
<p>To make use of spatial resampling methods, a {mlr3} task that is aware of its spatial characteristic needs to be created.
Two child classes exist in {mlr3spatiotempcv} for this purpose:</p>
<ul>
<li><code>TaskClassifST</code></li>
<li><code>TaskRegrST</code></li>
</ul>
<p>To create one of these, one can either pass a <code>sf</code> object as the “backend” directly:</p>
<div class="sourceCode" id="cb751"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create 'sf' object</span>
<span class="va">data_sf</span> <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">ecuador</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">32717</span><span class="op">)</span>
<span class="co"># create mlr3 task</span>
<span class="va">task</span> <span class="op">=</span> <span class="va">TaskClassifST</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"ecuador_sf"</span>,
  backend <span class="op">=</span> <span class="va">data_sf</span>, target <span class="op">=</span> <span class="st">"slides"</span>, positive <span class="op">=</span> <span class="st">"TRUE"</span>
<span class="op">)</span></code></pre></div>
<p>or use a plain <code>data.frame</code>.
In this case, the constructor of <code>TaskClassifST</code> needs a few more arguments:</p>
<div class="sourceCode" id="cb752"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">=</span> <span class="fu">mlr3</span><span class="fu">::</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_data_backend.html">as_data_backend</a></span><span class="op">(</span><span class="va">ecuador</span><span class="op">)</span>
<span class="va">task</span> <span class="op">=</span> <span class="va">TaskClassifST</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"ecuador"</span>,
  backend <span class="op">=</span> <span class="va">data</span>, target <span class="op">=</span> <span class="st">"slides"</span>,
  positive <span class="op">=</span> <span class="st">"TRUE"</span>, extra_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>coordinate_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>,
  crs <span class="op">=</span> <span class="fl">32717</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Now this Task can be used as a normal {mlr3} task in any kind of modeling scenario.</p>
</div>
<div id="spatiotemporal-intro" class="section level3" number="8.3.2">
<h3>
<span class="header-section-number">8.3.2</span> Autocorrelation<a class="anchor" aria-label="anchor" href="#spatiotemporal-intro"><i class="fas fa-link"></i></a>
</h3>
<p>Data which includes spatial or temporal information requires special treatment in machine learning (similar to <a href="special-tasks.html#survival">survival</a>, <a href="special-tasks.html#ordinal">ordinal</a> and other task types listed in the <a href="special-tasks.html#special-tasks">special tasks</a> chapter).
In contrast to non-spatial/non-temporal data, observations inherit a natural grouping, either in space or time or in both space and time <span class="citation">(<a href="references.html#ref-legendre1993" role="doc-biblioref">Legendre 1993</a>)</span>.
This grouping causes observations to be autocorrelated, either in space (spatial autocorrelation (SAC)), time (temporal autocorrelation (TAC)) or both space and time (spatiotemporal autocorrelation (STAC)).
For simplicity, the acronym STAC is used as a generic term in the following chapter for all the different characteristics introduced above.</p>
<p><em>What effects does STAC have in statistical/machine learning?</em></p>
<p>The overarching problem is that STAC violates the assumption that the observations in the train and test datasets are independent <span class="citation">(<a href="references.html#ref-hastie2001" role="doc-biblioref">Hastie, Friedman, and Tibshirani 2001</a>)</span>.
If this assumption is violated, the reliability of the resulting performance estimates, for example retrieved via cross-validation, is decreased.
The magnitude of this decrease is linked to the magnitude of STAC in the dataset, which cannot be determined easily.</p>
<p>One approach to account for the existence of STAC is to use dedicated resampling methods.
<a href="https://github.com/mlr-org/mlr3spatiotemporal">mlr3spatiotemporal</a> provides access to the most frequently used spatiotemporal resampling methods.
The following example showcases how a spatial dataset can be used to retrieve a bias-reduced performance estimate of a learner.</p>
<p>The following examples use the <a href="https://mlr3spatiotempcv.mlr-org.com/reference/mlr_tasks_ecuador.html">ecuador</a> dataset created by <a href="https://scholar.google.com/citations?user=Slq94Y4AAAAJ&amp;hl=de&amp;authuser=1&amp;oi=ao">Jannes Muenchow</a>.
It contains information on the occurrence of landslides (binary) in the Andes of Southern Ecuador.
The landslides were mapped from aerial photos taken in 2000.
The dataset is well suited to serve as an example because it it relatively small and of course due to the spatial nature of the observations.
Please refer to <span class="citation">Muenchow, Brenning, and Richter (<a href="references.html#ref-muenchow2012" role="doc-biblioref">2012</a>)</span> for a detailed description of the dataset.</p>
<p>To account for the spatial autocorrelation probably present in the landslide data, we will make use one of the most used spatial partitioning methods, a cluster-based k-means grouping <span class="citation">(<a href="references.html#ref-brenning2012" role="doc-biblioref">Brenning 2012</a>)</span>, (<code>"spcv_coords"</code> in <a href="https://github.com/mlr-org/mlr3spatiotemporal">mlr3spatiotemporal</a>).
This method performs a clustering in 2D space which contrasts with the commonly used random partitioning for non-spatial data.
The grouping has the effect that train and test data are more separated in space as they would be by conducting a random partitioning, thereby reducing the effect of STAC.</p>
<p>By contrast, when using the classical random partitioning approach with spatial data, train and test observations would be located side-by-side across the full study area (a visual example is provided further below).
This leads to a high similarity between train and test sets, resulting in “better” but biased performance estimates in every fold of a CV compared to the spatial CV approach.
However, these low error rates are mainly caused due to the STAC in the observations and the lack of appropriate partitioning methods and not by the power of the fitted model.</p>
</div>
<div id="sp-vs-nsp-cv" class="section level3" number="8.3.3">
<h3>
<span class="header-section-number">8.3.3</span> Spatial CV vs. Non-Spatial CV<a class="anchor" aria-label="anchor" href="#sp-vs-nsp-cv"><i class="fas fa-link"></i></a>
</h3>
<p>In the following a spatial and a non-spatial CV will be conducted to showcase the mentioned performance differences.</p>
<p>The performance of a simple classification tree (<code>"classif.rpart"</code>) is evaluated on a random partitioning (<code>"repeated_cv"</code>) with four folds and two repetitions.
The chosen evaluation measure is “classification error” (<code>"classif.ce"</code>).
The only difference in the spatial setting is that <code>"repeated_spcv_coords"</code> is chosen instead of <code>"repeated_cv"</code>.</p>
<div id="nsp-cv" class="section level4" number="8.3.3.1">
<h4>
<span class="header-section-number">8.3.3.1</span> Non-Spatial CV<a class="anchor" aria-label="anchor" href="#nsp-cv"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb753"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3.mlr-org.com">"mlr3"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3spatiotempcv.mlr-org.com/">"mlr3spatiotempcv"</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span>

<span class="co"># be less verbose</span>
<span class="fu">lgr</span><span class="fu">::</span><span class="fu"><a href="https://s-fleck.github.io/lgr/reference/get_logger.html">get_logger</a></span><span class="op">(</span><span class="st">"bbotk"</span><span class="op">)</span><span class="op">$</span><span class="fu">set_threshold</span><span class="op">(</span><span class="st">"warn"</span><span class="op">)</span>
<span class="fu">lgr</span><span class="fu">::</span><span class="fu"><a href="https://s-fleck.github.io/lgr/reference/get_logger.html">get_logger</a></span><span class="op">(</span><span class="st">"mlr3"</span><span class="op">)</span><span class="op">$</span><span class="fu">set_threshold</span><span class="op">(</span><span class="st">"warn"</span><span class="op">)</span>

<span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"ecuador"</span><span class="op">)</span>

<span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span>, maxdepth <span class="op">=</span> <span class="fl">3</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span>
<span class="va">resampling_nsp</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"repeated_cv"</span>, folds <span class="op">=</span> <span class="fl">4</span>, repeats <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">rr_nsp</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/resample.html">resample</a></span><span class="op">(</span>
  task <span class="op">=</span> <span class="va">task</span>, learner <span class="op">=</span> <span class="va">learner</span>,
  resampling <span class="op">=</span> <span class="va">resampling_nsp</span><span class="op">)</span>

<span class="va">rr_nsp</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span>measures <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.ce"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## classif.ce 
##     0.3389</code></pre>
</div>
<div id="sp-cv" class="section level4" number="8.3.3.2">
<h4>
<span class="header-section-number">8.3.3.2</span> Spatial CV<a class="anchor" aria-label="anchor" href="#sp-cv"><i class="fas fa-link"></i></a>
</h4>
<div class="sourceCode" id="cb755"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"ecuador"</span><span class="op">)</span>

<span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span>, maxdepth <span class="op">=</span> <span class="fl">3</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span>
<span class="va">resampling_sp</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"repeated_spcv_coords"</span>, folds <span class="op">=</span> <span class="fl">4</span>, repeats <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">rr_sp</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/resample.html">resample</a></span><span class="op">(</span>
  task <span class="op">=</span> <span class="va">task</span>, learner <span class="op">=</span> <span class="va">learner</span>,
  resampling <span class="op">=</span> <span class="va">resampling_sp</span><span class="op">)</span>

<span class="va">rr_sp</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span>measures <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.ce"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## classif.ce 
##     0.4125</code></pre>
<p>Here, the classification tree learner is around 0.05 percentage points worse when using Spatial Cross-Validation (SpCV) compared to Non-Spatial Cross-Validation (NSpCV).
The magnitude of this difference is variable as it depends on the dataset, the magnitude of STAC and the learner itself.
For algorithms with a higher tendency of overfitting to the training set, the difference between the two methods will be larger.</p>
</div>
</div>
<div id="vis-spt-partitions" class="section level3" number="8.3.4">
<h3>
<span class="header-section-number">8.3.4</span> Visualization of Spatiotemporal Partitions<a class="anchor" aria-label="anchor" href="#vis-spt-partitions"><i class="fas fa-link"></i></a>
</h3>
<p>Every partitioning method in <a href="https://github.com/mlr-org/mlr3spatiotemporal">mlr3spatiotemporal</a> comes with a generic <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> method to visualize the created groups.
In a 2D space this happens via <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a> while for spatiotemporal methods 3D visualizations via <a href="https://cran.r-project.org/package=plotly">plotly</a> are created.</p>
<div class="sourceCode" id="cb757"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mlr3spatiotempcv.mlr-org.com/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">resampling_sp</span>, <span class="va">task</span>, fold_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">*</span>
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3.97</span>, <span class="op">-</span><span class="fl">4</span>, <span class="op">-</span><span class="fl">0.01</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span>
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">79.06</span>, <span class="op">-</span><span class="fl">79.08</span>, <span class="op">-</span><span class="fl">0.01</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-special-spatiotemp_files/figure-html/07-special-spatiotemp-003-1.svg" width="672" style="display: block; margin: auto;"></div>
<p>Note that setting the correct CRS for the given data is important which is done during task creation
Spatial offsets of up to multiple meters may occur if the wrong CRS is supplied initially.</p>
<p>This example used an already created task via the sugar function <code><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk()</a></code>.
In practice however, one needs to create a spatiotemporal task via <code><a href="https://mlr3spatiotempcv.mlr-org.com/reference/TaskClassifST.html">TaskClassifST()</a></code>/<code><a href="https://mlr3spatiotempcv.mlr-org.com/reference/TaskRegrST.html">TaskRegrST()</a></code> and set the <code>crs</code> argument.</p>
<p>The spatial grouping of the k-means based approach above contrasts visually ver well compared to the NSpCV (random) partitioning:</p>
<div class="sourceCode" id="cb758"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mlr3spatiotempcv.mlr-org.com/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">resampling_nsp</span>, <span class="va">task</span>, fold_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">*</span>
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3.97</span>, <span class="op">-</span><span class="fl">4</span>, <span class="op">-</span><span class="fl">0.01</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span>
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">79.06</span>, <span class="op">-</span><span class="fl">79.08</span>, <span class="op">-</span><span class="fl">0.01</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-special-spatiotemp_files/figure-html/07-special-spatiotemp-004-1.svg" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="vis-spatial-block" class="section level3" number="8.3.5">
<h3>
<span class="header-section-number">8.3.5</span> Spatial Block Visualization<a class="anchor" aria-label="anchor" href="#vis-spatial-block"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>spcv-block</code> method makes use of rectangular blocks to divide the study area into equally-sized parts.
These blocks can be visualized by their spatial location and fold ID to get a better understanding how these influenced the final partitions.</p>
<div class="sourceCode" id="cb759"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"ecuador"</span><span class="op">)</span>
<span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"spcv_block"</span>, range <span class="op">=</span> <span class="fl">1000L</span><span class="op">)</span>
<span class="va">resampling</span><span class="op">$</span><span class="fu">instantiate</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>

<span class="co">## Visualize train/test splits of multiple folds</span>
<span class="fu"><a href="https://mlr3spatiotempcv.mlr-org.com/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">resampling</span>, <span class="va">task</span>, size <span class="op">=</span> <span class="fl">0.7</span>,
  fold_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, show_blocks <span class="op">=</span> <span class="cn">TRUE</span>, show_labels <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span>
  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">79.085</span>, <span class="op">-</span><span class="fl">79.055</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-special-spatiotemp_files/figure-html/07-special-spatiotemp-005-1.svg" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="choose-spt-rsmp" class="section level3" number="8.3.6">
<h3>
<span class="header-section-number">8.3.6</span> Choosing a Resampling Method<a class="anchor" aria-label="anchor" href="#choose-spt-rsmp"><i class="fas fa-link"></i></a>
</h3>
<p>While the example used the <code>"spcv_coords"</code> method, this does not mean that this method is the best or only method suitable for this task.
Even though this method is quite popular, it was mainly chosen because of the clear visual grouping differences compared to random partitioning.</p>
<p>In fact, most often multiple spatial partitioning methods can be used for a dataset.
It is recommended (required) that users familiarize themselves with each implemented method and decide which method to choose based on the specific characteristics of the dataset.
For almost all methods implemented in <a href="https://github.com/mlr-org/mlr3spatiotemporal">mlr3spatiotemporal</a>, there is a scientific publication describing the strengths and weaknesses of the respective approach (either linked in the help file of <a href="https://github.com/mlr-org/mlr3spatiotemporal">mlr3spatiotemporal</a> or its respective dependency packages).</p>
<p>In the example above, a cross-validation without hyperparameter tuning was shown.
If a nested CV is desired, it is recommended to use the same spatial partitioning method for the inner loop (= tuning level).
See <span class="citation">Schratz et al. (<a href="references.html#ref-schratz2019" role="doc-biblioref">2019</a>)</span> for more details and chapter 11 of <a href="https://geocompr.robinlovelace.net/spatial-cv.html">Geocomputation with R</a> <span class="citation">(<a href="references.html#ref-lovelace2019" role="doc-biblioref">Lovelace, Nowosad, and Muenchow 2019</a>)</span><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;The chapter will soon be rewritten using the &lt;strong&gt;mlr3&lt;/strong&gt; and &lt;strong&gt;mlr3spatiotempcv&lt;/strong&gt; packages.&lt;/p&gt;"><sup>3</sup></a>.</p>
<p>A list of all implemented methods in <a href="https://github.com/mlr-org/mlr3spatiotemporal">mlr3spatiotemporal</a> can be found in the <a href="https://mlr3spatiotempcv.mlr-org.com/articles/mlr3spatiotempcv.html#resampling-methods">Getting Started</a> vignette of the package.</p>
<p>If you want to learn even more about the field of spatial partitioning, STAC and the problems associated with it, the work of <a href="https://scholar.google.com/citations?user=9YibxW0AAAAJ&amp;hl=en">Prof. Hanna Meyer</a> is very much recommended for further reference.</p>
</div>
<div id="spatial-prediction" class="section level3" number="8.3.7">
<h3>
<span class="header-section-number">8.3.7</span> Spatial Prediction<a class="anchor" aria-label="anchor" href="#spatial-prediction"><i class="fas fa-link"></i></a>
</h3>
<p>Experimental support for spatial prediction with <a href="https://cran.r-project.org/package=terra">terra</a>, <a href="https://cran.r-project.org/package=raster">raster</a>, <a href="https://cran.r-project.org/package=stars">stars</a> and <a href="https://cran.r-project.org/package=sf">sf</a> objects is available in <a href="https://github.com/mlr-org/mlr3spatial">mlr3spatial</a>.</p>
<p>Until the package is released on CRAN, please see the package vignettes for usage examples.</p>

</div>
</div>
<div id="ordinal" class="section level2" number="8.4">
<h2>
<span class="header-section-number">8.4</span> Ordinal Analysis<a class="anchor" aria-label="anchor" href="#ordinal"><i class="fas fa-link"></i></a>
</h2>
<p>This is work in progress.
See <a href="https://github.com/mlr-org/mlr3ordinal">mlr3ordinal</a> for the current state of the implementation.</p>

</div>
<div id="functional" class="section level2" number="8.5">
<h2>
<span class="header-section-number">8.5</span> Functional Analysis<a class="anchor" aria-label="anchor" href="#functional"><i class="fas fa-link"></i></a>
</h2>
<p>Functional data is data containing an ordering on the dimensions.
This implies that functional data consists of curves varying over a continuum, such as time, frequency, or wavelength.</p>
<div id="how-to-model-functional-data" class="section level3" number="8.5.1">
<h3>
<span class="header-section-number">8.5.1</span> How to model functional data?<a class="anchor" aria-label="anchor" href="#how-to-model-functional-data"><i class="fas fa-link"></i></a>
</h3>
<p>There are two ways to model functional data:</p>
<ul>
<li>Modification of the learner, so that the learner is suitable for the functional data</li>
<li>Modification of the task, so that the task matches the standard- or classification-learner</li>
</ul>
<p>The development has not started yet, we are looking for contributors.
Open an issue in <a href="https://github.com/mlr-org/mlr3fda">mlr3fda</a> if you are interested!</p>

</div>
</div>
<div id="multilabel" class="section level2" number="8.6">
<h2>
<span class="header-section-number">8.6</span> Multilabel Classification<a class="anchor" aria-label="anchor" href="#multilabel"><i class="fas fa-link"></i></a>
</h2>
<p>Multilabel classification deals with objects that can belong to more than one category at the same time.</p>
<p>The development has not started yet, we are looking for contributes.
Open an issue in <a href="https://github.com/mlr-org/mlr3multioutput">mlr3multioutput</a> if you are interested!</p>

</div>
<div id="cost-sens" class="section level2" number="8.7">
<h2>
<span class="header-section-number">8.7</span> Cost-Sensitive Classification<a class="anchor" aria-label="anchor" href="#cost-sens"><i class="fas fa-link"></i></a>
</h2>
<p>In regular classification the aim is to minimize the misclassification rate and thus all types of misclassification errors are deemed equally severe.
A more general setting is cost-sensitive classification.
Cost sensitive classification does not assume that the costs caused by different kinds of errors are equal.
The objective of cost sensitive classification is to minimize the expected costs.</p>
<p>Imagine you are an analyst for a big credit institution.
Let’s also assume that a correct decision of the bank would result in 35% of the profit at the end of a specific period.
A correct decision means that the bank predicts that a customer will pay their bills (hence would obtain a loan), and the customer indeed has good credit.
On the other hand, a wrong decision means that the bank predicts that the customer’s credit is in good standing, but the opposite is true.
This would result in a loss of 100% of the given loan.</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="center"></th>
<th align="center">Good Customer (truth)</th>
<th align="center">Bad Customer (truth)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Good Customer (predicted)</td>
<td align="center">+ 0.35</td>
<td align="center">- 1.0</td>
</tr>
<tr class="even">
<td align="center">Bad Customer (predicted)</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
</tbody>
</table></div>
<p>Expressed as costs (instead of profit), we can write down the cost-matrix as follows:</p>
<div class="sourceCode" id="cb760"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">costs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.35</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">costs</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"good"</span>, <span class="st">"bad"</span><span class="op">)</span>, truth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"good"</span>, <span class="st">"bad"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">costs</span><span class="op">)</span></code></pre></div>
<pre><code>##         truth
## response  good bad
##     good -0.35   1
##     bad   0.00   0</code></pre>
<p>An exemplary data set for such a problem is the <a href="https://mlr3.mlr-org.com/reference/mlr_tasks_german_credit.html"><code>German Credit</code></a> task:</p>
<div class="sourceCode" id="cb762"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3.mlr-org.com">"mlr3"</a></span><span class="op">)</span>
<span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"german_credit"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="fu">truth</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## good  bad 
##  700  300</code></pre>
<p>The data has 70% customers who are able to pay back their credit, and 30% bad customers who default on the debt.
A manager, who doesn’t have any model, could decide to give either everybody a credit or to give nobody a credit.
The resulting costs for the German credit data are:</p>
<div class="sourceCode" id="cb764"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># nobody:</span>
<span class="op">(</span><span class="fl">700</span> <span class="op">*</span> <span class="va">costs</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">costs</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1000</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb766"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># everybody</span>
<span class="op">(</span><span class="fl">700</span> <span class="op">*</span> <span class="va">costs</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">300</span> <span class="op">*</span> <span class="va">costs</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1000</span></code></pre></div>
<pre><code>## [1] 0.055</code></pre>
<p>If the average loan is $20,000, the credit institute would lose more than one million dollar if it would grant everybody a credit:</p>
<div class="sourceCode" id="cb768"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># average profit * average loan * number of customers</span>
<span class="fl">0.055</span> <span class="op">*</span> <span class="fl">20000</span> <span class="op">*</span> <span class="fl">1000</span></code></pre></div>
<pre><code>## [1] 1100000</code></pre>
<p>Our goal is to find a model which minimizes the costs (and thereby maximizes the expected profit).</p>
<div id="a-first-model" class="section level3" number="8.7.1">
<h3>
<span class="header-section-number">8.7.1</span> A First Model<a class="anchor" aria-label="anchor" href="#a-first-model"><i class="fas fa-link"></i></a>
</h3>
<p>For our first model, we choose an ordinary logistic regression (implemented in the add-on package <a href="https://mlr3learners.mlr-org.com">mlr3learners</a>).
We first create a classification task, then resample the model using a 10-fold cross validation and extract the resulting confusion matrix:</p>
<div class="sourceCode" id="cb770"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3learners.mlr-org.com">"mlr3learners"</a></span><span class="op">)</span>
<span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.log_reg"</span><span class="op">)</span>
<span class="va">rr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/resample.html">resample</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span><span class="op">)</span><span class="op">)</span>

<span class="va">confusion</span> <span class="op">=</span> <span class="va">rr</span><span class="op">$</span><span class="fu">prediction</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">confusion</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">confusion</span><span class="op">)</span></code></pre></div>
<pre><code>##         truth
## response good bad
##     good  602 153
##     bad    98 147</code></pre>
<p>To calculate the average costs like above, we can simply multiply the elements of the confusion matrix with the elements of the previously introduced cost matrix, and sum the values of the resulting matrix:</p>
<div class="sourceCode" id="cb772"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">avg_costs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">confusion</span> <span class="op">*</span> <span class="va">costs</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1000</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">avg_costs</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] -0.0577</code></pre>
<p>With an average loan of $20,000, the logistic regression yields the following costs:</p>
<div class="sourceCode" id="cb774"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">avg_costs</span> <span class="op">*</span> <span class="fl">20000</span> <span class="op">*</span> <span class="fl">1000</span></code></pre></div>
<pre><code>## [1] -1154000</code></pre>
<p>Instead of losing over $1,000,000, the credit institute now can expect a profit of more than $1,000,000.</p>
</div>
<div id="cost-sensitive-measure" class="section level3" number="8.7.2">
<h3>
<span class="header-section-number">8.7.2</span> Cost-sensitive Measure<a class="anchor" aria-label="anchor" href="#cost-sensitive-measure"><i class="fas fa-link"></i></a>
</h3>
<p>Our natural next step would be to further improve the modeling step in order to maximize the profit.
For this purpose we first create a cost-sensitive classification measure which calculates the costs based on our cost matrix.
This allows us to conveniently quantify and compare modeling decisions.
Fortunately, there already is a predefined measure <a href="https://mlr3.mlr-org.com/reference/Measure.html"><code>Measure</code></a> for this purpose: <a href="https://mlr3.mlr-org.com/reference/mlr_measures_classif.costs.html"><code>MeasureClassifCosts</code></a>:</p>
<div class="sourceCode" id="cb776"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cost_measure</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.costs"</span>, costs <span class="op">=</span> <span class="va">costs</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">cost_measure</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;MeasureClassifCosts:classif.costs&gt;
## * Packages: mlr3
## * Range: [-Inf, Inf]
## * Minimize: TRUE
## * Average: macro
## * Parameters: normalize=TRUE
## * Properties: requires_task
## * Predict type: response</code></pre>
<p>If we now call <a href="https://mlr3.mlr-org.com/reference/resample.html"><code>resample()</code></a> or <a href="https://mlr3.mlr-org.com/reference/benchmark.html"><code>benchmark()</code></a>, the cost-sensitive measures will be evaluated.
We compare the logistic regression to a simple featureless learner and to a random forest from package <a href="https://cran.r-project.org/package=ranger">ranger</a> :</p>
<div class="sourceCode" id="cb778"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">learners</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.log_reg"</span><span class="op">)</span>,
  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.featureless"</span><span class="op">)</span>,
  <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.ranger"</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">cv3</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learners</span>, <span class="va">cv3</span><span class="op">)</span><span class="op">)</span>
<span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="va">cost_measure</span><span class="op">)</span></code></pre></div>
<pre><code>##    nr      resample_result       task_id          learner_id resampling_id
## 1:  1 &lt;ResampleResult[22]&gt; german_credit     classif.log_reg            cv
## 2:  2 &lt;ResampleResult[22]&gt; german_credit classif.featureless            cv
## 3:  3 &lt;ResampleResult[22]&gt; german_credit      classif.ranger            cv
##    iters classif.costs
## 1:     3      -0.06338
## 2:     3       0.05495
## 3:     3      -0.05725</code></pre>
<p>As expected, the featureless learner is performing comparably bad.
The logistic regression and the random forest work equally well.</p>
</div>
<div id="thresholding-1" class="section level3" number="8.7.3">
<h3>
<span class="header-section-number">8.7.3</span> Thresholding<a class="anchor" aria-label="anchor" href="#thresholding-1"><i class="fas fa-link"></i></a>
</h3>
<p>Although we now correctly evaluate the models in a cost-sensitive fashion, the models themselves are unaware of the classification costs.
They assume the same costs for both wrong classification decisions (false positives and false negatives).
Some learners natively support cost-sensitive classification (e.g., XXX).
However, we will concentrate on a more generic approach which works for all models which can predict probabilities for class labels: thresholding.</p>
<p>Most learners can calculate the probability <span class="math inline">\(p\)</span> for the positive class.
If <span class="math inline">\(p\)</span> exceeds the threshold <span class="math inline">\(0.5\)</span>, they predict the positive class, and the negative class otherwise.</p>
<p>For our binary classification case of the credit data, the we primarily want to minimize the errors where the model predicts “good”, but truth is “bad” (i.e., the number of false positives) as this is the more expensive error.
If we now increase the threshold to values <span class="math inline">\(&gt; 0.5\)</span>, we reduce the number of false negatives.
Note that we increase the number of false positives simultaneously, or, in other words, we are trading false positives for false negatives.</p>
<div class="sourceCode" id="cb780"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fit models with probability prediction</span>
<span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.log_reg"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span>
<span class="va">rr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/resample.html">resample</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learner</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span><span class="op">)</span><span class="op">)</span>
<span class="va">p</span> <span class="op">=</span> <span class="va">rr</span><span class="op">$</span><span class="fu">prediction</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;PredictionClassif&gt; for 1000 observations:
##     row_ids truth response prob.good prob.bad
##          19   bad      bad    0.3879  0.61207
##          32  good      bad    0.4011  0.59885
##          43  good     good    0.6561  0.34385
## ---                                          
##         987  good      bad    0.1565  0.84351
##         991  good     good    0.9349  0.06505
##         997  good     good    0.5423  0.45774</code></pre>
<div class="sourceCode" id="cb782"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># helper function to try different threshold values interactively</span>
<span class="va">with_threshold</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">p</span>, <span class="va">th</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">p</span><span class="op">$</span><span class="fu">set_threshold</span><span class="op">(</span><span class="va">th</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>confusion <span class="op">=</span> <span class="va">p</span><span class="op">$</span><span class="va">confusion</span>, costs <span class="op">=</span> <span class="va">p</span><span class="op">$</span><span class="fu">score</span><span class="op">(</span>measures <span class="op">=</span> <span class="va">cost_measure</span>, task <span class="op">=</span> <span class="va">task</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">with_threshold</span><span class="op">(</span><span class="va">p</span>, <span class="fl">0.5</span><span class="op">)</span></code></pre></div>
<pre><code>## $confusion
##         truth
## response good bad
##     good  599 159
##     bad   101 141
## 
## $costs
## classif.costs 
##      -0.05065</code></pre>
<div class="sourceCode" id="cb784"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">with_threshold</span><span class="op">(</span><span class="va">p</span>, <span class="fl">0.75</span><span class="op">)</span></code></pre></div>
<pre><code>## $confusion
##         truth
## response good bad
##     good  471  80
##     bad   229 220
## 
## $costs
## classif.costs 
##      -0.08485</code></pre>
<div class="sourceCode" id="cb786"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">with_threshold</span><span class="op">(</span><span class="va">p</span>, <span class="fl">1.0</span><span class="op">)</span></code></pre></div>
<pre><code>## $confusion
##         truth
## response good bad
##     good    0   0
##     bad   700 300
## 
## $costs
## classif.costs 
##             0</code></pre>
<div class="sourceCode" id="cb788"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># TODO: include plot of threshold vs performance</span></code></pre></div>
<p>Instead of manually trying different threshold values, one uses use <a href="https://www.rdocumentation.org/packages/stats/topics/optimize"><code>optimize()</code></a> to find a good threshold value w.r.t. our performance measure:</p>
<div class="sourceCode" id="cb789"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># simple wrapper function which takes a threshold and returns the resulting model performance</span>
<span class="co"># this wrapper is passed to optimize() to find its minimum for thresholds in [0.5, 1]</span>
<span class="va">f</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">th</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">with_threshold</span><span class="op">(</span><span class="va">p</span>, <span class="va">th</span><span class="op">)</span><span class="op">$</span><span class="va">costs</span>
<span class="op">}</span>
<span class="va">best</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/optimize.html">optimize</a></span><span class="op">(</span><span class="va">f</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">best</span><span class="op">)</span></code></pre></div>
<pre><code>## $minimum
## [1] 0.7011
## 
## $objective
## classif.costs 
##       -0.0902</code></pre>
<div class="sourceCode" id="cb791"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># optimized confusion matrix:</span>
<span class="fu">with_threshold</span><span class="op">(</span><span class="va">p</span>, <span class="va">best</span><span class="op">$</span><span class="va">minimum</span><span class="op">)</span><span class="op">$</span><span class="va">confusion</span></code></pre></div>
<pre><code>##         truth
## response good bad
##     good  512  89
##     bad   188 211</code></pre>
<p>Note that the function <a href="https://www.rdocumentation.org/packages/stats/topics/optimize"><code>optimize()</code></a> is intended for unimodal functions and therefore may converge to a local optimum here.
See below for better alternatives to find good threshold values.</p>
</div>
<div id="threshold-tuning" class="section level3" number="8.7.4">
<h3>
<span class="header-section-number">8.7.4</span> Threshold Tuning<a class="anchor" aria-label="anchor" href="#threshold-tuning"><i class="fas fa-link"></i></a>
</h3>
<p>Before we start, we have load all required packages:</p>
<div class="sourceCode" id="cb793"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3.mlr-org.com">"mlr3"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3pipelines.mlr-org.com">"mlr3pipelines"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3tuning.mlr-org.com">"mlr3tuning"</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Loading required package: paradox</code></pre>
</div>
<div id="adjusting-thresholds-two-strategies" class="section level3" number="8.7.5">
<h3>
<span class="header-section-number">8.7.5</span> Adjusting thresholds: Two strategies<a class="anchor" aria-label="anchor" href="#adjusting-thresholds-two-strategies"><i class="fas fa-link"></i></a>
</h3>
<p>Currently <code>mlr3pipelines</code> offers two main strategies towards adjusting <code>classification thresholds</code>.
We can either expose the thresholds as a <code>hyperparameter</code> of the Learner by using <code>PipeOpThreshold</code>.
This allows us to tune the <code>thresholds</code> via an outside optimizer from <code>mlr3tuning</code>.</p>
<p>Alternatively, we can also use <code>PipeOpTuneThreshold</code> which automatically tunes the threshold after each learner is fit.</p>
<p>In this blog-post, we’ll go through both strategies.</p>
</div>
<div id="pipeopthreshold" class="section level3" number="8.7.6">
<h3>
<span class="header-section-number">8.7.6</span> PipeOpThreshold<a class="anchor" aria-label="anchor" href="#pipeopthreshold"><i class="fas fa-link"></i></a>
</h3>
<p><code>PipeOpThreshold</code> can be put directly after a <code>Learner</code>.</p>
<p>A simple example would be:</p>
<div class="sourceCode" id="cb795"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com//reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com//reference/po.html">po</a></span><span class="op">(</span><span class="st">"threshold"</span><span class="op">)</span>
<span class="va">l</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span></code></pre></div>
<p>Note, that <code>predict_type</code> = “prob” is required for <code>po("threshold")</code> to have any effect.</p>
<p>The <code>thresholds</code> are now exposed as a <code>hyperparameter</code> of the <code>GraphLearner</code> we created:</p>
<div class="sourceCode" id="cb796"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">l</span><span class="op">$</span><span class="va">param_set</span></code></pre></div>
<pre><code>## &lt;ParamSetCollection&gt;
##                               id    class lower upper nlevels        default
##  1:             classif.rpart.cp ParamDbl     0     1     Inf           0.01
##  2:     classif.rpart.keep_model ParamLgl    NA    NA       2          FALSE
##  3:     classif.rpart.maxcompete ParamInt     0   Inf     Inf              4
##  4:       classif.rpart.maxdepth ParamInt     1    30      30             30
##  5:   classif.rpart.maxsurrogate ParamInt     0   Inf     Inf              5
##  6:      classif.rpart.minbucket ParamInt     1   Inf     Inf &lt;NoDefault[3]&gt;
##  7:       classif.rpart.minsplit ParamInt     1   Inf     Inf             20
##  8: classif.rpart.surrogatestyle ParamInt     0     1       2              0
##  9:   classif.rpart.usesurrogate ParamInt     0     2       3              2
## 10:           classif.rpart.xval ParamInt     0   Inf     Inf             10
## 11:         threshold.thresholds ParamUty    NA    NA     Inf &lt;NoDefault[3]&gt;
##     value
##  1:      
##  2:      
##  3:      
##  4:      
##  5:      
##  6:      
##  7:      
##  8:      
##  9:      
## 10:     0
## 11:   0.5</code></pre>
<p>We can now tune those thresholds from the outside as follows:</p>
<p>Before <code>tuning</code>, we have to define which hyperparameters we want to tune over.
In this example, we only tune over the <code>thresholds</code> parameter of the <code>threshold</code> pipeop.
you can easily imagine, that we can also jointly tune over additional hyperparameters, i.e. rpart’s <code>cp</code> parameter.</p>
<p>As the <code>Task</code> we aim to optimize for is a binary task, we can simply specify the threshold param:</p>
<div class="sourceCode" id="cb798"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://paradox.mlr-org.com">"paradox"</a></span><span class="op">)</span>
<span class="va">ps</span> <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span>threshold.thresholds <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We now create a <code>AutoTuner</code>, which automatically tunes the supplied learner over the <code>ParamSet</code> we supplied above.</p>
<div class="sourceCode" id="cb799"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">at</span> <span class="op">=</span> <span class="va"><a href="https://mlr3tuning.mlr-org.com/reference/AutoTuner.html">AutoTuner</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learner <span class="op">=</span> <span class="va">l</span>,
  resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">3L</span><span class="op">)</span>,
  measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"classif.ce"</span><span class="op">)</span>,
  search_space <span class="op">=</span> <span class="va">ps</span>,
  terminator <span class="op">=</span> <span class="fu"><a href="https://bbotk.mlr-org.com/reference/trm.html">trm</a></span><span class="op">(</span><span class="st">"evals"</span>, n_evals <span class="op">=</span> <span class="fl">5L</span><span class="op">)</span>,
  tuner <span class="op">=</span> <span class="fu"><a href="https://mlr3tuning.mlr-org.com/reference/tnr.html">tnr</a></span><span class="op">(</span><span class="st">"random_search"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">at</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"german_credit"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## INFO  [09:48:46.856] [bbotk] Starting to optimize 1 parameter(s) with '&lt;OptimizerRandomSearch&gt;' and '&lt;TerminatorEvals&gt; [n_evals=5, k=0]' 
## INFO  [09:48:46.922] [bbotk] Evaluating 1 configuration(s) 
## INFO  [09:48:47.428] [bbotk] Result of batch 1: 
## INFO  [09:48:47.430] [bbotk]  threshold.thresholds classif.ce runtime_learners 
## INFO  [09:48:47.430] [bbotk]                0.5039      0.285            0.281 
## INFO  [09:48:47.430] [bbotk]                                 uhash 
## INFO  [09:48:47.430] [bbotk]  a6331079-f87e-4e41-90c2-d6b5c0976903 
## INFO  [09:48:47.434] [bbotk] Evaluating 1 configuration(s) 
## INFO  [09:48:47.847] [bbotk] Result of batch 2: 
## INFO  [09:48:47.850] [bbotk]  threshold.thresholds classif.ce runtime_learners 
## INFO  [09:48:47.850] [bbotk]                0.2148      0.281            0.248 
## INFO  [09:48:47.850] [bbotk]                                 uhash 
## INFO  [09:48:47.850] [bbotk]  399f0da6-0ded-4b74-8984-e2b29de8f065 
## INFO  [09:48:47.854] [bbotk] Evaluating 1 configuration(s) 
## INFO  [09:48:48.272] [bbotk] Result of batch 3: 
## INFO  [09:48:48.274] [bbotk]  threshold.thresholds classif.ce runtime_learners 
## INFO  [09:48:48.274] [bbotk]                0.9622      0.696            0.257 
## INFO  [09:48:48.274] [bbotk]                                 uhash 
## INFO  [09:48:48.274] [bbotk]  fdf131dc-9a2b-48b5-b426-8149cb9ec97a 
## INFO  [09:48:48.278] [bbotk] Evaluating 1 configuration(s) 
## INFO  [09:48:48.732] [bbotk] Result of batch 4: 
## INFO  [09:48:48.734] [bbotk]  threshold.thresholds classif.ce runtime_learners 
## INFO  [09:48:48.734] [bbotk]                0.1035      0.296            0.283 
## INFO  [09:48:48.734] [bbotk]                                 uhash 
## INFO  [09:48:48.734] [bbotk]  80c440e8-feac-4f77-a68d-3936c817305d 
## INFO  [09:48:48.738] [bbotk] Evaluating 1 configuration(s) 
## INFO  [09:48:49.200] [bbotk] Result of batch 5: 
## INFO  [09:48:49.202] [bbotk]  threshold.thresholds classif.ce runtime_learners 
## INFO  [09:48:49.202] [bbotk]                0.5423      0.285            0.276 
## INFO  [09:48:49.202] [bbotk]                                 uhash 
## INFO  [09:48:49.202] [bbotk]  f84c526c-fecc-4afd-8e89-56574c245e7d 
## INFO  [09:48:49.213] [bbotk] Finished optimizing after 5 evaluation(s) 
## INFO  [09:48:49.214] [bbotk] Result: 
## INFO  [09:48:49.215] [bbotk]  threshold.thresholds learner_param_vals  x_domain classif.ce 
## INFO  [09:48:49.215] [bbotk]                0.2148          &lt;list[2]&gt; &lt;list[1]&gt;      0.281</code></pre>
<p>Inside the <code>trafo</code>, we simply collect all set params into a named vector via <code>map_dbl</code> and store it
in the <code>threshold.thresholds</code> slot expected by the learner.</p>
<p>Again, we create a <code>AutoTuner</code>, which automatically tunes the supplied learner over the <code>ParamSet</code> we supplied above.</p>
<p>One drawback of this strategy is, that this requires us to fit a new model for each new threshold setting.
While setting a threshold and computing performance is relatively cheap, fitting the learner is often
more computationally demanding.
A better strategy is therefore often to optimize the thresholds separately after each model fit.</p>
</div>
<div id="pipeoptunethreshold" class="section level3" number="8.7.7">
<h3>
<span class="header-section-number">8.7.7</span> PipeOpTunethreshold<a class="anchor" aria-label="anchor" href="#pipeoptunethreshold"><i class="fas fa-link"></i></a>
</h3>
<p><code>PipeOpTuneThreshold</code> on the other hand works together with <code>PipeOpLearnerCV</code>.
It directly optimizes the <code>cross-validated</code> predictions made by this <code>PipeOp</code>.
This is done in order to avoid over-fitting the threshold tuning.</p>
<p>A simple example would be:</p>
<div class="sourceCode" id="cb801"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com//reference/po.html">po</a></span><span class="op">(</span><span class="st">"learner_cv"</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://mlr3pipelines.mlr-org.com//reference/grapes-greater-than-greater-than-grapes.html">%&gt;&gt;%</a></span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com//reference/po.html">po</a></span><span class="op">(</span><span class="st">"tunethreshold"</span><span class="op">)</span>
<span class="va">l2</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_learner.html">as_learner</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span></code></pre></div>
<p>Note, that <code>predict_type</code> = “prob” is required for <code>po("tunethreshold")</code> to work.
Additionally, note that this time no <code>threshold</code> parameter is exposed, it is automatically tuned internally.</p>
<div class="sourceCode" id="cb802"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">l2</span><span class="op">$</span><span class="va">param_set</span></code></pre></div>
<pre><code>## &lt;ParamSetCollection&gt;
##                                         id    class lower upper nlevels
##  1:        classif.rpart.resampling.method ParamFct    NA    NA       2
##  2:         classif.rpart.resampling.folds ParamInt     2   Inf     Inf
##  3: classif.rpart.resampling.keep_response ParamLgl    NA    NA       2
##  4:                       classif.rpart.cp ParamDbl     0     1     Inf
##  5:               classif.rpart.keep_model ParamLgl    NA    NA       2
##  6:               classif.rpart.maxcompete ParamInt     0   Inf     Inf
##  7:                 classif.rpart.maxdepth ParamInt     1    30      30
##  8:             classif.rpart.maxsurrogate ParamInt     0   Inf     Inf
##  9:                classif.rpart.minbucket ParamInt     1   Inf     Inf
## 10:                 classif.rpart.minsplit ParamInt     1   Inf     Inf
## 11:           classif.rpart.surrogatestyle ParamInt     0     1       2
## 12:             classif.rpart.usesurrogate ParamInt     0     2       3
## 13:                     classif.rpart.xval ParamInt     0   Inf     Inf
## 14:           classif.rpart.affect_columns ParamUty    NA    NA     Inf
## 15:                  tunethreshold.measure ParamUty    NA    NA     Inf
## 16:                tunethreshold.optimizer ParamUty    NA    NA     Inf
## 17:                tunethreshold.log_level ParamUty    NA    NA     Inf
##            default      value
##  1: &lt;NoDefault[3]&gt;         cv
##  2: &lt;NoDefault[3]&gt;          3
##  3: &lt;NoDefault[3]&gt;      FALSE
##  4:           0.01           
##  5:          FALSE           
##  6:              4           
##  7:             30           
##  8:              5           
##  9: &lt;NoDefault[3]&gt;           
## 10:             20           
## 11:              0           
## 12:              2           
## 13:             10          0
## 14:  &lt;Selector[1]&gt;           
## 15: &lt;NoDefault[3]&gt; classif.ce
## 16: &lt;NoDefault[3]&gt;      gensa
## 17:  &lt;function[1]&gt;       warn</code></pre>
<p>Note that we can set <code>rsmp("intask")</code> as a resampling strategy for “learner_cv” in order to evaluate
predictions on the “training” data. This is generally not advised, as it might lead to over-fitting
on the thresholds but can significantly reduce runtime.</p>
<p>For more information, see the post on Threshold Tuning on the <a href="https://mlr3gallery.mlr-org.com/">mlr3 gallery</a>.</p>

</div>
</div>
<div id="cluster" class="section level2" number="8.8">
<h2>
<span class="header-section-number">8.8</span> Cluster Analysis<a class="anchor" aria-label="anchor" href="#cluster"><i class="fas fa-link"></i></a>
</h2>
<p>Cluster analysis is a type of unsupervised machine learning where the goal is to group data into clusters, where each cluster contains similar observations.
The similarity is based on specified metrics that are task and application dependent.
Cluster analysis is closely related to classification in a sense that each observation needs to be assigned to a cluster or a class.
However, unlike classification problems where each observation is labeled, clustering works on data sets without true labels or class assignments.</p>
<p>The package <a href="https://mlr3cluster.mlr-org.com">mlr3cluster</a> extends <a href="https://mlr3.mlr-org.com">mlr3</a> with the following objects for cluster analysis:</p>
<ul>
<li>
<a href="https://mlr3cluster.mlr-org.com/reference/TaskClust.html"><code>TaskClust</code></a> to define clustering tasks</li>
<li>
<a href="https://mlr3cluster.mlr-org.com/reference/LearnerClust.html"><code>LearnerClust</code></a> as base class for clustering learners</li>
<li>
<a href="https://mlr3cluster.mlr-org.com/reference/PredictionClust.html"><code>PredictionClust</code></a> as specialized class for <a href="https://mlr3.mlr-org.com/reference/Prediction.html"><code>Prediction</code></a> objects</li>
<li>
<a href="https://mlr3cluster.mlr-org.com/reference/MeasureClust.html"><code>MeasureClust</code></a> as specialized class for performance measures</li>
</ul>
<p>Since clustering is a type of unsupervised learning, <code>TaskClust</code> is slightly different from <code>TaskRegr</code> and <code>TaskClassif</code> objects.
More specifically:</p>
<ul>
<li>
<code>truth()</code> function is missing because observations are not labeled.</li>
<li>
<code>target</code> field is empty and will return <code>character(0)</code> if accessed anyway.</li>
</ul>
<p>Additionally, <code>LearnerClust</code> provides two extra fields that are absent from supervised learners:</p>
<ul>
<li>
<code>assignments</code> returns cluster assignments for training data. It return <code>NULL</code> if accessed before training.</li>
<li>
<code>save_assignments</code> is a boolean field that controls whether or not to store training set assignments in a learner.</li>
</ul>
<p>Finally, <code>PredictionClust</code> contains additional two fields:</p>
<ul>
<li>
<code>partition</code> stores cluster partitions.</li>
<li>
<code>prob</code> stores cluster probabilities for each observation.</li>
</ul>
<div id="train-and-predict-2" class="section level3" number="8.8.1">
<h3>
<span class="header-section-number">8.8.1</span> Train and Predict<a class="anchor" aria-label="anchor" href="#train-and-predict-2"><i class="fas fa-link"></i></a>
</h3>
<p>Clustering learners provide both <code>train</code> and <code>predict</code> methods.
The analysis typically consists of building clusters using all available data.
To be consistent with the rest of the library, we refer to this process as training.</p>
<p>Some learners can assign new observations to existing groups with <code>predict</code>.
However, prediction does not always make sense, as it is the case for hierarchical clustering.
In hierarchical clustering, the goal is to build a hierarchy of nested clusters by either splitting large clusters into smaller ones or merging smaller clusters into bigger ones.
The final result is a tree or dendrogram which can change if a new data point is added.
For consistency with the rest of the ecosystem, <a href="https://mlr3cluster.mlr-org.com">mlr3cluster</a> offers <code>predict</code> method for hierarchical clusterers but it simply assigns all points to a specified number of clusters by cutting the resulting tree at a corresponding level.
Moreover, some learners estimate the probability of each observation belonging to a given cluster.
<code>predict_types</code> field gives a list of prediction types for each learner.</p>
<p>After training, the <code>model</code> field stores a learner’s model that looks different for each learner depending on the underlying library.
<code>predict</code> returns a <code>PredictionClust</code> object that gives a simplified view of the learned model.
If the data given to the <code>predict</code> method is the same as the one on which the learner was trained, <code>predict</code> simply returns cluster assignments for the “training” observations.
On the other hand, if the test set contains new data, <code>predict</code> will estimate cluster assignments for that data set.
Some learners do not support estimating cluster partitions on new data and will instead return assignments for training data and print a warning message.</p>
<p>In the following example, a <a href="https://mlr3cluster.mlr-org.com/reference/mlr_learners_clust.kmeans.html"><code>$k$-means learner</code></a> is applied on the <a href="https://mlr3cluster.mlr-org.com/reference/mlr_tasks_usarrests.html"><code>US arrest data set</code></a>.
The class labels are predicted and the contribution of the task features to assignment of the respective class are visualized.</p>
<div class="sourceCode" id="cb804"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3.mlr-org.com">"mlr3"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3cluster.mlr-org.com">"mlr3cluster"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3viz.mlr-org.com">"mlr3viz"</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span>

<span class="co"># create an example task</span>
<span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"usarrests"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">task</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;TaskClust:usarrests&gt; (50 x 4)
## * Target: -
## * Properties: -
## * Features (4):
##   - int (2): Assault, UrbanPop
##   - dbl (2): Murder, Rape</code></pre>
<div class="sourceCode" id="cb806"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">task</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-special-cluster_files/figure-html/07-special-cluster-002-1.svg" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb807"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create a k-means learner</span>
<span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.kmeans"</span><span class="op">)</span>

<span class="co"># assigning each observation to one of the two clusters (default in clust.kmeans)</span>
<span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>
<span class="va">learner</span><span class="op">$</span><span class="va">model</span></code></pre></div>
<pre><code>## K-means clustering with 2 clusters of sizes 21, 29
## 
## Cluster means:
##   Assault Murder  Rape UrbanPop
## 1   255.0 11.857 28.11    67.62
## 2   109.8  4.841 16.25    64.03
## 
## Clustering vector:
##  [1] 1 1 1 1 1 1 2 1 1 1 2 2 1 2 2 2 2 1 2 1 2 1 2 1 2 2 2 1 2 2 1 1 1 2 2 2 2 2
## [39] 2 1 2 1 1 2 2 2 2 2 2 2
## 
## Within cluster sum of squares by cluster:
## [1] 41637 54762
##  (between_SS / total_SS =  72.9 %)
## 
## Available components:
## 
## [1] "cluster"      "centers"      "totss"        "withinss"     "tot.withinss"
## [6] "betweenss"    "size"         "iter"         "ifault"</code></pre>
<div class="sourceCode" id="cb809"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># make "predictions" for the same data</span>
<span class="va">prediction</span> <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">prediction</span>, <span class="va">task</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-special-cluster_files/figure-html/07-special-cluster-002-2.svg" width="672" style="display: block; margin: auto;"></div>
</div>
<div id="measures" class="section level3" number="8.8.2">
<h3>
<span class="header-section-number">8.8.2</span> Measures<a class="anchor" aria-label="anchor" href="#measures"><i class="fas fa-link"></i></a>
</h3>
<p>The difference between supervised and unsupervised learning is that there is no ground truth data in unsupervised learning.
In a supervised setting, such as classification, we would need to compare our predictions to true labels.
Since clustering is an example of unsupervised learning, there are no true labels to which we can compare.
However, we can still measure the quality of cluster assignments by quantifying how closely objects within the same cluster are related (cluster cohesion) as well as how distinct different clusters are from each other (cluster separation).</p>
<p>To assess the quality of clustering, there are a few built-in evaluation metrics available.
One of them is <a href="https://mlr3cluster.mlr-org.com/reference/mlr_measures_clust.wss.html"><code>within sum of squares (WSS)</code></a> which calculates the sum of squared differences between observations and centroids.
WSS is useful because it quantifies cluster cohesion.
The range of this measure is <span class="math inline">\([0, \infty)\)</span> where a smaller value means that clusters are more compact.</p>
<p>Another measure is <a href="https://mlr3cluster.mlr-org.com/reference/mlr_measures_clust.silhouette.html"><code>silhouette quality index</code></a> that quantifies how well each point belongs to its assigned cluster versus neighboring cluster.
Silhouette values are in <span class="math inline">\([-1, 1]\)</span> range.</p>
<p>Points with silhouette closer to:</p>
<ul>
<li>1 are well clustered</li>
<li>0 lie between two clusters</li>
<li>-1 likely placed in the wrong cluster</li>
</ul>
<p>The following is an example of conducting a benchmark experiment with various learners on <a href="https://mlr3.mlr-org.com/reference/mlr_tasks_iris.html"><code>iris data set</code></a> without target variable and assessing the quality of each learner with both within sum of squares and silhouette measures.</p>
<div class="sourceCode" id="cb810"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">design</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark_grid.html">benchmark_grid</a></span><span class="op">(</span>
  tasks <span class="op">=</span> <span class="va"><a href="https://mlr3cluster.mlr-org.com/reference/TaskClust.html">TaskClust</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"iris"</span>, <span class="va">iris</span><span class="op">[</span><span class="op">-</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span>,
  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.kmeans"</span>, centers <span class="op">=</span> <span class="fl">3L</span><span class="op">)</span>,
    <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.pam"</span>, k <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span>,
    <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.cmeans"</span>, centers <span class="op">=</span> <span class="fl">3L</span><span class="op">)</span><span class="op">)</span>,
  resamplings <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">rsmp</a></span><span class="op">(</span><span class="st">"insample"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></code></pre></div>
<pre><code>##               task                  learner               resampling
## 1: &lt;TaskClust[45]&gt; &lt;LearnerClustKMeans[37]&gt; &lt;ResamplingInsample[19]&gt;
## 2: &lt;TaskClust[45]&gt;    &lt;LearnerClustPAM[37]&gt; &lt;ResamplingInsample[19]&gt;
## 3: &lt;TaskClust[45]&gt; &lt;LearnerClustCMeans[37]&gt; &lt;ResamplingInsample[19]&gt;</code></pre>
<div class="sourceCode" id="cb812"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># execute benchmark</span>
<span class="va">bmr</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/benchmark.html">benchmark</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span>

<span class="co"># define measure</span>
<span class="va">measures</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"clust.wss"</span><span class="op">)</span>, <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"clust.silhouette"</span><span class="op">)</span><span class="op">)</span>
<span class="va">bmr</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="va">measures</span><span class="op">)</span></code></pre></div>
<pre><code>##    nr      resample_result task_id   learner_id resampling_id iters clust.wss
## 1:  1 &lt;ResampleResult[22]&gt;    iris clust.kmeans      insample     1     78.85
## 2:  2 &lt;ResampleResult[22]&gt;    iris    clust.pam      insample     1    153.33
## 3:  3 &lt;ResampleResult[22]&gt;    iris clust.cmeans      insample     1     79.03
##    clust.silhouette
## 1:           0.5555
## 2:           0.7158
## 3:           0.5493</code></pre>
<p>The experiment shows that using k-means algorithm with three centers produces a better within sum of squares score than any other learner considered. However, pam (partitioning around medoids) learner with two clusters performs the best when considering silhouette measure which takes into the account both cluster cohesion and separation.</p>
</div>
<div id="visualization" class="section level3" number="8.8.3">
<h3>
<span class="header-section-number">8.8.3</span> Visualization<a class="anchor" aria-label="anchor" href="#visualization"><i class="fas fa-link"></i></a>
</h3>
<p>Cluster analysis in <a href="https://mlr3.mlr-org.com">mlr3</a> is integrated with <a href="https://mlr3viz.mlr-org.com">mlr3viz</a> which provides a number of useful plots. Some of those plots are shown below.</p>
<div class="sourceCode" id="cb814"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span> <span class="op">=</span> <span class="va"><a href="https://mlr3cluster.mlr-org.com/reference/TaskClust.html">TaskClust</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"iris"</span>, <span class="va">iris</span><span class="op">[</span><span class="op">-</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span>
<span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.kmeans"</span><span class="op">)</span>
<span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>
<span class="va">prediction</span> <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>

<span class="co"># performing PCA on task and showing assignments</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">prediction</span>, <span class="va">task</span>, type <span class="op">=</span> <span class="st">"pca"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-special-cluster_files/figure-html/07-special-cluster-004-1.svg" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb815"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># same as above but with probability ellipse that assumes normal distribution</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">prediction</span>, <span class="va">task</span>, type <span class="op">=</span> <span class="st">"pca"</span>, frame <span class="op">=</span> <span class="cn">TRUE</span>, frame.type <span class="op">=</span> <span class="st">"norm"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-special-cluster_files/figure-html/07-special-cluster-004-2.svg" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb816"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"usarrests"</span><span class="op">)</span>
<span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.agnes"</span><span class="op">)</span>
<span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>

<span class="co"># dendrogram for hierarchical clustering</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">learner</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-special-cluster_files/figure-html/07-special-cluster-004-3.svg" width="672" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb817"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># advanced dendrogram options from `factoextra::fviz_dend`</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">learner</span>,
  k <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">k</span>, rect_fill <span class="op">=</span> <span class="cn">TRUE</span>,
  rect <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-special-cluster_files/figure-html/07-special-cluster-004-4.svg" width="672" style="display: block; margin: auto;"></div>
<p>Silhouette plots can help to visually assess the quality of the analysis and help choose a number of clusters for a given data set.
The red dotted line shows the mean silhouette value and each bar represents a data point.
If most points in each cluster have an index around or higher than mean silhouette, the number of clusters is chosen well.</p>
<div class="sourceCode" id="cb818"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># silhouette plot allows to visually inspect the quality of clustering</span>
<span class="va">task</span> <span class="op">=</span> <span class="va"><a href="https://mlr3cluster.mlr-org.com/reference/TaskClust.html">TaskClust</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"iris"</span>, <span class="va">iris</span><span class="op">[</span><span class="op">-</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span>
<span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.kmeans"</span><span class="op">)</span>
<span class="va">learner</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>centers <span class="op">=</span> <span class="fl">5L</span><span class="op">)</span>
<span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>
<span class="va">prediction</span> <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">prediction</span>, <span class="va">task</span>, type <span class="op">=</span> <span class="st">"sil"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-special-cluster_files/figure-html/07-special-cluster-005-1.svg" width="672" style="display: block; margin: auto;"></div>
<p>The plot shows that all points in cluster 5 and almost all points in clusters 4, 2 and 1 are below average silhouette index.
This means that a lot of observations lie either on the border of clusters or are likely assigned to the wrong cluster.</p>
<div class="sourceCode" id="cb819"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"clust.kmeans"</span><span class="op">)</span>
<span class="va">learner</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>centers <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span>
<span class="va">learner</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>
<span class="va">prediction</span> <span class="op">=</span> <span class="va">learner</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">prediction</span>, <span class="va">task</span>, type <span class="op">=</span> <span class="st">"sil"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="08-special-cluster_files/figure-html/07-special-cluster-006-1.svg" width="672" style="display: block; margin: auto;"></div>
<p>Setting the number of centers to two improves both average silhouette score as well as overall quality of clustering because almost all points in cluster 1 are higher than and a lot of points in cluster 2 are close to mean silhouette.
Hence, having two centers might be a better choice for the number of clusters.</p>

</div>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="extending.html"><span class="header-section-number">7</span> Extending</a></div>
<div class="next"><a href="interpretation.html"><span class="header-section-number">9</span> Model Interpretation</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#special-tasks"><span class="header-section-number">8</span> Special Tasks</a></li>
<li>
<a class="nav-link" href="#survival"><span class="header-section-number">8.1</span> Survival Analysis</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#tasksurv"><span class="header-section-number">8.1.1</span> TaskSurv</a></li>
<li><a class="nav-link" href="#predict-types---crank-lp-and-distr"><span class="header-section-number">8.1.2</span> Predict Types - crank, lp, and distr</a></li>
<li><a class="nav-link" href="#composition"><span class="header-section-number">8.1.3</span> Composition</a></li>
<li><a class="nav-link" href="#benchmark-experiment"><span class="header-section-number">8.1.4</span> Benchmark Experiment</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#density"><span class="header-section-number">8.2</span> Density Estimation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#train-and-predict-1"><span class="header-section-number">8.2.1</span> Train and Predict</a></li>
<li><a class="nav-link" href="#benchmark-experiment-1"><span class="header-section-number">8.2.2</span> Benchmark Experiment</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#spatiotemporal"><span class="header-section-number">8.3</span> Spatiotemporal Analysis</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#creating-a-spatial-task"><span class="header-section-number">8.3.1</span> Creating a spatial Task</a></li>
<li><a class="nav-link" href="#spatiotemporal-intro"><span class="header-section-number">8.3.2</span> Autocorrelation</a></li>
<li><a class="nav-link" href="#sp-vs-nsp-cv"><span class="header-section-number">8.3.3</span> Spatial CV vs. Non-Spatial CV</a></li>
<li><a class="nav-link" href="#vis-spt-partitions"><span class="header-section-number">8.3.4</span> Visualization of Spatiotemporal Partitions</a></li>
<li><a class="nav-link" href="#vis-spatial-block"><span class="header-section-number">8.3.5</span> Spatial Block Visualization</a></li>
<li><a class="nav-link" href="#choose-spt-rsmp"><span class="header-section-number">8.3.6</span> Choosing a Resampling Method</a></li>
<li><a class="nav-link" href="#spatial-prediction"><span class="header-section-number">8.3.7</span> Spatial Prediction</a></li>
</ul>
</li>
<li><a class="nav-link" href="#ordinal"><span class="header-section-number">8.4</span> Ordinal Analysis</a></li>
<li>
<a class="nav-link" href="#functional"><span class="header-section-number">8.5</span> Functional Analysis</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#how-to-model-functional-data"><span class="header-section-number">8.5.1</span> How to model functional data?</a></li></ul>
</li>
<li><a class="nav-link" href="#multilabel"><span class="header-section-number">8.6</span> Multilabel Classification</a></li>
<li>
<a class="nav-link" href="#cost-sens"><span class="header-section-number">8.7</span> Cost-Sensitive Classification</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#a-first-model"><span class="header-section-number">8.7.1</span> A First Model</a></li>
<li><a class="nav-link" href="#cost-sensitive-measure"><span class="header-section-number">8.7.2</span> Cost-sensitive Measure</a></li>
<li><a class="nav-link" href="#thresholding-1"><span class="header-section-number">8.7.3</span> Thresholding</a></li>
<li><a class="nav-link" href="#threshold-tuning"><span class="header-section-number">8.7.4</span> Threshold Tuning</a></li>
<li><a class="nav-link" href="#adjusting-thresholds-two-strategies"><span class="header-section-number">8.7.5</span> Adjusting thresholds: Two strategies</a></li>
<li><a class="nav-link" href="#pipeopthreshold"><span class="header-section-number">8.7.6</span> PipeOpThreshold</a></li>
<li><a class="nav-link" href="#pipeoptunethreshold"><span class="header-section-number">8.7.7</span> PipeOpTunethreshold</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#cluster"><span class="header-section-number">8.8</span> Cluster Analysis</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#train-and-predict-2"><span class="header-section-number">8.8.1</span> Train and Predict</a></li>
<li><a class="nav-link" href="#measures"><span class="header-section-number">8.8.2</span> Measures</a></li>
<li><a class="nav-link" href="#visualization"><span class="header-section-number">8.8.3</span> Visualization</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/mlr-org/mlr3book/blob/main/bookdown/08-special.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/mlr-org/mlr3book/edit/main/bookdown/08-special.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>mlr3 book</strong>" was written by Marc Becker, Martin Binder, Bernd Bischl, Lars Kotthoff, Michel Lang, Florian Pfisterer, Nicholas G. Reich, Jakob Richter, Patrick Schratz, Raphael Sonabend, Damir Pulatov. It was last built on 2021-11-21.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
