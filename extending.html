<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>7 Extending | mlr3 book</title>
<meta name="author" content="Marc Becker">
<meta name="author" content="Martin Binder">
<meta name="author" content="Bernd Bischl">
<meta name="author" content="Lars Kotthoff">
<meta name="author" content="Michel Lang">
<meta name="author" content="Florian Pfisterer">
<meta name="author" content="Nicholas G. Reich">
<meta name="author" content="Jakob Richter">
<meta name="author" content="Patrick Schratz">
<meta name="author" content="Raphael Sonabend">
<meta name="author" content="Damir Pulatov">
<meta name="description" content="This chapter gives instructions on how to extend mlr3 and its extension packages with custom objects. The approach is always the same: determine the base class you want to inherit from, extend the...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="7 Extending | mlr3 book">
<meta property="og:type" content="book">
<meta property="og:url" content="https://mlr3book.mlr-org.com/extending.html">
<meta property="og:image" content="https://mlr3book.mlr-org.com//block.png">
<meta property="og:description" content="This chapter gives instructions on how to extend mlr3 and its extension packages with custom objects. The approach is always the same: determine the base class you want to inherit from, extend the...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="7 Extending | mlr3 book">
<meta name="twitter:description" content="This chapter gives instructions on how to extend mlr3 and its extension packages with custom objects. The approach is always the same: determine the base class you want to inherit from, extend the...">
<meta name="twitter:image" content="https://mlr3book.mlr-org.com//block.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">mlr3 book</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Quickstart</a></li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction and Overview</a></li>
<li><a class="" href="basics.html"><span class="header-section-number">2</span> Basics</a></li>
<li><a class="" href="perf-eval-cmp.html"><span class="header-section-number">3</span> Performance Evaluation and Comparison</a></li>
<li><a class="" href="optimization.html"><span class="header-section-number">4</span> Model Optimization</a></li>
<li><a class="" href="pipelines.html"><span class="header-section-number">5</span> Pipelines</a></li>
<li><a class="" href="technical.html"><span class="header-section-number">6</span> Technical</a></li>
<li><a class="active" href="extending.html"><span class="header-section-number">7</span> Extending</a></li>
<li><a class="" href="special-tasks.html"><span class="header-section-number">8</span> Special Tasks</a></li>
<li><a class="" href="interpretation.html"><span class="header-section-number">9</span> Model Interpretation</a></li>
<li><a class="" href="appendix.html"><span class="header-section-number">10</span> Appendix</a></li>
<li><a class="" href="citation-info.html">Citation Info</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/mlr-org/mlr3book">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="extending" class="section level1" number="7">
<h1>
<span class="header-section-number">7</span> Extending<a class="anchor" aria-label="anchor" href="#extending"><i class="fas fa-link"></i></a>
</h1>
<p>This chapter gives instructions on how to extend <a href="https://mlr3.mlr-org.com">mlr3</a> and its extension packages with custom objects.</p>
<p>The approach is always the same:</p>
<ol style="list-style-type: decimal">
<li>determine the base class you want to inherit from,</li>
<li>extend the class with your custom functionality,</li>
<li>test your implementation</li>
<li>(optionally) add new object to the respective <a href="https://mlr3misc.mlr-org.com/reference/Dictionary.html"><code>Dictionary</code></a>.</li>
</ol>
<p>The chapter <a href="extending.html#extending-learners">Create a new learner</a> illustrates the steps needed to create a custom learner in <a href="https://mlr3.mlr-org.com">mlr3</a>.</p>

<div id="extending-learners" class="section level2" number="7.1">
<h2>
<span class="header-section-number">7.1</span> Adding new Learners<a class="anchor" aria-label="anchor" href="#extending-learners"><i class="fas fa-link"></i></a>
</h2>
<p>Here, we show how to create a custom mlr3learner step-by-step using <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>mlr3extralearners::create_learner</code></a>.</p>
<p><strong>It is strongly recommended</strong> that you <strong>first</strong> open a <a href="https://github.com/mlr-org/mlr3extralearners/issues/new?assignees=&amp;labels=new+learner&amp;template=learner-request-template.md&amp;title=%5BLRNRQ%5D+Add+%3Calgorithm%3E+from+package+%3Cpackage%3E">learner request issue</a> to discuss the learner you want to implement if you plan on creating a pull request to the mlr-org. This allows us to discuss the purpose and necessity of the learner before you start to put the real work in!</p>
<p>This section gives insights on how a mlr3learner is constructed and how to troubleshoot issues.
See the <a href="extending.html#learner-faq">Learner FAQ subsection</a> for help.</p>
<p><strong>Summary of steps for adding a new learner</strong></p>
<ol style="list-style-type: decimal">
<li>Check the learner does not already exist <a href="https://mlr3extralearners.mlr-org.com/articles/learners/list_learners.html">here</a>.</li>
<li>
<a href="extending.html#setup">Fork, clone and load</a> <code>mlr3extralearners</code>.</li>
<li>
<a href="extending.html#create-learner">Run</a> <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>mlr3extralearners::create_learner</code></a>.</li>
<li>Add the learner <a href="extending.html#param-set"><code>param_set</code></a>.</li>
<li>Manually add <a href="extending.html#learner-train"><code>.train</code></a> and <a href="extending.html#learner-predict"><code>.predict</code></a> private methods to the learner.</li>
<li>If applicable add <code>importance</code> and <code>oob_error</code> public methods to the learner.</li>
<li>If applicable add references to the learner.</li>
<li>Check <a href="extending.html#learner-test">unit tests</a> and <a href="extending.html#learner-test">paramtests</a> pass (these are automatically created).</li>
<li>Run <a href="extending.html#cleaning">cleaning functions</a>
</li>
<li>Open a <a href="https://github.com/mlr-org/mlr3extralearners/pulls">pull request</a> with the new learner template.</li>
</ol>
<p><strong>(Do not copy/paste the code shown in this section. Use the create_learner to start.)</strong></p>
<div id="setup" class="section level3" number="7.1.1">
<h3>
<span class="header-section-number">7.1.1</span> Setting-up mlr3extralearners<a class="anchor" aria-label="anchor" href="#setup"><i class="fas fa-link"></i></a>
</h3>
<p>In order to use the <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>mlr3extralearners::create_learner</code></a> function you must have a local copy of the <code>mlr3extralearners</code> repository and must specify the correct path to the package. To do so, follow these steps:</p>
<ol style="list-style-type: decimal">
<li>
<a href="https://docs.github.com/en/free-pro-team@latest/github/getting-started-with-github/fork-a-repo">Fork</a> the <a href="https://github.com/mlr-org/mlr3extralearners">repository</a>
</li>
<li>
<a href="https://docs.github.com/en/free-pro-team@latest/github/creating-cloning-and-archiving-repositories/cloning-a-repository">Clone</a> a local copy of your forked repository.</li>
</ol>
<p>Then do one of:</p>
<ul>
<li>Open a new R session, call <code><a href="https://rdrr.io/r/base/library.html">library("mlr3extralearners")</a></code> (install if you haven’t already), and then <a href="extending.html#create-learner">run</a> <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>mlr3extralearners::create_learner</code></a> with the <code>pkg</code> argument set as the path (the folder location) to the package directory.</li>
<li>Open a new R session, set your working directory as your newly cloned repository, run <a href="https://www.rdocumentation.org/packages/devtools/topics/load_all"><code>devtools::load_all</code></a>, and then <a href="extending.html#create-learner">run</a> <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>mlr3extralearners::create_learner</code></a>, leaving <code>pkg = "."</code>.</li>
<li>In your newly cloned repository, open the R project, which will automatically set your working directory, run <a href="https://www.rdocumentation.org/packages/devtools/topics/load_all"><code>devtools::load_all</code></a>, and then <a href="extending.html#create-learner">run</a> <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>mlr3extralearners::create_learner</code></a>, leaving <code>pkg = "."</code>.</li>
</ul>
<p>We recommend the last option. It is also important that you are familiar with the three <code>devtools</code> commands:</p>
<ul>
<li>
<a href="https://www.rdocumentation.org/packages/devtools/topics/document"><code>devtools::document</code></a> - Generates roxygen documentation for your new learner.</li>
<li>
<a href="https://www.rdocumentation.org/packages/devtools/topics/load_all"><code>devtools::load_all</code></a> - Loads all functions from <code>mlr3extralearners</code> locally, including hidden helper functions.</li>
<li>
<a href="https://www.rdocumentation.org/packages/devtools/topics/check"><code>devtools::check</code></a> - Checks that the package still passes all tests locally.</li>
</ul>
</div>
<div id="create-learner" class="section level3" number="7.1.2">
<h3>
<span class="header-section-number">7.1.2</span> Calling create_learner<a class="anchor" aria-label="anchor" href="#create-learner"><i class="fas fa-link"></i></a>
</h3>
<p>The learner <code>classif.rpart</code> will be used as a running example throughout this section.</p>
<div class="sourceCode" id="cb651"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"mlr3extralearners"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/mlr3extralearners/man/create_learner.html">create_learner</a></span><span class="op">(</span>
  pkg <span class="op">=</span> <span class="st">"."</span>,
  classname <span class="op">=</span> <span class="st">"Rpart"</span>,
  algorithm <span class="op">=</span> <span class="st">"decision tree"</span>,
  type <span class="op">=</span> <span class="st">"classif"</span>,
  key <span class="op">=</span> <span class="st">"rpart"</span>,
  package <span class="op">=</span> <span class="st">"rpart"</span>,
  caller <span class="op">=</span> <span class="st">"rpart"</span>,
  feature_types <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"logical"</span>, <span class="st">"integer"</span>, <span class="st">"numeric"</span>, <span class="st">"factor"</span>, <span class="st">"ordered"</span><span class="op">)</span>,
  predict_types <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"response"</span>, <span class="st">"prob"</span><span class="op">)</span>,
  properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"importance"</span>, <span class="st">"missings"</span>, <span class="st">"multiclass"</span>, <span class="st">"selected_features"</span>, <span class="st">"twoclass"</span>, <span class="st">"weights"</span><span class="op">)</span>,
  references <span class="op">=</span> <span class="cn">TRUE</span>,
  gh_name <span class="op">=</span> <span class="st">"RaphaelS1"</span>
<span class="op">)</span></code></pre></div>
<p>The full documentation for the function arguments is in <a href="https://mlr3extralearners.mlr-org.com/reference/create_learner.html"><code>mlr3extralearners::create_learner</code></a>, in this example we are doing the following:</p>
<ol style="list-style-type: decimal">
<li>
<code>pkg = "."</code> - Set the package root to the current directory (assumes <code>mlr3extralearners</code> already set as the working directory)</li>
<li>
<code>classname = "Rpart"</code> - Set the R6 class name to LearnerClassifRpart (classif is below)</li>
<li>
<code>algorithm = "decision tree"</code> - Create the title as “Classification Decision Tree Learner”, where “Classification” is determined automatically from <code>type</code> and “Learner” is added for all learners.</li>
<li>
<code>type = "classif"</code> - Setting the learner as a classification learner, automatically filling the title, class name, id (“classif.rpart”) and task type.</li>
<li>
<code>key = "rpart"</code> - Used with <code>type</code> to create the unique ID of the learner, <code>classif.rpart</code>.</li>
<li>
<code>package = "rpart"</code> - Setting the package from which the learner is implemented, this fills in things like the training function (along with <code>caller</code>) and the <code>man</code> field.</li>
<li>
<code>caller = "rpart"</code> - This tells the <code>.train</code> function, and the description which function is called to run the algorithm, with <code>package</code> this automatically fills <code><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart::rpart</a></code>.</li>
<li>
<code>feature_types = c("logical", "integer", "numeric", "factor", "ordered")</code> - Sets the type of features that can be handled by the learner. See <a href="extending.html#learner-meta-information">meta information</a>.</li>
<li>
<code>predict_types = c("response", "prob"),</code> - Sets the possible prediction types as response (deterministic) and prob (probabilistic). See <a href="extending.html#learner-meta-information">meta information</a>.</li>
<li>
<code>properties = c("importance", "missings", "multiclass", "selected_features", "twoclass", "weights")</code> - Sets the properties that are handled by the learner, by including <code>"importance"</code> a public method called <code>importance</code> will be created that must be manually filled. See <a href="extending.html#learner-meta-information">meta information</a>.</li>
<li>
<code>references = TRUE</code> - Tells the template to add a “references” tag that must be filled manually.</li>
<li>
<code>gh_name = "RaphaelS1"</code> - Fills the “author” tag with my GitHub handle, this is required as it identifies the maintainer of the learner.</li>
</ol>
<p>The sections below demonstrate what happens after the function has been run and the files that are created.</p>
</div>
<div id="learner_package_type_key.r" class="section level3" number="7.1.3">
<h3>
<span class="header-section-number">7.1.3</span> learner_package_type_key.R<a class="anchor" aria-label="anchor" href="#learner_package_type_key.r"><i class="fas fa-link"></i></a>
</h3>
<p>The first script to complete after running <code>create_learner</code> is the file with the form <code>learner_package_type_key.R</code>, in our case this will actually be <code>learner_rpart_classif_rpart.key</code>. <strong>This name must not be changed</strong> as triggering automated tests rely on a strict naming scheme. For our example, the resulting script looks like this:</p>
<div class="sourceCode" id="cb652"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb652-1"><a href="extending.html#cb652-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @title Classification Decision Tree Learner</span></span>
<span id="cb652-2"><a href="extending.html#cb652-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @author RaphaelS1</span></span>
<span id="cb652-3"><a href="extending.html#cb652-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @name mlr_learners_classif.rpart</span></span>
<span id="cb652-4"><a href="extending.html#cb652-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb652-5"><a href="extending.html#cb652-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @template class_learner</span></span>
<span id="cb652-6"><a href="extending.html#cb652-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @templateVar id classif.rpart</span></span>
<span id="cb652-7"><a href="extending.html#cb652-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @templateVar caller rpart</span></span>
<span id="cb652-8"><a href="extending.html#cb652-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb652-9"><a href="extending.html#cb652-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @references</span></span>
<span id="cb652-10"><a href="extending.html#cb652-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' &lt;</span><span class="al">FIXME</span><span class="co"> - DELETE THIS AND LINE ABOVE IF OMITTED&gt;</span></span>
<span id="cb652-11"><a href="extending.html#cb652-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb652-12"><a href="extending.html#cb652-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @template seealso_learner</span></span>
<span id="cb652-13"><a href="extending.html#cb652-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' @template example</span></span>
<span id="cb652-14"><a href="extending.html#cb652-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb652-15"><a href="extending.html#cb652-15" aria-hidden="true" tabindex="-1"></a>LearnerClassifRpart <span class="ot">=</span> <span class="fu">R6Class</span>(<span class="st">"LearnerClassifRpart"</span>,</span>
<span id="cb652-16"><a href="extending.html#cb652-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">inherit =</span> LearnerClassif,</span>
<span id="cb652-17"><a href="extending.html#cb652-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-18"><a href="extending.html#cb652-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb652-19"><a href="extending.html#cb652-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' @description</span></span>
<span id="cb652-20"><a href="extending.html#cb652-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' Creates a new instance of this [R6][R6::R6Class] class.</span></span>
<span id="cb652-21"><a href="extending.html#cb652-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb652-22"><a href="extending.html#cb652-22" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co"> - MANUALLY ADD PARAM_SET BELOW AND THEN DELETE THIS LINE</span></span>
<span id="cb652-23"><a href="extending.html#cb652-23" aria-hidden="true" tabindex="-1"></a>      ps <span class="ot">=</span> <span class="er">&lt;</span>param_set<span class="sc">&gt;</span></span>
<span id="cb652-24"><a href="extending.html#cb652-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-25"><a href="extending.html#cb652-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co"> - MANUALLY UPDATE PARAM VALUES BELOW IF APPLICABLE THEN DELETE THIS LINE.</span></span>
<span id="cb652-26"><a href="extending.html#cb652-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># OTHERWISE DELETE THIS AND LINE BELOW.</span></span>
<span id="cb652-27"><a href="extending.html#cb652-27" aria-hidden="true" tabindex="-1"></a>      ps<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="sc">&lt;</span>param_vals<span class="sc">&gt;</span>)</span>
<span id="cb652-28"><a href="extending.html#cb652-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-29"><a href="extending.html#cb652-29" aria-hidden="true" tabindex="-1"></a>      super<span class="sc">$</span><span class="fu">initialize</span>(</span>
<span id="cb652-30"><a href="extending.html#cb652-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">id =</span> <span class="st">"classif.rpart"</span>,</span>
<span id="cb652-31"><a href="extending.html#cb652-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">packages =</span> <span class="st">"rpart"</span>,</span>
<span id="cb652-32"><a href="extending.html#cb652-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">feature_types =</span> <span class="fu">c</span>(<span class="st">"logical"</span>, <span class="st">"integer"</span>, <span class="st">"numeric"</span>, <span class="st">"factor"</span>, <span class="st">"ordered"</span>),</span>
<span id="cb652-33"><a href="extending.html#cb652-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">predict_types =</span> <span class="fu">c</span>(<span class="st">"response"</span>, <span class="st">"prob"</span>),</span>
<span id="cb652-34"><a href="extending.html#cb652-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">param_set =</span> ps,</span>
<span id="cb652-35"><a href="extending.html#cb652-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">properties =</span> <span class="fu">c</span>(<span class="st">"importance"</span>, <span class="st">"missings"</span>, <span class="st">"multiclass"</span>, <span class="st">"selected_features"</span>, <span class="st">"twoclass"</span>, <span class="st">"weights"</span>),</span>
<span id="cb652-36"><a href="extending.html#cb652-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">man =</span> <span class="st">"mlr3extralearners::mlr_learners_classif.rpart"</span></span>
<span id="cb652-37"><a href="extending.html#cb652-37" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb652-38"><a href="extending.html#cb652-38" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb652-39"><a href="extending.html#cb652-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-40"><a href="extending.html#cb652-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">FIXME</span><span class="co"> - ADD IMPORTANCE METHOD HERE AND DELETE THIS LINE.</span></span>
<span id="cb652-41"><a href="extending.html#cb652-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># &lt;See LearnerRegrRandomForest for an example&gt;</span></span>
<span id="cb652-42"><a href="extending.html#cb652-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' @description</span></span>
<span id="cb652-43"><a href="extending.html#cb652-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' The importance scores are extracted from the slot &lt;</span><span class="al">FIXME</span><span class="co">&gt;.</span></span>
<span id="cb652-44"><a href="extending.html#cb652-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">#' @return Named `numeric()`.</span></span>
<span id="cb652-45"><a href="extending.html#cb652-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">importance =</span> <span class="cf">function</span>() { }</span>
<span id="cb652-46"><a href="extending.html#cb652-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-47"><a href="extending.html#cb652-47" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb652-48"><a href="extending.html#cb652-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-49"><a href="extending.html#cb652-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(</span>
<span id="cb652-50"><a href="extending.html#cb652-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-51"><a href="extending.html#cb652-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">.train =</span> <span class="cf">function</span>(task) {</span>
<span id="cb652-52"><a href="extending.html#cb652-52" aria-hidden="true" tabindex="-1"></a>      pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"train"</span>)</span>
<span id="cb652-53"><a href="extending.html#cb652-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-54"><a href="extending.html#cb652-54" aria-hidden="true" tabindex="-1"></a>      <span class="co"># set column names to ensure consistency in fit and predict</span></span>
<span id="cb652-55"><a href="extending.html#cb652-55" aria-hidden="true" tabindex="-1"></a>      self<span class="sc">$</span>state<span class="sc">$</span>feature_names <span class="ot">=</span> task<span class="sc">$</span>feature_names</span>
<span id="cb652-56"><a href="extending.html#cb652-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-57"><a href="extending.html#cb652-57" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co"> - &lt;Create objects for the train call</span></span>
<span id="cb652-58"><a href="extending.html#cb652-58" aria-hidden="true" tabindex="-1"></a>      <span class="co"># &lt;At least "data" and "formula" are required&gt;</span></span>
<span id="cb652-59"><a href="extending.html#cb652-59" aria-hidden="true" tabindex="-1"></a>      formula <span class="ot">=</span> task<span class="sc">$</span><span class="fu">formula</span>()</span>
<span id="cb652-60"><a href="extending.html#cb652-60" aria-hidden="true" tabindex="-1"></a>      data <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>()</span>
<span id="cb652-61"><a href="extending.html#cb652-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-62"><a href="extending.html#cb652-62" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co"> - &lt;here is space for some custom adjustments before proceeding to the</span></span>
<span id="cb652-63"><a href="extending.html#cb652-63" aria-hidden="true" tabindex="-1"></a>      <span class="co"># train call. Check other learners for what can be done here&gt;</span></span>
<span id="cb652-64"><a href="extending.html#cb652-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-65"><a href="extending.html#cb652-65" aria-hidden="true" tabindex="-1"></a>      <span class="co"># use the mlr3misc::invoke function (it's similar to do.call())</span></span>
<span id="cb652-66"><a href="extending.html#cb652-66" aria-hidden="true" tabindex="-1"></a>      mlr3misc<span class="sc">::</span><span class="fu">invoke</span>(rpart<span class="sc">::</span>rpart,</span>
<span id="cb652-67"><a href="extending.html#cb652-67" aria-hidden="true" tabindex="-1"></a>                       <span class="at">formula =</span> formula,</span>
<span id="cb652-68"><a href="extending.html#cb652-68" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> data,</span>
<span id="cb652-69"><a href="extending.html#cb652-69" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.args =</span> pars)</span>
<span id="cb652-70"><a href="extending.html#cb652-70" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb652-71"><a href="extending.html#cb652-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-72"><a href="extending.html#cb652-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">.predict =</span> <span class="cf">function</span>(task) {</span>
<span id="cb652-73"><a href="extending.html#cb652-73" aria-hidden="true" tabindex="-1"></a>      <span class="co"># get parameters with tag "predict"</span></span>
<span id="cb652-74"><a href="extending.html#cb652-74" aria-hidden="true" tabindex="-1"></a>      pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"predict"</span>)</span>
<span id="cb652-75"><a href="extending.html#cb652-75" aria-hidden="true" tabindex="-1"></a>      <span class="co"># get newdata</span></span>
<span id="cb652-76"><a href="extending.html#cb652-76" aria-hidden="true" tabindex="-1"></a>      newdata <span class="ot">=</span> task<span class="sc">$</span><span class="fu">data</span>(<span class="at">cols =</span> task<span class="sc">$</span>feature_names)</span>
<span id="cb652-77"><a href="extending.html#cb652-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-78"><a href="extending.html#cb652-78" aria-hidden="true" tabindex="-1"></a>      pred <span class="ot">=</span> mlr3misc<span class="sc">::</span><span class="fu">invoke</span>(predict, self<span class="sc">$</span>model, <span class="at">newdata =</span> newdata,</span>
<span id="cb652-79"><a href="extending.html#cb652-79" aria-hidden="true" tabindex="-1"></a>                              <span class="at">type =</span> type, <span class="at">.args =</span> pars)</span>
<span id="cb652-80"><a href="extending.html#cb652-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-81"><a href="extending.html#cb652-81" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">FIXME</span><span class="co"> - ADD PREDICTIONS TO LIST BELOW</span></span>
<span id="cb652-82"><a href="extending.html#cb652-82" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(...)</span>
<span id="cb652-83"><a href="extending.html#cb652-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb652-84"><a href="extending.html#cb652-84" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb652-85"><a href="extending.html#cb652-85" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb652-86"><a href="extending.html#cb652-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-87"><a href="extending.html#cb652-87" aria-hidden="true" tabindex="-1"></a>.extralrns_dict<span class="sc">$</span><span class="fu">add</span>(<span class="st">"classif.rpart"</span>, LearnerClassifRpart)</span></code></pre></div>
<p>Now we have to do the following (from top to bottom):</p>
<ol style="list-style-type: decimal">
<li>Fill in the references under “references” and delete the tag that starts “FIXME”</li>
<li>Replace <code>&lt;param_set&gt;</code> with a <a href="extending.html#param-set">parameter set</a>
</li>
<li>Optionally <a href="extending.html#param-set">change default values</a> for parameters in <code>&lt;param_vals&gt;</code>
</li>
<li>As we included “importance” in <code>properties</code> we have to add a function to the public method <code>importance</code>
</li>
<li>Fill in the private <a href="extending.html#learner-train"><code>.train</code></a> method, which takes a (filtered) <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> and returns a model.</li>
<li>Fill in the private <a href="extending.html#learner-predict"><code>.predict</code></a> method, which operates on the model in <code>self$model</code> (stored during <code>$train()</code>) and a (differently subsetted) <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> to return a named list of predictions.</li>
</ol>
</div>
<div id="learner-meta-information" class="section level3" number="7.1.4">
<h3>
<span class="header-section-number">7.1.4</span> Meta-information<a class="anchor" aria-label="anchor" href="#learner-meta-information"><i class="fas fa-link"></i></a>
</h3>
<p>In the constructor (<code>initialize()</code>) the constructor of the super class (e.g. <a href="https://mlr3.mlr-org.com/reference/LearnerClassif.html"><code>LearnerClassif</code></a>) is called with meta information about the learner which should be constructed.
This includes:</p>
<ul>
<li>
<code>id</code>: The ID of the new learner. Usually consists of <code>&lt;type&gt;.&lt;algorithm&gt;</code>, for example: <code>"classif.rpart"</code>.</li>
<li>
<code>packages</code>: The upstream package name of the implemented learner.</li>
<li>
<code>param_set</code>: A set of hyperparameters and their descriptions provided as a <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>paradox::ParamSet</code></a>.
For each hyperparameter the appropriate class needs to be chosen. When using the <a href="https://paradox.mlr-org.com/reference/ps.html"><code>paradox::ps</code></a> shortcut, a short constructor of the form <code>p_***</code> can be used:
<ul>
<li>
<a href="https://paradox.mlr-org.com/reference/ParamLgl.html"><code>paradox::ParamLgl</code></a> / <a href="https://paradox.mlr-org.com/reference/Domain.html"><code>paradox::p_lgl</code></a> for scalar logical hyperparameters.</li>
<li>
<a href="https://paradox.mlr-org.com/reference/ParamInt.html"><code>paradox::ParamInt</code></a> / <a href="https://paradox.mlr-org.com/reference/Domain.html"><code>paradox::p_int</code></a> for scalar integer hyperparameters.</li>
<li>
<a href="https://paradox.mlr-org.com/reference/ParamDbl.html"><code>paradox::ParamDbl</code></a> / <a href="https://paradox.mlr-org.com/reference/Domain.html"><code>paradox::p_dbl</code></a> for scalar numeric hyperparameters.</li>
<li>
<a href="https://paradox.mlr-org.com/reference/ParamFct.html"><code>paradox::ParamFct</code></a> / <a href="https://paradox.mlr-org.com/reference/Domain.html"><code>paradox::p_fct</code></a> for scalar factor hyperparameters (this includes characters).</li>
<li>
<a href="https://paradox.mlr-org.com/reference/ParamUty.html"><code>paradox::ParamUty</code></a> / <a href="https://paradox.mlr-org.com/reference/Domain.html"><code>paradox::p_uty</code></a> for everything else (e.g. vector paramters or list parameters).</li>
</ul>
</li>
<li>
<code>predict_types</code>: Set of predict types the learner is able to handle.
These differ depending on the type of the learner. See <a href="https://mlr3.mlr-org.com/reference/mlr_reflections.html"><code>mlr_reflections$learner_predict_types</code></a> for the full list of feature types supported by <code>mlr3</code>.
<ul>
<li>
<code>LearnerClassif</code>
<ul>
<li>
<code>response</code>: Only predicts a class label for each observation in the test set.</li>
<li>
<code>prob</code>: Also predicts the posterior probability for each class for each observation in the test set.</li>
</ul>
</li>
<li>
<code>LearnerRegr</code>
<ul>
<li>
<code>response</code>: Only predicts a numeric response for each observation in the test set.</li>
<li>
<code>se</code>: Also predicts the standard error for each value of response for each observation in the test set.</li>
</ul>
</li>
</ul>
</li>
<li>
<code>feature_types</code>: Set of feature types the learner is able to handle.
See <a href="https://mlr3.mlr-org.com/reference/mlr_reflections.html"><code>mlr_reflections$task_feature_types</code></a> for feature types supported by <code>mlr3</code>.</li>
<li>
<code>properties</code>: Set of properties of the learner. See <a href="https://mlr3.mlr-org.com/reference/mlr_reflections.html"><code>mlr_reflections$learner_properties</code></a> for the full list of feature types supported by <code>mlr3</code>. Possible properties include:
<ul>
<li>
<code>"twoclass"</code>: The learner works on binary classification problems.</li>
<li>
<code>"multiclass"</code>: The learner works on multi-class classification problems.</li>
<li>
<code>"missings"</code>: The learner can natively handle missing values.</li>
<li>
<code>"weights"</code>: The learner can work on tasks which have observation weights / case weights.</li>
<li>
<code>"parallel"</code>: The learner supports internal parallelization in some way.
Currently not used, this is an experimental property.</li>
<li>
<code>"importance"</code>: The learner supports extracting importance values for features.
If this property is set, you must also implement a public method <code>importance()</code> to retrieve the importance values from the model.</li>
<li>
<code>"selected_features"</code>: The learner supports extracting the features which where used.
If this property is set, you must also implement a public method <code>selected_features()</code> to retrieve the set of used features from the model.</li>
</ul>
</li>
<li>
<code>man</code>: The roxygen identifier of the learner.
This is used within the <code>$help()</code> method of the super class to open the help page of the learner.</li>
</ul>
</div>
<div id="param-set" class="section level3" number="7.1.5">
<h3>
<span class="header-section-number">7.1.5</span> ParamSet<a class="anchor" aria-label="anchor" href="#param-set"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>param_set</code> is the set of hyperparameters used in model training and predicting, this is given as a <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>paradox::ParamSet</code></a>. The set consists of a list of hyperparameters, each has a specific class for the hyperparameter type (see above).</p>
<p>For <code>classif.rpart</code> the following replace <code>&lt;param_set&gt;</code> above:</p>
<div class="sourceCode" id="cb653"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ps</span> <span class="op">=</span> <span class="va"><a href="https://paradox.mlr-org.com/reference/ParamSet.html">ParamSet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="va"><a href="https://paradox.mlr-org.com/reference/ParamInt.html">ParamInt</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"minsplit"</span>, default <span class="op">=</span> <span class="fl">20L</span>, lower <span class="op">=</span> <span class="fl">1L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  <span class="va"><a href="https://paradox.mlr-org.com/reference/ParamInt.html">ParamInt</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"minbucket"</span>, lower <span class="op">=</span> <span class="fl">1L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  <span class="va"><a href="https://paradox.mlr-org.com/reference/ParamDbl.html">ParamDbl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"cp"</span>, default <span class="op">=</span> <span class="fl">0.01</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="fl">1</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  <span class="va"><a href="https://paradox.mlr-org.com/reference/ParamInt.html">ParamInt</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"maxcompete"</span>, default <span class="op">=</span> <span class="fl">4L</span>, lower <span class="op">=</span> <span class="fl">0L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  <span class="va"><a href="https://paradox.mlr-org.com/reference/ParamInt.html">ParamInt</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"maxsurrogate"</span>, default <span class="op">=</span> <span class="fl">5L</span>, lower <span class="op">=</span> <span class="fl">0L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  <span class="va"><a href="https://paradox.mlr-org.com/reference/ParamInt.html">ParamInt</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"maxdepth"</span>, default <span class="op">=</span> <span class="fl">30L</span>, lower <span class="op">=</span> <span class="fl">1L</span>, upper <span class="op">=</span> <span class="fl">30L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  <span class="va"><a href="https://paradox.mlr-org.com/reference/ParamInt.html">ParamInt</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"usesurrogate"</span>, default <span class="op">=</span> <span class="fl">2L</span>, lower <span class="op">=</span> <span class="fl">0L</span>, upper <span class="op">=</span> <span class="fl">2L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  <span class="va"><a href="https://paradox.mlr-org.com/reference/ParamInt.html">ParamInt</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"surrogatestyle"</span>, default <span class="op">=</span> <span class="fl">0L</span>, lower <span class="op">=</span> <span class="fl">0L</span>, upper <span class="op">=</span> <span class="fl">1L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  <span class="va"><a href="https://paradox.mlr-org.com/reference/ParamInt.html">ParamInt</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"xval"</span>, default <span class="op">=</span> <span class="fl">0L</span>, lower <span class="op">=</span> <span class="fl">0L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  <span class="va"><a href="https://paradox.mlr-org.com/reference/ParamLgl.html">ParamLgl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"keep_model"</span>, default <span class="op">=</span> <span class="cn">FALSE</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span>
<span class="va">ps</span><span class="op">$</span><span class="va">values</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>xval <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span></code></pre></div>
<p>Within mlr3 packages we suggest to stick to the lengthly definition for consistency, however the <code>&lt;param_set&gt;</code> can be written shorter, using the <a href="https://paradox.mlr-org.com/reference/ps.html"><code>paradox::ps</code></a> shortcut:</p>
<div class="sourceCode" id="cb654"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ps</span> <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/ps.html">ps</a></span><span class="op">(</span>
  minsplit <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1L</span>, default <span class="op">=</span> <span class="fl">20L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  minbucket <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  cp <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_dbl</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="fl">1</span>, default <span class="op">=</span> <span class="fl">0.01</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  maxcompete <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0L</span>, default <span class="op">=</span> <span class="fl">4L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  maxsurrogate <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0L</span>, default <span class="op">=</span> <span class="fl">5L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  maxdepth <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">1L</span>, upper <span class="op">=</span> <span class="fl">30L</span>, default <span class="op">=</span> <span class="fl">30L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  usesurrogate <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0L</span>, upper <span class="op">=</span> <span class="fl">2L</span>, default <span class="op">=</span> <span class="fl">2L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  surrogatestyle <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0L</span>, upper <span class="op">=</span> <span class="fl">1L</span>, default <span class="op">=</span> <span class="fl">0L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  xval <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_int</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fl">0L</span>, default <span class="op">=</span> <span class="fl">0L</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>,
  keep_model <span class="op">=</span> <span class="fu"><a href="https://paradox.mlr-org.com/reference/Domain.html">p_lgl</a></span><span class="op">(</span>default <span class="op">=</span> <span class="cn">FALSE</span>, tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>You should read though the learner documentation to find the full list of available parameters. Just looking at some of these in this example:</p>
<ul>
<li>
<code>"cp"</code> is numeric, has a feasible range of <code>[0,1]</code> and defaults to <code>0.01</code>.
The parameter is used during <code>"train"</code>.</li>
<li>
<code>"xval"</code> is integer has a lower bound of <code>0</code>, a default of <code>0</code> and the parameter is used during <code>"train"</code>.</li>
<li>
<code>"keep_model"</code> is logical with a default of <code>FALSE</code> and is used during <code>"train"</code>.</li>
</ul>
<p>In some rare cases you may want to change the default parameter values. You can do this by passing a list to <code>&lt;param_vals&gt;</code> in the template script above. You can see we have done this for <code>"classif.rpart"</code> where the default for <code>xval</code> is changed to <code>0</code>. Note that the default in the <code>ParamSet</code> is recorded as our changed default (0), and not the original (10). It is strongly recommended to only change the defaults if absolutely required, when this is the case add the following to the learner documentation:</p>
<div class="sourceCode" id="cb655"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' @section Custom mlr3 defaults:</span>
<span class="co">#' - `&lt;parameter&gt;`:</span>
<span class="co">#'   - Actual default: &lt;value&gt;</span>
<span class="co">#'   - Adjusted default: &lt;value&gt;</span>
<span class="co">#'   - Reason for change: &lt;text&gt;</span></code></pre></div>
</div>
<div id="learner-train" class="section level3" number="7.1.6">
<h3>
<span class="header-section-number">7.1.6</span> Train function<a class="anchor" aria-label="anchor" href="#learner-train"><i class="fas fa-link"></i></a>
</h3>
<p>Let’s talk about the <code>.train()</code> method.
The train function takes a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> as input and must return a model.</p>
<p>Let’s say we want to translate the following call of <code><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart::rpart()</a></code> into code that can be used inside the <code>.train()</code> method.</p>
<p>First, we write something down that works completely without <code>mlr3</code>:</p>
<div class="sourceCode" id="cb656"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">=</span> <span class="va">iris</span>
<span class="va">model</span> <span class="op">=</span> <span class="fu">rpart</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">iris</span>, xval <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<p>We need to pass the formula notation <code>Species ~ .</code>, the data and the hyperparameters.
To get the hyperparameters, we call <code>self$param_set$get_values()</code> and query all parameters that are using during <code>"train"</code>.</p>
<p>The dataset is extracted from the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>.</p>
<p>Last, we call the upstream function <code><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart::rpart()</a></code> with the data and pass all hyperparameters via argument <code>.args</code> using the <code><a href="https://mlr3misc.mlr-org.com/reference/invoke.html">mlr3misc::invoke()</a></code> function.
The latter is simply an optimized version of <code><a href="https://rdrr.io/r/base/do.call.html">do.call()</a></code> that we use within the mlr3 ecosystem.</p>
<div class="sourceCode" id="cb657"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.train</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">pars</span> <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span>tags <span class="op">=</span> <span class="st">"train"</span><span class="op">)</span>
  <span class="va">formula</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="fu">formula</span><span class="op">(</span><span class="op">)</span>
  <span class="va">data</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span>
  <span class="fu">mlr3misc</span><span class="fu">::</span><span class="fu"><a href="https://mlr3misc.mlr-org.com/reference/invoke.html">invoke</a></span><span class="op">(</span><span class="fu">rpart</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart</a></span>,
                   formula <span class="op">=</span> <span class="va">formula</span>,
                   data <span class="op">=</span> <span class="va">data</span>,
                   .args <span class="op">=</span> <span class="va">pars</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="learner-predict" class="section level3" number="7.1.7">
<h3>
<span class="header-section-number">7.1.7</span> Predict function<a class="anchor" aria-label="anchor" href="#learner-predict"><i class="fas fa-link"></i></a>
</h3>
<p>The internal predict method <code>.predict()</code> also operates on a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> as well as on the fitted model that has been created by the <code>train()</code> call previously and has been stored in <code>self$model</code>.</p>
<p>The return value is a <a href="https://mlr3.mlr-org.com/reference/Prediction.html"><code>Prediction</code></a> object.
We proceed analogously to what we did in the previous section.
We start with a version without any <code>mlr3</code> objects and continue to replace objects until we have reached the desired interface:</p>
<div class="sourceCode" id="cb658"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># inputs:</span>
<span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span>
<span class="va">self</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>model <span class="op">=</span> <span class="fu">rpart</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="fu">formula</span><span class="op">(</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">data</span> <span class="op">=</span> <span class="va">iris</span>
<span class="va">response</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">model</span>, newdata <span class="op">=</span> <span class="va">data</span>, type <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span>
<span class="va">prob</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">model</span>, newdata <span class="op">=</span> <span class="va">data</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></code></pre></div>
<p>The <a href="https://www.rdocumentation.org/packages/rpart/topics/predict.rpart"><code>rpart::predict.rpart()</code></a> function predicts class labels if argument <code>type</code> is set to to <code>"class"</code>, and class probabilities if set to <code>"prob"</code>.</p>
<p>Next, we transition from <code>data</code> to a <code>task</code> again and construct a list with the return type requested by the user, this is stored in the <code>$predict_type</code> slot of a learner class. Note that the <code>task</code> is automatically passed to the prediction object, so all you need to do is return the predictions! Make sure the list names are identical to the task predict types.</p>
<p>The final <code>.predict()</code> method is below, we could omit the <code>pars</code> line as there are no parameters with the <code>"predict"</code> tag but we keep it here to be consistent:</p>
<div class="sourceCode" id="cb659"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.predict</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">pars</span> <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="fu">get_values</span><span class="op">(</span>tags <span class="op">=</span> <span class="st">"predict"</span><span class="op">)</span>
  <span class="co"># get newdata and ensure same ordering in train and predict</span>
  <span class="va">newdata</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>cols <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="va">feature_names</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">predict_type</span> <span class="op">==</span> <span class="st">"response"</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">response</span> <span class="op">=</span> <span class="fu">mlr3misc</span><span class="fu">::</span><span class="fu"><a href="https://mlr3misc.mlr-org.com/reference/invoke.html">invoke</a></span><span class="op">(</span><span class="va">predict</span>,
                            <span class="va">self</span><span class="op">$</span><span class="va">model</span>,
                            newdata <span class="op">=</span> <span class="va">newdata</span>,
                            type <span class="op">=</span> <span class="st">"class"</span>,
                            .args <span class="op">=</span> <span class="va">pars</span><span class="op">)</span>

    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>response <span class="op">=</span> <span class="va">response</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">prob</span> <span class="op">=</span> <span class="fu">mlr3misc</span><span class="fu">::</span><span class="fu"><a href="https://mlr3misc.mlr-org.com/reference/invoke.html">invoke</a></span><span class="op">(</span><span class="va">predict</span>,
                            <span class="va">self</span><span class="op">$</span><span class="va">model</span>,
                            newdata <span class="op">=</span> <span class="va">newdata</span>,
                            type <span class="op">=</span> <span class="st">"prob"</span>,
                            .args <span class="op">=</span> <span class="va">pars</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="va">prob</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>Note that you cannot rely on the column order of the data returned by <code>task$data()</code> as the order of columns may be different from the order of the columns during <code>$.train</code>. The <code>newdata</code> line ensures the ordering is the same by calling the saved order set in <code>$.train</code>, don’t delete either of these lines!</p>
</div>
<div id="learner-control" class="section level3" number="7.1.8">
<h3>
<span class="header-section-number">7.1.8</span> Control objects/functions of learners<a class="anchor" aria-label="anchor" href="#learner-control"><i class="fas fa-link"></i></a>
</h3>
<p>Some learners rely on a “control” object/function such as <code><a href="https://glmnet.stanford.edu/reference/glmnet.control.html">glmnet::glmnet.control()</a></code>.
Accounting for such depends on how the underlying package works:</p>
<ul>
<li>If the package forwards the control parameters via <code>...</code> and makes it possible to just pass control parameters as additional parameters directly to the train call, there is no need to distinguish both <code>"train"</code> and <code>"control"</code> parameters.
Both can be tagged with “train” in the ParamSet and just be handed over as shown previously.</li>
<li>If the control parameters need to be passed via a separate argument, the parameters should also be tagged accordingly in the ParamSet.
Afterwards they can be queried via their tag and passed separately to <code><a href="https://mlr3misc.mlr-org.com/reference/invoke.html">mlr3misc::invoke()</a></code>.
See example below.</li>
</ul>
<div class="sourceCode" id="cb660"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb660-1"><a href="extending.html#cb660-1" aria-hidden="true" tabindex="-1"></a>control_pars <span class="ot">=</span> mlr3misc<span class="sc">::</span>(<span class="sc">&lt;</span>package<span class="sc">&gt;</span><span class="er">::&lt;</span><span class="cf">function</span><span class="sc">&gt;</span>,</span>
<span id="cb660-2"><a href="extending.html#cb660-2" aria-hidden="true" tabindex="-1"></a>   self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"control"</span>))</span>
<span id="cb660-3"><a href="extending.html#cb660-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb660-4"><a href="extending.html#cb660-4" aria-hidden="true" tabindex="-1"></a>train_pars <span class="ot">=</span> self<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">get_values</span>(<span class="at">tags =</span> <span class="st">"train"</span>)<span class="er">)</span></span>
<span id="cb660-5"><a href="extending.html#cb660-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb660-6"><a href="extending.html#cb660-6" aria-hidden="true" tabindex="-1"></a>mlr3misc<span class="sc">::</span><span class="fu">invoke</span>([...], <span class="at">.args =</span> train_pars, <span class="at">control =</span> control_pars)</span></code></pre></div>
</div>
<div id="learner-test" class="section level3" number="7.1.9">
<h3>
<span class="header-section-number">7.1.9</span> Testing the learner<a class="anchor" aria-label="anchor" href="#learner-test"><i class="fas fa-link"></i></a>
</h3>
<p>Once your learner is created, you are ready to start testing if it works, there are three types of tests: <a href="extending.html#learner-test-manual">manual</a>, <a href="extending.html#learner-test-unit">unit</a> and <a href="extending.html#learner-test-parameter">parameter</a>.</p>
<div id="learner-test-manual" class="section level4" number="7.1.9.1">
<h4>
<span class="header-section-number">7.1.9.1</span> Train and Predict<a class="anchor" aria-label="anchor" href="#learner-test-manual"><i class="fas fa-link"></i></a>
</h4>
<p>For a bare-bone check you can just try to run a simple <code>train()</code> call locally.</p>
<div class="sourceCode" id="cb661"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span> <span class="co"># assuming a Classif learner</span>
<span class="va">lrn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mlr3extralearners/man/lrn.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span>
<span class="va">lrn</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>
<span class="va">p</span> <span class="op">=</span> <span class="va">lrn</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>
<span class="va">p</span><span class="op">$</span><span class="va">confusion</span></code></pre></div>
<p>If it runs without erroring, that’s a very good start!</p>
</div>
<div id="learner-test-unit" class="section level4" number="7.1.9.2">
<h4>
<span class="header-section-number">7.1.9.2</span> Autotest<a class="anchor" aria-label="anchor" href="#learner-test-unit"><i class="fas fa-link"></i></a>
</h4>
<p>To ensure that your learner is able to handle all kinds of different properties and feature types, we have written an “autotest” that checks the learner for different combinations of such.</p>
<p>The “autotest” setup is generated automatically by <code>create_learner</code> and will open after running the function, it will have a name with the form <code>test_package_type_key.R</code>, in our case this will actually be <code>test_rpart_classif_rpart.key</code>. <strong>This name must not be changed</strong> as triggering automated tests rely on a strict naming scheme. In our example this will create the following script, for which no changes are required to pass (assuming the learner was correctly created):</p>
<div class="sourceCode" id="cb662"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/mlr3extralearners/man/install_learners.html">install_learners</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span>

<span class="fu">test_that</span><span class="op">(</span><span class="st">"autotest"</span>, <span class="op">{</span>
  <span class="va">learner</span> <span class="op">=</span> <span class="va"><a href="https://mlr3.mlr-org.com/reference/mlr_learners_classif.rpart.html">LearnerClassifRpart</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
  <span class="fu">expect_learner</span><span class="op">(</span><span class="va">learner</span><span class="op">)</span>
  <span class="va">result</span> <span class="op">=</span> <span class="fu">run_autotest</span><span class="op">(</span><span class="va">learner</span><span class="op">)</span>
  <span class="fu">expect_true</span><span class="op">(</span><span class="va">result</span>, info <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">error</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>For some learners that have required parameters, it is needed to set some values for required parameters after construction so that the learner can be run in the first place.</p>
<p>You can also exclude some specific test arrangements within the “autotest” via the argument <code>exclude</code> in the <code>run_autotest()</code> function.
Currently the <code>run_autotest()</code> function lives in <a href="https://github.com/mlr-org/mlr3/blob/f16326bf34bcac59c3b0a2fdbcf90dbebb3b4bbc/inst/testthat/helper_autotest.R">inst/testthat</a> of the <code>mlr_plkg("mlr3")</code> and still lacks documentation.
This should change in the near future.</p>
<p>To finally run the test suite, call <code><a href="https://devtools.r-lib.org//reference/test.html">devtools::test()</a></code> or hit <code>CTRL + Shift + T</code> if you are using RStudio.</p>
</div>
<div id="learner-test-parameter" class="section level4" number="7.1.9.3">
<h4>
<span class="header-section-number">7.1.9.3</span> Checking Parameters<a class="anchor" aria-label="anchor" href="#learner-test-parameter"><i class="fas fa-link"></i></a>
</h4>
<p>Some learners have a high number of parameters and it is easy to miss out on some during the creation of a new learner.
In addition, if the maintainer of the upstream package changes something with respect to the arguments of the algorithm, the learner is in danger to break.
Also, new arguments could be added upstream and manually checking for new additions all the time is tedious.</p>
<p>Therefore we have written a “Parameter Check” that runs for every learner asynchronously to the R CMD Check of the package itself. This “Parameter Check” compares the parameters of the mlr3 ParamSet against all arguments available in the upstream function that is called during <code>$train()</code> and <code>$predict()</code>. Again the file is automatically created and opened by <code>create_learner</code>, this will be named like <code>test_paramtest_package_type_key.R</code>, so in our example <code>test_paramtest_rpart_classif_rpart.R</code>.</p>
<p>The test comes with an <code>exclude</code> argument that should be used to <em>exclude and explain</em> why certain arguments of the upstream function are not within the ParamSet of the mlr3learner. This will likely be required for all learners as common arguments like <code>x</code>, <code>target</code> or <code>data</code> are handled by the mlr3 interface and are therefore not included within the ParamSet.</p>
<p>However, there might be more parameters that need to be excluded, for example:</p>
<ul>
<li>Type dependent parameters, i.e. parameters that only apply for classification or regression learners.</li>
<li>Parameters that are actually deprecated by the upstream package and which were therefore not included in the mlr3 ParamSet.</li>
</ul>
<p>All excluded parameters should have a comment justifying their exclusion.</p>
<p>In our example, the final paramtest script looks like:</p>
<div class="sourceCode" id="cb663"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"mlr3extralearners"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/mlr3extralearners/man/install_learners.html">install_learners</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span>

<span class="fu">test_that</span><span class="op">(</span><span class="st">"classif.rpart train"</span>, <span class="op">{</span>
  <span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mlr3extralearners/man/lrn.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span>
  <span class="va">fun</span> <span class="op">=</span> <span class="fu">rpart</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart</a></span>
  <span class="va">exclude</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"formula"</span>,<span class="co"># handled internally</span>
    <span class="st">"model"</span>, <span class="co"># handled internally</span>
    <span class="st">"data"</span>, <span class="co"># handled internally</span>
    <span class="st">"weights"</span>, <span class="co"># handled by task</span>
    <span class="st">"subset"</span>, <span class="co"># handled by task</span>
    <span class="st">"na.action"</span>, <span class="co"># handled internally</span>
    <span class="st">"method"</span>, <span class="co"># handled internally</span>
    <span class="st">"x"</span>, <span class="co"># handled internally</span>
    <span class="st">"y"</span>, <span class="co"># handled internally</span>
    <span class="st">"parms"</span>, <span class="co"># handled internally</span>
    <span class="st">"control"</span>, <span class="co"># handled internally</span>
    <span class="st">"cost"</span> <span class="co"># handled internally</span>
  <span class="op">)</span>

  <span class="va">ParamTest</span> <span class="op">=</span> <span class="fu">run_paramtest</span><span class="op">(</span><span class="va">learner</span>, <span class="va">fun</span>, <span class="va">exclude</span><span class="op">)</span>
  <span class="fu">expect_true</span><span class="op">(</span><span class="va">ParamTest</span>, info <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"Missing parameters:"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"- '"</span>, <span class="va">ParamTest</span><span class="op">$</span><span class="va">missing</span>, <span class="st">"'"</span>, collapse <span class="op">=</span> <span class="st">"
"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="fu">test_that</span><span class="op">(</span><span class="st">"classif.rpart predict"</span>, <span class="op">{</span>
  <span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mlr3extralearners/man/lrn.html">lrn</a></span><span class="op">(</span><span class="st">"classif.rpart"</span><span class="op">)</span>
  <span class="va">fun</span> <span class="op">=</span> <span class="fu">rpart</span><span class="fu">:::</span><span class="va"><a href="https://rdrr.io/pkg/rpart/man/predict.rpart.html">predict.rpart</a></span>
    <span class="va">exclude</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"object"</span>, <span class="co"># handled internally</span>
      <span class="st">"newdata"</span>, <span class="co"># handled internally</span>
      <span class="st">"type"</span>, <span class="co"># handled internally</span>
      <span class="st">"na.action"</span> <span class="co"># handled internally</span>
    <span class="op">)</span>

  <span class="va">ParamTest</span> <span class="op">=</span> <span class="fu">run_paramtest</span><span class="op">(</span><span class="va">learner</span>, <span class="va">fun</span>, <span class="va">exclude</span><span class="op">)</span>
  <span class="fu">expect_true</span><span class="op">(</span><span class="va">ParamTest</span>, info <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"Missing parameters:"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"- '"</span>, <span class="va">ParamTest</span><span class="op">$</span><span class="va">missing</span>, <span class="st">"'"</span>, collapse <span class="op">=</span> <span class="st">"
"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="cleaning" class="section level3" number="7.1.10">
<h3>
<span class="header-section-number">7.1.10</span> Package Cleaning<a class="anchor" aria-label="anchor" href="#cleaning"><i class="fas fa-link"></i></a>
</h3>
<p>Once all tests are passing, run the following functions to ensure that the package remains clean and tidy</p>
<ol style="list-style-type: decimal">
<li><code>devtools::document(roclets = c('rd', 'collate', 'namespace'))</code></li>
<li>If you haven’t done this before run: <code>remotes::install_github('pat-s/styler@mlr-style')</code>
</li>
<li><code>styler::style_pkg(style = styler::mlr_style)</code></li>
<li><code><a href="https://usethis.r-lib.org/reference/tidyverse.html">usethis::use_tidy_description()</a></code></li>
<li><code>lintr::lint_package()</code></li>
</ol>
<p>Please fix any errors indicated by <code>lintr</code> before creating a pull request. Finally ensure that all <code>FIXME</code> are resolved and deleted in the generated files.</p>
<p>You are now ready to add your learner to the mlr3 ecosystem! Simply open a pull request to  with the new learner template and complete the checklist in there. Once the pull request is approved and merged, your learner will automatically appear on the <a href="https://mlr3extralearners.mlr-org.com/">package website</a>.</p>
</div>
<div id="thanks-and-maintenance" class="section level3" number="7.1.11">
<h3>
<span class="header-section-number">7.1.11</span> Thanks and Maintenance<a class="anchor" aria-label="anchor" href="#thanks-and-maintenance"><i class="fas fa-link"></i></a>
</h3>
<p>Thank you for contributing to the mlr3 ecosystem!</p>
<p>When you created the learner you would have given your GitHub handle, meaning that you are now listed as the learner author and maintainer. This means that if the learner breaks it is your responsibility to fix the learner - you can view the status of your learner <a href="https://mlr3extralearners.mlr-org.com/articles/learners/learner_status.html">here</a>.</p>
</div>
<div id="learner-faq" class="section level3" number="7.1.12">
<h3>
<span class="header-section-number">7.1.12</span> Learner FAQ<a class="anchor" aria-label="anchor" href="#learner-faq"><i class="fas fa-link"></i></a>
</h3>
<p><strong>Question 1</strong></p>
<p>How to deal with Parameters which have no default?</p>
<p><strong>Answer</strong></p>
<p>If the learner does not work without providing a value, set a reasonable default in <code>param_set$values</code>, add tag <code>"required"</code> to the parameter and document your default properly.</p>
<p><strong>Question 2</strong></p>
<p>Where to add the package of the upstream package in the DESCRIPTION file?</p>
<p>Add it to the “Imports” section.
This will install the upstream package during the installation of the mlr3learner if it has not yet been installed by the user.</p>
<p><strong>Question 3</strong></p>
<p>How to handle arguments from external “control” functions such as <code>glmnet::glmnet_control()</code>?</p>
<p><strong>Answer</strong></p>
<p>See <a href="https://mlr3book.mlr-org.com/extending-learners.html#learner-control">“Control objects/functions of learners”</a>.</p>
<p><strong>Question 4</strong></p>
<p>How to document if my learner uses a custom default value that differs to the default of the upstream package?</p>
<p><strong>Answer</strong></p>
<p>If you set a custom default for the mlr3learner that does not cope with the one of the upstream package (think twice if this is really needed!), add this information to the help page of the respective learner.</p>
<p>You can use the following skeleton for this:</p>
<div class="sourceCode" id="cb664"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' @section Custom mlr3 defaults:</span>
<span class="co">#' - `&lt;parameter&gt;`:</span>
<span class="co">#'   - Actual default: &lt;value&gt;</span>
<span class="co">#'   - Adjusted default: &lt;value&gt;</span>
<span class="co">#'   - Reason for change: &lt;text&gt;</span></code></pre></div>
<p><strong>Question 5</strong></p>
<p>When should the <code>"required"</code> tag be used when defining Params and what is its purpose?</p>
<p><strong>Answer</strong></p>
<p>The <code>"required"</code> tag should be used when the following conditions are met:</p>
<ul>
<li>The upstream function cannot be run without setting this parameter, i.e. it would throw an error.</li>
<li>The parameter has no default in the upstream function.</li>
</ul>
<p>In mlr3 we follow the principle that every learner should be constructable without setting custom parameters.
Therefore, if a parameter has no default in the upstream function, a custom value is usually set for this parameter in the mlr3learner (remember to document such changes in the help page of the learner).</p>
<p>Even though this practice ensures that no parameter is unset in an mlr3learner and partially removes the usefulness of the <code>"required"</code> tag, the tag is still useful in the following scenario:</p>
<p>If a user sets custom parameters after construction of the learner</p>
<div class="sourceCode" id="cb665"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb665-1"><a href="extending.html#cb665-1" aria-hidden="true" tabindex="-1"></a>lrn <span class="ot">=</span> <span class="fu">lrn</span>(<span class="st">"&lt;id&gt;"</span>)</span>
<span id="cb665-2"><a href="extending.html#cb665-2" aria-hidden="true" tabindex="-1"></a>lrn<span class="sc">$</span>param_set<span class="sc">$</span>values <span class="ot">=</span> <span class="fu">list</span>(<span class="st">"&lt;param&gt;"</span> <span class="ot">=</span> <span class="er">&lt;</span>value<span class="sc">&gt;</span>)</span></code></pre></div>
<p>Here, all parameters besides the ones set in the list would be unset.
See <code><a href="https://paradox.mlr-org.com/reference/ParamSet.html">paradox::ParamSet</a></code> for more information.
If a parameter is tagged as <code>"required"</code> in the ParamSet, the call above would error and prompt the user that required parameters are missing.</p>
<p><strong>Question 6</strong></p>
<p>What is this error when I run <code><a href="https://devtools.r-lib.org//reference/load_all.html">devtools::load_all()</a></code></p>
<div class="sourceCode" id="cb666"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb666-1"><a href="extending.html#cb666-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> devtools<span class="sc">::</span><span class="fu">load_all</span>(<span class="st">"."</span>)</span>
<span id="cb666-2"><a href="extending.html#cb666-2" aria-hidden="true" tabindex="-1"></a>Loading mlr3extralearners</span>
<span id="cb666-3"><a href="extending.html#cb666-3" aria-hidden="true" tabindex="-1"></a>Warning message<span class="sc">:</span></span>
<span id="cb666-4"><a href="extending.html#cb666-4" aria-hidden="true" tabindex="-1"></a>.onUnload failed <span class="cf">in</span> <span class="fu">unloadNamespace</span>() <span class="cf">for</span> <span class="st">'mlr3extralearners'</span>, details<span class="sc">:</span></span>
<span id="cb666-5"><a href="extending.html#cb666-5" aria-hidden="true" tabindex="-1"></a>  call<span class="sc">:</span> <span class="fu">vapply</span>(hooks, <span class="cf">function</span>(x) <span class="fu">environment</span>(x)<span class="sc">$</span>pkgname, <span class="cn">NA_character_</span>)</span>
<span id="cb666-6"><a href="extending.html#cb666-6" aria-hidden="true" tabindex="-1"></a>  error<span class="sc">:</span> values must be length <span class="dv">1</span>,</span>
<span id="cb666-7"><a href="extending.html#cb666-7" aria-hidden="true" tabindex="-1"></a> but <span class="fu">FUN</span>(X[[<span class="dv">1</span>]]) result is length <span class="dv">0</span></span></code></pre></div>
<p><strong>Answer</strong></p>
<p>This is not an error but a warning and you can safely ignore it!</p>

</div>
</div>
<div id="extending-measures" class="section level2" number="7.2">
<h2>
<span class="header-section-number">7.2</span> Adding new Measures<a class="anchor" aria-label="anchor" href="#extending-measures"><i class="fas fa-link"></i></a>
</h2>
<p>In this section we showcase how to implement a custom performance measure.</p>
<p>A good starting point is writing down the loss function independently of mlr3 (we also did this in the <a href="https://mlr3measures.mlr-org.com">mlr3measures</a> package).
Here, we illustrate writing measure by implementing the root of the mean squared error for regression problems:</p>
<div class="sourceCode" id="cb667"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">root_mse</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, <span class="va">response</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">mse</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">truth</span> <span class="op">-</span> <span class="va">response</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">root_mse</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.4082</code></pre>
<p>In the next step, we embed the <code>root_mse()</code> function into a new <a href="https://cran.r-project.org/package=R6">R6</a> class inheriting from base classes <a href="https://mlr3.mlr-org.com/reference/MeasureRegr.html"><code>MeasureRegr</code></a>/<a href="https://mlr3.mlr-org.com/reference/Measure.html"><code>Measure</code></a>.
For classification measures, use <a href="https://mlr3.mlr-org.com/reference/MeasureClassif.html"><code>MeasureClassif</code></a>.
We keep it simple here and only explain the most important parts of the <a href="https://mlr3.mlr-org.com/reference/Measure.html"><code>Measure</code></a> class:</p>
<div class="sourceCode" id="cb669"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">MeasureRootMSE</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"MeasureRootMSE"</span>,
  inherit <span class="op">=</span> <span class="fu">mlr3</span><span class="fu">::</span><span class="va"><a href="https://mlr3.mlr-org.com/reference/MeasureRegr.html">MeasureRegr</a></span>,
  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span>
        <span class="co"># custom id for the measure</span>
        id <span class="op">=</span> <span class="st">"root_mse"</span>,

        <span class="co"># additional packages required to calculate this measure</span>
        packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,

        <span class="co"># properties, see below</span>
        properties <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="op">)</span>,

        <span class="co"># required predict type of the learner</span>
        predict_type <span class="op">=</span> <span class="st">"response"</span>,

        <span class="co"># feasible range of values</span>
        range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">Inf</span><span class="op">)</span>,

        <span class="co"># minimize during tuning?</span>
        minimize <span class="op">=</span> <span class="cn">TRUE</span>
      <span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>,

  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="co"># custom scoring function operating on the prediction object</span>
    .score <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">prediction</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">root_mse</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, <span class="va">response</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">mse</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">truth</span> <span class="op">-</span> <span class="va">response</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
        <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span>
      <span class="op">}</span>

      <span class="fu">root_mse</span><span class="op">(</span><span class="va">prediction</span><span class="op">$</span><span class="va">truth</span>, <span class="va">prediction</span><span class="op">$</span><span class="va">response</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>This class can be used as template for most performance measures.
If something is missing, you might want to consider having a deeper dive into the following arguments:</p>
<ul>
<li>
<code>properties</code>: If you tag you measure with the property <code>"requires_task"</code>, the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> is automatically passed to your <code>.score()</code> function (don’t forget to add the argument <code>task</code> in the signature).
The same is possible with <code>"requires_learner"</code> if you need to operate on the <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> and <code>"requires_train_set"</code> if you want to access the set of training indices in the score function.</li>
<li>
<code>aggregator</code>: This function (defaulting to <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code>) controls how multiple performance scores, i.e. from different resampling iterations, are aggregated into a single numeric value if <code>average</code> is set to micro averaging.
This is ignored for macro averaging.</li>
<li>
<code>predict_sets</code>: Prediction sets (subset of <code>("train", "test")</code>) to operate on.
Defaults to the “test” set.</li>
</ul>
<p>Finally, if you want to use your custom measure just like any other measure shipped with <a href="https://mlr3.mlr-org.com">mlr3</a> and access it via the <a href="https://mlr3.mlr-org.com/reference/mlr_measures.html"><code>mlr_measures</code></a> dictionary, you can easily add it:</p>
<div class="sourceCode" id="cb670"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mlr3</span><span class="fu">::</span><span class="va"><a href="https://mlr3.mlr-org.com/reference/mlr_measures.html">mlr_measures</a></span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="st">"root_mse"</span>, <span class="va">MeasureRootMSE</span><span class="op">)</span></code></pre></div>
<p>Typically it is a good idea to put the measure together with the call to <code>mlr_measures$add()</code> in a new R file and just source it in your project.</p>
<div class="sourceCode" id="cb671"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## source("measure_root_mse.R")</span>
<span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">msr</a></span><span class="op">(</span><span class="st">"root_mse"</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;MeasureRootMSE:root_mse&gt;
## * Packages: -
## * Range: [0, Inf]
## * Minimize: TRUE
## * Parameters: list()
## * Properties: -
## * Predict type: response</code></pre>

</div>
<div id="extending-pipeops" class="section level2" number="7.3">
<h2>
<span class="header-section-number">7.3</span> Adding new PipeOps<a class="anchor" aria-label="anchor" href="#extending-pipeops"><i class="fas fa-link"></i></a>
</h2>
<p>This section showcases how the <code>mlr3pipelines</code> package can be extended to include custom <code>PipeOp</code>s.
To run the following examples, we will need a <code>Task</code>; we are using the well-known “Iris” task:</p>
<div class="sourceCode" id="cb673"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3.mlr-org.com">"mlr3"</a></span><span class="op">)</span>
<span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">tsk</a></span><span class="op">(</span><span class="st">"iris"</span><span class="op">)</span>
<span class="va">task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width
##   1:    setosa          1.4         0.2          5.1         3.5
##   2:    setosa          1.4         0.2          4.9         3.0
##   3:    setosa          1.3         0.2          4.7         3.2
##   4:    setosa          1.5         0.2          4.6         3.1
##   5:    setosa          1.4         0.2          5.0         3.6
##  ---                                                            
## 146: virginica          5.2         2.3          6.7         3.0
## 147: virginica          5.0         1.9          6.3         2.5
## 148: virginica          5.2         2.0          6.5         3.0
## 149: virginica          5.4         2.3          6.2         3.4
## 150: virginica          5.1         1.8          5.9         3.0</code></pre>
<p><code>mlr3pipelines</code> is fundamentally built around <a href="https://r6.r-lib.org/"><code>R6</code></a>. When planning to create custom <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> objects, it can only help to <a href="https://adv-r.hadley.nz/r6.html">familiarize yourself with it</a>.</p>
<p>In principle, all a <code>PipeOp</code> must do is inherit from the <code>PipeOp</code> R6 class and implement the <code>.train()</code> and <code>.predict()</code> functions.
There are, however, several auxiliary subclasses that can make the creation of <em>certain</em> operations much easier.</p>
<div id="ext-pipeopcopy" class="section level3" number="7.3.1">
<h3>
<span class="header-section-number">7.3.1</span> General Case Example: <code>PipeOpCopy</code><a class="anchor" aria-label="anchor" href="#ext-pipeopcopy"><i class="fas fa-link"></i></a>
</h3>
<p>A very simple yet useful <code>PipeOp</code> is <code>PipeOpCopy</code>, which takes a single input and creates a variable number of output channels, all of which receive a copy of the input data.
It is a simple example that showcases the important steps in defining a custom <code>PipeOp</code>.
We will show a simplified version here, <strong><code>PipeOpCopyTwo</code></strong>, that creates exactly two copies of its input data.</p>
<p>The following figure visualizes how our <code>PipeOp</code> is situated in the <code>Pipeline</code> and the significant in- and outputs.</p>
<div class="inline-figure"><img src="images/po_multi_viz.png" width="430" style="display: block; margin: auto;"></div>
<div id="first-steps-inheriting-from-pipeop" class="section level4" number="7.3.1.1">
<h4>
<span class="header-section-number">7.3.1.1</span> First Steps: Inheriting from <code>PipeOp</code><a class="anchor" aria-label="anchor" href="#first-steps-inheriting-from-pipeop"><i class="fas fa-link"></i></a>
</h4>
<p>The first part of creating a custom <code>PipeOp</code> is inheriting from <code>PipeOp</code>.
We make a mental note that we need to implement a <code>.train()</code> and a <code>.predict()</code> function, and that we probably want to have an <code>initialize()</code> as well:</p>
<div class="sourceCode" id="cb675"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">PipeOpCopyTwo</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"PipeOpCopyTwo"</span>,
  inherit <span class="op">=</span> <span class="fu">mlr3pipelines</span><span class="fu">::</span><span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/PipeOp.html">PipeOp</a></span>,
  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"copy.two"</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">....</span>
    <span class="op">}</span>,
  <span class="op">)</span>,
  <span class="va">private</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    .train <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">....</span>
    <span class="op">}</span>,

    .predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">....</span>
    <span class="op">}</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Note, that <strong>private</strong> methods, e.g. <code>.train</code> and <code>.predict</code> etc are prefixed with a <code>.</code>.</p>
</div>
<div id="channel-definitions" class="section level4" number="7.3.1.2">
<h4>
<span class="header-section-number">7.3.1.2</span> Channel Definitions<a class="anchor" aria-label="anchor" href="#channel-definitions"><i class="fas fa-link"></i></a>
</h4>
<p>We need to tell the <code>PipeOp</code> the layout of its channels: How many there are, what their names are going to be, and what types are acceptable.
This is done on initialization of the <code>PipeOp</code> (using a <code>super$initialize</code> call) by giving the <code>input</code> and <code>output</code> <code>data.table</code> objects.
These must have three columns: a <code>"name"</code> column giving the names of input and output channels, and a <code>"train"</code> and <code>"predict"</code> column naming the class of objects we expect during training and prediction as input / output.
A special value for these classes is <code>"*"</code>, which indicates that any class will be accepted; our simple copy operator accepts any kind of input, so this will be useful. We have only one input, but two output channels.</p>
<p>By convention, we name a single channel <code>"input"</code> or <code>"output"</code>, and a group of channels [<code>"input1"</code>, <code>"input2"</code>, …], unless there is a reason to give specific different names. Therefore, our <code>input</code> <code>data.table</code> will have a single row <code>&lt;"input", "*", "*"&gt;</code>, and our <code>output</code> table will have two rows, <code>&lt;"output1", "*", "*"&gt;</code> and <code>&lt;"output2", "*", "*"&gt;</code>.</p>
<p>All of this is given to the <code>PipeOp</code> creator. Our <code>initialize()</code> will thus look as follows:</p>
<div class="sourceCode" id="cb676"><pre class="downlit sourceCode r">
<code class="sourceCode R">    <span class="va">initialize</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"copy.two"</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">input</span> <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"input"</span>, train <span class="op">=</span> <span class="st">"*"</span>, predict <span class="op">=</span> <span class="st">"*"</span><span class="op">)</span>
      <span class="co"># the following will create two rows and automatically fill the `train`</span>
      <span class="co"># and `predict` cols with "*"</span>
      <span class="va">output</span> <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
        name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"output1"</span>, <span class="st">"output2"</span><span class="op">)</span>,
        train <span class="op">=</span> <span class="st">"*"</span>, predict <span class="op">=</span> <span class="st">"*"</span>
      <span class="op">)</span>
      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">id</span>,
        input <span class="op">=</span> <span class="va">input</span>,
        output <span class="op">=</span> <span class="va">output</span>
      <span class="op">)</span>
    <span class="op">}</span></code></pre></div>
</div>
<div id="train-and-predict" class="section level4" number="7.3.1.3">
<h4>
<span class="header-section-number">7.3.1.3</span> Train and Predict<a class="anchor" aria-label="anchor" href="#train-and-predict"><i class="fas fa-link"></i></a>
</h4>
<p>Both <code>.train()</code> and <code>.predict()</code> will receive a <code>list</code> as input and must give a <code>list</code> in return.
According to our <code>input</code> and <code>output</code> definitions, we will always get a list with a single element as input, and will need to return a list with two elements. Because all we want to do is create two copies, we will just create the copies using <code>c(inputs, inputs)</code>.</p>
<p>Two things to consider:</p>
<ul>
<li><p>The <code>.train()</code> function must always modify the <code>self$state</code> variable to something that is not <code>NULL</code> or <code>NO_OP</code>.
This is because the <code>$state</code> slot is used as a signal that <code>PipeOp</code> has been trained on data, even if the state itself is not important to the <code>PipeOp</code> (as in our case).
Therefore, our <code>.train()</code> will set <code>self$state = list()</code>.</p></li>
<li><p>It is not necessary to “clone” our input or make deep copies, because we don’t modify the data.
However, if we were changing a reference-passed object, for example by changing data in a <code>Task</code>, we would have to make a deep copy first.
This is because a <code>PipeOp</code> may never modify its input object by reference.</p></li>
</ul>
<p>Our <code>.train()</code> and <code>.predict()</code> functions are now:</p>
<div class="sourceCode" id="cb677"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.train</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">self</span><span class="op">$</span><span class="va">state</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">inputs</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb678"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.predict</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">inputs</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="putting-it-together" class="section level4" number="7.3.1.4">
<h4>
<span class="header-section-number">7.3.1.4</span> Putting it Together<a class="anchor" aria-label="anchor" href="#putting-it-together"><i class="fas fa-link"></i></a>
</h4>
<p>The whole definition thus becomes</p>
<div class="sourceCode" id="cb679"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">PipeOpCopyTwo</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"PipeOpCopyTwo"</span>,
  inherit <span class="op">=</span> <span class="fu">mlr3pipelines</span><span class="fu">::</span><span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/PipeOp.html">PipeOp</a></span>,
  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"copy.two"</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">id</span>,
        input <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"input"</span>, train <span class="op">=</span> <span class="st">"*"</span>, predict <span class="op">=</span> <span class="st">"*"</span><span class="op">)</span>,
        output <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"output1"</span>, <span class="st">"output2"</span><span class="op">)</span>,
                            train <span class="op">=</span> <span class="st">"*"</span>, predict <span class="op">=</span> <span class="st">"*"</span><span class="op">)</span>
      <span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>,
  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    .train <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">self</span><span class="op">$</span><span class="va">state</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">inputs</span><span class="op">)</span>
    <span class="op">}</span>,

    .predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">inputs</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">inputs</span>, <span class="va">inputs</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>We can create an instance of our <code>PipeOp</code>, put it in a graph, and see what happens when we train it on something:</p>
<div class="sourceCode" id="cb680"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3pipelines.mlr-org.com">"mlr3pipelines"</a></span><span class="op">)</span>
<span class="va">poct</span> <span class="op">=</span> <span class="va">PipeOpCopyTwo</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">gr</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">poct</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span></code></pre></div>
<pre><code>## Graph with 1 PipeOps:
##        ID         State sccssors prdcssors
##  copy.two &lt;&lt;UNTRAINED&gt;&gt;</code></pre>
<div class="sourceCode" id="cb682"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></code></pre></div>
<pre><code>## List of 2
##  $ copy.two.output1:Classes 'TaskClassif', 'TaskSupervised', 'Task', 'R6' &lt;TaskClassif:iris&gt; 
##  $ copy.two.output2:Classes 'TaskClassif', 'TaskSupervised', 'Task', 'R6' &lt;TaskClassif:iris&gt;</code></pre>
</div>
</div>
<div id="ext-pipe-preproc" class="section level3" number="7.3.2">
<h3>
<span class="header-section-number">7.3.2</span> Special Case: Preprocessing<a class="anchor" aria-label="anchor" href="#ext-pipe-preproc"><i class="fas fa-link"></i></a>
</h3>
<p>Many <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s perform an operation on exactly one <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>, and return exactly one <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>. They may even not care about the “Target” / “Outcome” variable of that task, and only do some modification of some input data.
However, it is usually important to them that the <code>Task</code> on which they perform prediction has the same data columns as the <code>Task</code> on which they train.
For these cases, the auxiliary base class <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a> exists.
It inherits from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> itself, and other <code>PipeOp</code>s should use it if they fall in the kind of use-case named above.</p>
<p>When inheriting from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, one must either implement the private methods <code>.train_task()</code> and <code>.predict_task()</code>, or the methods <code>.train_dt()</code>, <code>.predict_dt()</code>, depending on whether wants to operate on a <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> object or on its data as <code>data.table</code>s.
In the second case, one can optionally also overload the <code>.select_cols()</code> method, which chooses which of the incoming <code>Task</code>’s features are given to the <code>.train_dt()</code> / <code>.predict_dt()</code> functions.</p>
<p>The following will show two examples: <code>PipeOpDropNA</code>, which removes a <code>Task</code>’s rows with missing values during training (and implements <code>.train_task()</code> and <code>.predict_task()</code>), and <code>PipeOpScale</code>, which scales a <code>Task</code>’s numeric columns (and implements <code>.train_dt()</code>, <code>.predict_dt()</code>, and <code>.select_cols()</code>).</p>
<div id="example-pipeopdropna" class="section level4" number="7.3.2.1">
<h4>
<span class="header-section-number">7.3.2.1</span> Example: <code>PipeOpDropNA</code><a class="anchor" aria-label="anchor" href="#example-pipeopdropna"><i class="fas fa-link"></i></a>
</h4>
<p>Dropping rows with missing values may be important when training a model that can not handle them.</p>
<p>Because <code>mlr3</code> <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Tasks</code></a> only contain a view to the underlying data, it is not necessary to modify data to remove rows with missing values.
Instead, the rows can be removed using the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>’s <code>$filter</code> method, which modifies the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> in-place.
This is done in the private method <code>.train_task()</code>.
We take care that we also set the <code>$state</code> slot to signal that the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> was trained.</p>
<p>The private method <code>.predict_task()</code> does not need to do anything; removing missing values during prediction is not as useful, since learners that cannot handle them will just ignore the respective rows.
Furthermore, <code>mlr3</code> expects a <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> to always return just as many predictions as it was given input rows, so a <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> that removes <code>Task</code> rows during training can not be used inside a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a>.</p>
<p>When we inherit from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, it sets the <code>input</code> and <code>output</code> <code>data.table</code>s for us to only accept a single <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a>.
The only thing we do during <code>initialize()</code> is therefore to set an <code>id</code> (which can optionally be changed by the user).</p>
<p>The complete <code>PipeOpDropNA</code> can therefore be written as follows.
Note that it inherits from <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, unlike the <code>PipeOpCopyTwo</code> example from above:</p>
<div class="sourceCode" id="cb684"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">PipeOpDropNA</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"PipeOpDropNA"</span>,
  inherit <span class="op">=</span> <span class="fu">mlr3pipelines</span><span class="fu">::</span><span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/PipeOpTaskPreproc.html">PipeOpTaskPreproc</a></span>,
  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"drop.na"</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span><span class="va">id</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>,

  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    .train_task <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">self</span><span class="op">$</span><span class="va">state</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
      <span class="va">featuredata</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>cols <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="va">feature_names</span><span class="op">)</span>
      <span class="va">exclude</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">featuredata</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">any</span><span class="op">)</span>
      <span class="va">task</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="va">row_ids</span><span class="op">[</span><span class="op">!</span><span class="va">exclude</span><span class="op">]</span><span class="op">)</span>
    <span class="op">}</span>,

    .predict_task <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span>
      <span class="co"># nothing to be done</span>
      <span class="va">task</span>
    <span class="op">}</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>To test this <code>PipeOp</code>, we create a small task with missing values:</p>
<div class="sourceCode" id="cb685"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">smalliris</span> <span class="op">=</span> <span class="va">iris</span><span class="op">[</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">*</span> <span class="fl">30</span>, <span class="op">]</span>
<span class="va">smalliris</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span>
<span class="va">smalliris</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span>
<span class="va">sitask</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_task_classif.html">as_task_classif</a></span><span class="op">(</span><span class="va">smalliris</span>, target <span class="op">=</span> <span class="st">"Species"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">sitask</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
## 1:     setosa          1.6         0.2           NA         3.2
## 2: versicolor          3.9         1.4          5.2          NA
## 3: versicolor          4.0         1.3          5.5         2.5
## 4:  virginica          5.0         1.5          6.0         2.2
## 5:  virginica          5.1         1.8          5.9         3.0</code></pre>
<p>We test this by feeding it to a new <code>Graph</code> that uses <code>PipeOpDropNA</code>.</p>
<div class="sourceCode" id="cb687"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">gr</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">PipeOpDropNA</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">filtered_task</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">sitask</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">filtered_task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##       Species Petal.Length Petal.Width Sepal.Length Sepal.Width
## 1: versicolor          4.0         1.3          5.5         2.5
## 2:  virginica          5.0         1.5          6.0         2.2
## 3:  virginica          5.1         1.8          5.9         3.0</code></pre>
</div>
<div id="example-pipeopscalealways" class="section level4" number="7.3.2.2">
<h4>
<span class="header-section-number">7.3.2.2</span> Example: <code>PipeOpScaleAlways</code><a class="anchor" aria-label="anchor" href="#example-pipeopscalealways"><i class="fas fa-link"></i></a>
</h4>
<p>An often-applied preprocessing step is to simply <strong>center</strong> and/or <strong>scale</strong> the data to mean <span class="math inline">\(0\)</span> and standard deviation <span class="math inline">\(1\)</span>.
This fits the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a> pattern quite well.
Because it always replaces all columns that it operates on, and does not require any information about the task’s target, it only needs to overload the <code>.train_dt()</code> and <code>.predict_dt()</code> functions.
This saves some boilerplate-code from getting the correct feature columns out of the task, and replacing them after modification.</p>
<p>Because scaling only makes sense on numeric features, we want to instruct <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a> to give us only these numeric columns.
We do this by overloading the <code>.select_cols()</code> function: It is called by the class to determine which columns to pass to <code>.train_dt()</code> and <code>.predict_dt()</code>.
Its input is the <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> that is being transformed, and it should return a <code>character</code> vector of all features to work with.
When it is not overloaded, it uses all columns; instead, we will set it to only give us numeric columns.
Because the <code><a href="https://rdrr.io/r/base/levels.html">levels()</a></code> of the data table given to <code>.train_dt()</code> and <code>.predict_dt()</code> may be different from the <code>task</code>’s levels, these functions must also take a <code>levels</code> argument that is a named list of column names indicating their levels.
When working with numeric data, this argument can be ignored, but it should be used instead of <code>levels(dt[[column]])</code> for factorial or character columns.</p>
<p>This is the first <code>PipeOp</code> where we will be using the <code>$state</code> slot for something useful: We save the centering offset and scaling coefficient and use it in <code>$.predict()</code>!</p>
<p>For simplicity, we are not using hyperparameters and will always scale and center all data.
Compare this <code>PipeOpScaleAlways</code> operator to the one defined inside the <code>mlr3pipelines</code> package, <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a>.</p>
<div class="sourceCode" id="cb689"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">PipeOpScaleAlways</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"PipeOpScaleAlways"</span>,
  inherit <span class="op">=</span> <span class="fu">mlr3pipelines</span><span class="fu">::</span><span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/PipeOpTaskPreproc.html">PipeOpTaskPreproc</a></span>,
  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"scale.always"</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span>id <span class="op">=</span> <span class="va">id</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>,

  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    .select_cols <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">task</span><span class="op">$</span><span class="va">feature_types</span><span class="op">[</span><span class="va">type</span> <span class="op">==</span> <span class="st">"numeric"</span>, <span class="va">id</span><span class="op">]</span>
    <span class="op">}</span>,

    .train_dt <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">levels</span>, <span class="va">target</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">sc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span>
      <span class="va">self</span><span class="op">$</span><span class="va">state</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"scaled:center"</span><span class="op">)</span>,
        scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">sc</span>, <span class="st">"scaled:scale"</span><span class="op">)</span>
      <span class="op">)</span>
      <span class="va">sc</span>
    <span class="op">}</span>,

    .predict_dt <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">levels</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">-</span> <span class="va">self</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="va">center</span><span class="op">)</span> <span class="op">/</span> <span class="va">self</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="va">scale</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p><em>(Note for the observant: If you check <code>PipeOpScale.R</code> from the <code>mlr3pipelines</code> package, you will notice that is uses “<code>get("type")</code>” and “<code>get("id")</code>” instead of “<code>type</code>” and “<code>id</code>”, because the static code checker on CRAN would otherwise complain about references to undefined variables. This is a “problem” with <code>data.table</code> and not exclusive to <code>mlr3pipelines</code>.)</em></p>
<p>We can, again, create a new <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> that uses this <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> to test it.
Compare the resulting data to the original “iris” <code>Task</code> data printed at the beginning:</p>
<div class="sourceCode" id="cb690"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">gr</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">PipeOpScaleAlways</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">result</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>

<span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width
##   1:    setosa      -1.3358     -1.3111     -0.89767     1.01560
##   2:    setosa      -1.3358     -1.3111     -1.13920    -0.13154
##   3:    setosa      -1.3924     -1.3111     -1.38073     0.32732
##   4:    setosa      -1.2791     -1.3111     -1.50149     0.09789
##   5:    setosa      -1.3358     -1.3111     -1.01844     1.24503
##  ---                                                            
## 146: virginica       0.8169      1.4440      1.03454    -0.13154
## 147: virginica       0.7036      0.9192      0.55149    -1.27868
## 148: virginica       0.8169      1.0504      0.79301    -0.13154
## 149: virginica       0.9302      1.4440      0.43072     0.78617
## 150: virginica       0.7602      0.7880      0.06843    -0.13154</code></pre>
</div>
</div>
<div id="special-case-preprocessing-with-simple-train" class="section level3" number="7.3.3">
<h3>
<span class="header-section-number">7.3.3</span> Special Case: Preprocessing with Simple Train<a class="anchor" aria-label="anchor" href="#special-case-preprocessing-with-simple-train"><i class="fas fa-link"></i></a>
</h3>
<p>It is possible to make even further simplifications for many <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s that perform mostly the same operation during training and prediction.
The point of <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> preprocessing is often to modify the training data in mostly the same way as prediction data (but in a way that <em>may</em> depend on training data).</p>
<p>Consider constant feature removal, for example: The goal is to remove features that have no variance, or only a single factor level.
However, what features get removed must be decided during <em>training</em>, and may only depend on training data.
Furthermore, the actual process of removing features is the same during training and prediction.</p>
<p>A simplification to make is therefore to have a private method <code>.get_state(task)</code> which sets the <code>$state</code> slot during training, and a private method <code>.transform(task)</code>, which gets called both during training <em>and</em> prediction.
This is done in the <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreprocSimple.html"><code>PipeOpTaskPreprocSimple</code></a> class.
Just like <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, one can inherit from this and overload these functions to get a <code>PipeOp</code> that performs preprocessing with very little boilerplate code.</p>
<p>Just like <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreproc.html"><code>PipeOpTaskPreproc</code></a>, <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreprocSimple.html"><code>PipeOpTaskPreprocSimple</code></a> offers the possibility to instead overload the <code>.get_state_dt(dt, levels)</code> and <code>.transform_dt(dt, levels)</code> methods (and optionally, again, the <code>.select_cols(task)</code> function) to operate on <code>data.table</code> feature data instead of the whole <code>Task</code>.</p>
<p>Even some methods that do not use <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOpTaskPreprocSimple.html"><code>PipeOpTaskPreprocSimple</code></a> <em>could</em> work in a similar way: The <code>PipeOpScaleAlways</code> example from above will be shown to also work with this paradigm.</p>
<div id="example-pipeopdropconst" class="section level4" number="7.3.3.1">
<h4>
<span class="header-section-number">7.3.3.1</span> Example: <code>PipeOpDropConst</code><a class="anchor" aria-label="anchor" href="#example-pipeopdropconst"><i class="fas fa-link"></i></a>
</h4>
<p>A typical example of a preprocessing operation that does almost the same operation during training and prediction is an operation that drops features depending on a criterion that is evaluated during training.
One simple example of this is dropping constant features.
Because the <code>mlr3</code> <code>Task</code> class offers a flexible view on underlying data, it is most efficient to drop columns from the task directly using its <code>$select()</code> function, so the <code>.get_state_dt(dt, levels)</code> / <code>.transform_dt(dt, levels)</code> functions will <em>not</em> get used; instead we overload the <code>.get_state(task)</code> and <code>.transform(task)</code> methods.</p>
<p>The <code>.get_state()</code> function’s result is saved to the <code>$state</code> slot, so we want to return something that is useful for dropping features.
We choose to save the names of all the columns that have nonzero variance.
For brevity, we use <code>length(unique(column)) &gt; 1</code> to check whether more than one distinct value is present; a more sophisticated version could have a tolerance parameter for numeric values that are very close to each other.</p>
<p>The <code>.transform()</code> method is evaluated both during training <em>and</em> prediction, and can rely on the <code>$state</code> slot being present.
All it does here is call the <code>Task$select</code> function with the columns we chose to keep.</p>
<p>The full <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> could be written as follows:</p>
<div class="sourceCode" id="cb692"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">PipeOpDropConst</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"PipeOpDropConst"</span>,
  inherit <span class="op">=</span> <span class="fu">mlr3pipelines</span><span class="fu">::</span><span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/PipeOpTaskPreprocSimple.html">PipeOpTaskPreprocSimple</a></span>,
  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"drop.const"</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span>id <span class="op">=</span> <span class="va">id</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>,

  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    .get_state <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">data</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>cols <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="va">feature_names</span><span class="op">)</span>
      <span class="va">nonconst</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">data</span>, <span class="kw">function</span><span class="op">(</span><span class="va">column</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">column</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span>
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>cnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="va">nonconst</span><span class="op">]</span><span class="op">)</span>
    <span class="op">}</span>,

    .transform <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">task</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="va">cnames</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>This can be tested using the first five rows of the “Iris” <code>Task</code>, for which one feature (<code>"Petal.Width"</code>) is constant:</p>
<div class="sourceCode" id="cb693"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">irishead</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="fu">clone</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>
<span class="va">irishead</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##    Species Petal.Length Petal.Width Sepal.Length Sepal.Width
## 1:  setosa          1.4         0.2          5.1         3.5
## 2:  setosa          1.4         0.2          4.9         3.0
## 3:  setosa          1.3         0.2          4.7         3.2
## 4:  setosa          1.5         0.2          4.6         3.1
## 5:  setosa          1.4         0.2          5.0         3.6</code></pre>
<div class="sourceCode" id="cb695"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">PipeOpDropConst</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">dropped_task</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">irishead</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>

<span class="va">dropped_task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##    Species Petal.Length Sepal.Length Sepal.Width
## 1:  setosa          1.4          5.1         3.5
## 2:  setosa          1.4          4.9         3.0
## 3:  setosa          1.3          4.7         3.2
## 4:  setosa          1.5          4.6         3.1
## 5:  setosa          1.4          5.0         3.6</code></pre>
<p>We can also see that the <code>$state</code> was correctly set.
Calling <code>$.predict()</code> with this graph, even with different data (the whole Iris <code>Task</code>!) will still drop the <code>"Petal.Width"</code> column, as it should.</p>
<div class="sourceCode" id="cb697"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gr</span><span class="op">$</span><span class="va">pipeops</span><span class="op">$</span><span class="va">drop.const</span><span class="op">$</span><span class="va">state</span></code></pre></div>
<pre><code>## $cnames
## [1] "Petal.Length" "Sepal.Length" "Sepal.Width" 
## 
## $affected_cols
## [1] "Petal.Length" "Petal.Width"  "Sepal.Length" "Sepal.Width" 
## 
## $intasklayout
##              id    type
## 1: Petal.Length numeric
## 2:  Petal.Width numeric
## 3: Sepal.Length numeric
## 4:  Sepal.Width numeric
## 
## $outtasklayout
##              id    type
## 1: Petal.Length numeric
## 2: Sepal.Length numeric
## 3:  Sepal.Width numeric
## 
## $outtaskshell
## Empty data.table (0 rows and 4 cols): Species,Petal.Length,Sepal.Length,Sepal.Width</code></pre>
<div class="sourceCode" id="cb699"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dropped_predict</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>

<span class="va">dropped_predict</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##        Species Petal.Length Sepal.Length Sepal.Width
##   1:    setosa          1.4          5.1         3.5
##   2:    setosa          1.4          4.9         3.0
##   3:    setosa          1.3          4.7         3.2
##   4:    setosa          1.5          4.6         3.1
##   5:    setosa          1.4          5.0         3.6
##  ---                                                
## 146: virginica          5.2          6.7         3.0
## 147: virginica          5.0          6.3         2.5
## 148: virginica          5.2          6.5         3.0
## 149: virginica          5.4          6.2         3.4
## 150: virginica          5.1          5.9         3.0</code></pre>
</div>
<div id="example-pipeopscalealwayssimple" class="section level4" number="7.3.3.2">
<h4>
<span class="header-section-number">7.3.3.2</span> Example: <code>PipeOpScaleAlwaysSimple</code><a class="anchor" aria-label="anchor" href="#example-pipeopscalealwayssimple"><i class="fas fa-link"></i></a>
</h4>
<p>This example will show how a <code>PipeOpTaskPreprocSimple</code> can be used when only working on feature data in form of a <code>data.table</code>.
Instead of calling the <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> function, the <code>center</code> and <code>scale</code> values are calculated directly and saved to the <code>$state</code> slot.
The <code>.transform_dt()</code> function will then perform the same operation during both training and prediction: subtract the <code>center</code> and divide by the <code>scale</code> value.
As in the <a href="extending.html#example-pipeopscalealways"><code>PipeOpScaleAlways</code> example above</a>, we use <code>.select_cols()</code> so that we only work on numeric columns.</p>
<div class="sourceCode" id="cb701"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">PipeOpScaleAlwaysSimple</span> <span class="op">=</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"PipeOpScaleAlwaysSimple"</span>,
  inherit <span class="op">=</span> <span class="fu">mlr3pipelines</span><span class="fu">::</span><span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/PipeOpTaskPreprocSimple.html">PipeOpTaskPreprocSimple</a></span>,
  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span> <span class="op">=</span> <span class="st">"scale.always.simple"</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">super</span><span class="op">$</span><span class="fu">initialize</span><span class="op">(</span>id <span class="op">=</span> <span class="va">id</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>,

  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    .select_cols <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">task</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">task</span><span class="op">$</span><span class="va">feature_types</span><span class="op">[</span><span class="va">type</span> <span class="op">==</span> <span class="st">"numeric"</span>, <span class="va">id</span><span class="op">]</span>
    <span class="op">}</span>,

    .get_state_dt <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">levels</span>, <span class="va">target</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">dt</span>, <span class="va">mean</span><span class="op">)</span>,
        scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">dt</span>, <span class="va">sd</span><span class="op">)</span>
      <span class="op">)</span>
    <span class="op">}</span>,

    .transform_dt <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span>, <span class="va">levels</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">-</span> <span class="va">self</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="va">center</span><span class="op">)</span> <span class="op">/</span> <span class="va">self</span><span class="op">$</span><span class="va">state</span><span class="op">$</span><span class="va">scale</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>We can compare this <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> to the one above to show that it behaves the same.</p>
<div class="sourceCode" id="cb702"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">PipeOpScaleAlways</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">result_posa</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>

<span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">PipeOpScaleAlwaysSimple</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">result_posa_simple</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></code></pre></div>
<div class="sourceCode" id="cb703"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result_posa</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width
##   1:    setosa      -1.3358     -1.3111     -0.89767     1.01560
##   2:    setosa      -1.3358     -1.3111     -1.13920    -0.13154
##   3:    setosa      -1.3924     -1.3111     -1.38073     0.32732
##   4:    setosa      -1.2791     -1.3111     -1.50149     0.09789
##   5:    setosa      -1.3358     -1.3111     -1.01844     1.24503
##  ---                                                            
## 146: virginica       0.8169      1.4440      1.03454    -0.13154
## 147: virginica       0.7036      0.9192      0.55149    -1.27868
## 148: virginica       0.8169      1.0504      0.79301    -0.13154
## 149: virginica       0.9302      1.4440      0.43072     0.78617
## 150: virginica       0.7602      0.7880      0.06843    -0.13154</code></pre>
<div class="sourceCode" id="cb705"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result_posa_simple</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width
##   1:    setosa      -1.3358     -1.3111     -0.89767     1.01560
##   2:    setosa      -1.3358     -1.3111     -1.13920    -0.13154
##   3:    setosa      -1.3924     -1.3111     -1.38073     0.32732
##   4:    setosa      -1.2791     -1.3111     -1.50149     0.09789
##   5:    setosa      -1.3358     -1.3111     -1.01844     1.24503
##  ---                                                            
## 146: virginica       0.8169      1.4440      1.03454    -0.13154
## 147: virginica       0.7036      0.9192      0.55149    -1.27868
## 148: virginica       0.8169      1.0504      0.79301    -0.13154
## 149: virginica       0.9302      1.4440      0.43072     0.78617
## 150: virginica       0.7602      0.7880      0.06843    -0.13154</code></pre>
</div>
</div>
<div id="ext-pipe-hyperpars" class="section level3" number="7.3.4">
<h3>
<span class="header-section-number">7.3.4</span> Hyperparameters<a class="anchor" aria-label="anchor" href="#ext-pipe-hyperpars"><i class="fas fa-link"></i></a>
</h3>
<p><code>mlr3pipelines</code> uses the <a href="https://paradox.mlr-org.com"><code>paradox</code></a> package to define parameter spaces for <code>PipeOp</code>s.
Parameters for <code>PipeOp</code>s can modify their behavior in certain ways, e.g. switch centering or scaling off in the <code>PipeOpScale</code> operator.
The unified interface makes it possible to have parameters for whole <code>Graph</code>s that modify the individual <code>PipeOp</code>’s behavior.
The <code>Graph</code>s, when encapsulated in <code>GraphLearner</code>s, can even be tuned using the tuning functionality in <a href="https://mlr3tuning.mlr-org.com">mlr3tuning</a>.</p>
<p>Hyperparameters are declared during initialization, when calling the <code>PipeOp</code>’s <code>$initialize()</code> function, by giving a <code>param_set</code> argument.
The <code>param_set</code> must be a <code>ParamSet</code> from the <code>paradox</code> package; see <a href="optimization.html#searchspace">the tuning chapter</a> or the <a href="technical.html#paradox">in-depth <code>paradox</code> chapter</a> for more information on how to define parameter spaces.
After construction, the <code>ParamSet</code> can be accessed through the <code>$param_set</code> slot.
While it is <em>possible</em> to modify this <code>ParamSet</code>, using e.g. the <code>$add()</code> and <code>$add_dep()</code> functions, <em>after</em> adding it to the <code>PipeOp</code>, it is strongly advised against.</p>
<p>Hyperparameters can be set and queried through the <code>$values</code> slot.
When setting hyperparameters, they are automatically checked to satisfy all conditions set by the <code>$param_set</code>, so it is not necessary to type check them.
Be aware that it is always possible to <em>remove</em> hyperparameter values.</p>
<p>When a <code>PipeOp</code> is initialized, it usually does not have any parameter values—<code>$values</code> takes the value <code><a href="https://rdrr.io/r/base/list.html">list()</a></code>.
It is possible to set initial parameter values in the <code>$initialize()</code> constructor; this must be done <em>after</em> the <code>super$initialize()</code> call where the corresponding <code>ParamSet</code> must be supplied.
This is because setting <code>$values</code> checks against the current <code>$param_set</code>, which would fail if the <code>$param_set</code> was not set yet.</p>
<p>When using an underlying library function (the <code>scale</code> function in <code>PipeOpScale</code>, say), then there is usually a “default” behaviour of that function when a parameter is not given.
It is good practice to use this default behaviour whenever a parameter is not set (or when it was removed).
This can easily be done when using the <a href="https://mlr3misc.mlr-org.com">mlr3misc</a> library’s <a href="https://mlr3misc.mlr-org.com/reference/invoke.html"><code>mlr3misc::invoke()</code></a> function, which has functionality similar to <a href="https://www.rdocumentation.org/packages/base/topics/do.call"><code>do.call()</code></a>.</p>
<div id="hyperparameter-example-pipeopscale" class="section level4" number="7.3.4.1">
<h4>
<span class="header-section-number">7.3.4.1</span> Hyperparameter Example: <code>PipeOpScale</code><a class="anchor" aria-label="anchor" href="#hyperparameter-example-pipeopscale"><i class="fas fa-link"></i></a>
</h4>
<p>How to use hyperparameters can best be shown through the example of <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a>, which is very similar to the example above, <code>PipeOpScaleAlways</code>.
The difference is made by the presence of hyperparameters.
<a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a> constructs a <code>ParamSet</code> in its <code>$initialize</code> function and passes this on to the <code>super$initialize</code> function:</p>
<div class="sourceCode" id="cb707"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">PipeOpScale</span><span class="op">$</span><span class="va">public_methods</span><span class="op">$</span><span class="va">initialize</span></code></pre></div>
<pre><code>## function (id = "scale", param_vals = list()) 
## .__PipeOpScale__initialize(self = self, private = private, super = super, 
##     id = id, param_vals = param_vals)
## &lt;environment: namespace:mlr3pipelines&gt;</code></pre>
<p>The user has access to this and can set and get parameters.
Types are automatically checked:</p>
<div class="sourceCode" id="cb709"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pss</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3pipelines.mlr-org.com//reference/po.html">po</a></span><span class="op">(</span><span class="st">"scale"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">pss</span><span class="op">$</span><span class="va">param_set</span><span class="op">)</span></code></pre></div>
<pre><code>## &lt;ParamSet:scale&gt;
##                id    class lower upper nlevels        default value
## 1:         center ParamLgl    NA    NA       2           TRUE      
## 2:          scale ParamLgl    NA    NA       2           TRUE      
## 3:         robust ParamLgl    NA    NA       2 &lt;NoDefault[3]&gt; FALSE
## 4: affect_columns ParamUty    NA    NA     Inf  &lt;Selector[1]&gt;</code></pre>
<div class="sourceCode" id="cb711"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pss</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">center</span> <span class="op">=</span> <span class="cn">FALSE</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">pss</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">)</span></code></pre></div>
<pre><code>## $robust
## [1] FALSE
## 
## $center
## [1] FALSE</code></pre>
<div class="sourceCode" id="cb713"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pss</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">scale</span> <span class="op">=</span> <span class="st">"TRUE"</span>  <span class="co"># bad input is checked!</span></code></pre></div>
<pre><code>## Error in self$assert(xs): Assertion on 'xs' failed: scale: Must be of type 'logical flag', not 'character'.</code></pre>
<p>How <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a> handles its parameters can be seen in its <code>$.train_dt</code> method: It gets the relevant parameters from its <code>$values</code> slot and uses them in the <a href="https://mlr3misc.mlr-org.com/reference/invoke.html"><code>mlr3misc::invoke()</code></a> call.
This has the advantage over calling <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> directly that if a parameter is not given, its default value from the <a href="https://www.rdocumentation.org/packages/base/topics/scale"><code>scale()</code></a> function will be used.</p>
<div class="sourceCode" id="cb715"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">PipeOpScale</span><span class="op">$</span><span class="va">private_methods</span><span class="op">$</span><span class="va">.train_dt</span></code></pre></div>
<pre><code>## function (dt, levels, target) 
## .__PipeOpScale__.train_dt(self = self, private = private, super = super, 
##     dt = dt, levels = levels, target = target)
## &lt;environment: namespace:mlr3pipelines&gt;</code></pre>
<p>Another change that is necessary compared to <code>PipeOpScaleAlways</code> is that the attributes <code>"scaled:scale"</code> and <code>"scaled:center"</code> are not always present, depending on parameters, and possibly need to be set to default values <span class="math inline">\(1\)</span> or <span class="math inline">\(0\)</span>, respectively.</p>
<p>It is now even possible (if a bit pointless) to call <code>PipeOpScale</code> with both <code>scale</code> and <code>center</code> set to <code>FALSE</code>, which returns the original dataset, unchanged.</p>
<div class="sourceCode" id="cb717"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pss</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">scale</span> <span class="op">=</span> <span class="cn">FALSE</span>
<span class="va">pss</span><span class="op">$</span><span class="va">param_set</span><span class="op">$</span><span class="va">values</span><span class="op">$</span><span class="va">center</span> <span class="op">=</span> <span class="cn">FALSE</span>

<span class="va">gr</span> <span class="op">=</span> <span class="va"><a href="https://mlr3pipelines.mlr-org.com//reference/Graph.html">Graph</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">gr</span><span class="op">$</span><span class="fu">add_pipeop</span><span class="op">(</span><span class="va">pss</span><span class="op">)</span>

<span class="va">result</span> <span class="op">=</span> <span class="va">gr</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span>

<span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>##        Species Petal.Length Petal.Width Sepal.Length Sepal.Width
##   1:    setosa          1.4         0.2          5.1         3.5
##   2:    setosa          1.4         0.2          4.9         3.0
##   3:    setosa          1.3         0.2          4.7         3.2
##   4:    setosa          1.5         0.2          4.6         3.1
##   5:    setosa          1.4         0.2          5.0         3.6
##  ---                                                            
## 146: virginica          5.2         2.3          6.7         3.0
## 147: virginica          5.0         1.9          6.3         2.5
## 148: virginica          5.2         2.0          6.5         3.0
## 149: virginica          5.4         2.3          6.2         3.4
## 150: virginica          5.1         1.8          5.9         3.0</code></pre>

</div>
</div>
</div>
<div id="extending-tuners" class="section level2" number="7.4">
<h2>
<span class="header-section-number">7.4</span> Adding new Tuners<a class="anchor" aria-label="anchor" href="#extending-tuners"><i class="fas fa-link"></i></a>
</h2>
<p>In this section, we show how to implement a custom tuner for <a href="https://mlr3tuning.mlr-org.com">mlr3tuning</a>.
The main task of a tuner is to iteratively propose new hyperparameter configurations that we want to evaluate for a given task, learner and validation strategy.
The second task is to decide which configuration should be returned as a tuning result - usually it is the configuration that led to the best observed performance value.
If you want to implement your own tuner, you have to implement an R6-Object that offers an <a href="extending.html#tuner-optimize"><code>.optimize</code></a> method that implements the iterative proposal and you are free to implement <a href="extending.html#tuner-add-result"><code>.assign_result</code></a> to differ from the before-mentioned default process of determining the result.</p>
<p>Before you start with the implementation make yourself familiar with the main R6-Objects in <a href="https://bbotk.mlr-org.com">bbotk</a> (Black-Box Optimization Toolkit).
This package does not only provide basic black box optimization algorithms and but also the objects that represent the optimization problem (<code><a href="https://bbotk.mlr-org.com/reference/OptimInstance.html">bbotk::OptimInstance</a></code>) and the log of all evaluated configurations (<code><a href="https://bbotk.mlr-org.com/reference/Archive.html">bbotk::Archive</a></code>).</p>
<p>There are two ways to implement a new tuner:
a ) If your new tuner can be applied to any kind of optimization problem it should be implemented as a <code><a href="https://bbotk.mlr-org.com/reference/Optimizer.html">bbotk::Optimizer</a></code>.
Any <code><a href="https://bbotk.mlr-org.com/reference/Optimizer.html">bbotk::Optimizer</a></code> can be easily transformed to a <code><a href="https://mlr3tuning.mlr-org.com/reference/Tuner.html">mlr3tuning::Tuner</a></code>.
b) If the new custom tuner is only usable for hyperparameter tuning, for example because it needs to access the task, learner or resampling objects it should be directly implemented in <a href="https://mlr3tuning.mlr-org.com">mlr3tuning</a> as a <code><a href="https://mlr3tuning.mlr-org.com/reference/Tuner.html">mlr3tuning::Tuner</a></code>.</p>
<div id="extending-tuners-summary" class="section level3" number="7.4.1">
<h3>
<span class="header-section-number">7.4.1</span> Adding a new Tuner<a class="anchor" aria-label="anchor" href="#extending-tuners-summary"><i class="fas fa-link"></i></a>
</h3>
<p>This is a summary of steps for adding a new tuner.
The fifth step is only required if the new tuner is added via <a href="https://bbotk.mlr-org.com">bbotk</a>.</p>
<ol style="list-style-type: decimal">
<li>Check the tuner does not already exist as a <a href="https://github.com/mlr-org/bbotk/tree/master/R"><code>bbotk::Optimizer</code></a> or <a href="https://github.com/mlr-org/mlr3tuning/tree/master/R"><code>mlr3tuning::Tuner</code></a> in the GitHub repositories.</li>
<li>Use one of the existing optimizers / tuners as a <a href="extending.html#tuner-template">template</a>.</li>
<li>Overwrite the <a href="extending.html#tuner-optimize"><code>.optimize</code></a> private method of the optimizer / tuner.</li>
<li>Optionally, overwrite the default <a href="extending.html#tuner-add-result"><code>.assign_result</code></a> private method.</li>
<li>Use the <a href="extending.html#tuner-from-optimizer"><code>mlr3tuning::TunerFromOptimizer</code></a> class to transform the <code><a href="https://bbotk.mlr-org.com/reference/Optimizer.html">bbotk::Optimizer</a></code> to a <code><a href="https://mlr3tuning.mlr-org.com/reference/Tuner.html">mlr3tuning::Tuner</a></code>.</li>
<li>Add <a href="extending.html#tuner-test">unit tests</a> for the tuner and optionally for the optimizer.</li>
<li>Open a new pull request for the <a href="https://github.com/mlr-org/mlr3tuning/pulls"><code>mlr3tuning::Tuner</code></a> and optionally a second one for the <a href="https://github.com/mlr-org/bbotk/pulls"><code>bbotk::Optimizer</code></a>.</li>
</ol>
</div>
<div id="tuner-template" class="section level3" number="7.4.2">
<h3>
<span class="header-section-number">7.4.2</span> Template<a class="anchor" aria-label="anchor" href="#tuner-template"><i class="fas fa-link"></i></a>
</h3>
<p>If the new custom tuner is implemented via <a href="https://bbotk.mlr-org.com">bbotk</a>, use one of the existing optimizer as a template e.g. <a href="https://github.com/mlr-org/bbotk/blob/master/R/OptimizerRandomSearch.R"><code>bbotk::OptimizerRandomSearch</code></a>. There are currently only two tuners that are not based on a <code><a href="https://bbotk.mlr-org.com/reference/Optimizer.html">bbotk::Optimizer</a></code>: <a href="https://github.com/mlr-org/mlr3hyperband/blob/master/R/TunerHyperband.R"><code>mlr3hyperband::TunerHyperband</code></a> and <a href="https://github.com/mlr-org/mlr3tuning/blob/master/R/TunerIrace.R"><code>mlr3tuning::TunerIrace</code></a>. Both are rather complex but you can still use the documentation and class structure as a template. The following steps are identical for optimizers and tuners.</p>
<p>Rewrite the meta information in the documentation and create a new class name.
Scientific sources can be added in <code>R/bibentries.R</code> which are added under <code>@source</code> in the documentation.
The example and dictionary sections of the documentation are auto-generated based on the <code>@templateVar id &lt;tuner_id&gt;</code>.
Change the parameter set of the optimizer / tuner and document them under <code>@section Parameters</code>.
Do not forget to change <code>mlr_optimizers$add()</code> / <code>mlr_tuners$add()</code> in the last line which adds the optimizer / tuner to the dictionary.</p>
</div>
<div id="tuner-optimize" class="section level3" number="7.4.3">
<h3>
<span class="header-section-number">7.4.3</span> Optimize method<a class="anchor" aria-label="anchor" href="#tuner-optimize"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>$.optimize()</code> private method is the main part of the tuner.
It takes an instance, proposes new points and calls the <code>$eval_batch()</code> method of the instance to evaluate them.
Here you can go two ways: Implement the iterative process yourself or call an external optimization function that resides in another package.</p>
<div id="writing-a-custom-iteration" class="section level4" number="7.4.3.1">
<h4>
<span class="header-section-number">7.4.3.1</span> Writing a custom iteration<a class="anchor" aria-label="anchor" href="#writing-a-custom-iteration"><i class="fas fa-link"></i></a>
</h4>
<p>Usually, the proposal and evaluation is done in a <code>repeat</code>-loop which you have to implement.
Please consider the following points:</p>
<ul>
<li>You can evaluate one or multiple points per iteration</li>
<li>You don’t have to care about termination, as <code>$eval_batch()</code> won’t allow more evaluations then allowed by the <code><a href="https://bbotk.mlr-org.com/reference/Terminator.html">bbotk::Terminator</a></code>. This implies, that code after the <code>repeat</code>-loop will not be executed.</li>
<li>You don’t have to care about keeping track of the evaluations as every evaluation is automatically stored in <code>inst$archive</code>.</li>
<li>If you want to log additional information for each evaluation of the <code>bbotk::Objective`` in the</code>bbotk::Archive<code>you can simply add columns to the</code>data.table<code>object that is passed to</code>$eval_batch()`.</li>
</ul>
</div>
<div id="calling-an-external-optimization-function" class="section level4" number="7.4.3.2">
<h4>
<span class="header-section-number">7.4.3.2</span> Calling an external optimization function<a class="anchor" aria-label="anchor" href="#calling-an-external-optimization-function"><i class="fas fa-link"></i></a>
</h4>
<p>Optimization functions from external packages usually take an objective function as an argument.
In this case, you can pass <code>inst$objective_function</code> which internally calls <code>$eval_batch()</code>.
Check out <a href="https://github.com/mlr-org/bbotk/blob/master/R/OptimizerGenSA.R"><code>OptimizerGenSA</code></a> for an example.</p>
</div>
</div>
<div id="tuner-add-result" class="section level3" number="7.4.4">
<h3>
<span class="header-section-number">7.4.4</span> Assign result method<a class="anchor" aria-label="anchor" href="#tuner-add-result"><i class="fas fa-link"></i></a>
</h3>
<p>The default <code>$.assign_result()</code> private method simply obtains the best performing result from the archive.
The default method can be overwritten if the new tuner determines the result of the optimization in a different way.
The new function must call the <code>$assign_result()</code> method of the instance to write the final result to the instance.
See <a href="https://github.com/mlr-org/mlr3tuning/blob/master/R/TunerIrace.R"><code>mlr3tuning::TunerIrace</code></a> for an implementation of <code>$.assign_result()</code>.</p>
</div>
<div id="tuner-from-optimizer" class="section level3" number="7.4.5">
<h3>
<span class="header-section-number">7.4.5</span> Transform optimizer to tuner<a class="anchor" aria-label="anchor" href="#tuner-from-optimizer"><i class="fas fa-link"></i></a>
</h3>
<p>This step is only needed if you implement via <a href="https://bbotk.mlr-org.com">bbotk</a>.
The <code><a href="https://mlr3tuning.mlr-org.com/reference/TunerFromOptimizer.html">mlr3tuning::TunerFromOptimizer</a></code> class transforms a <code><a href="https://bbotk.mlr-org.com/reference/Optimizer.html">bbotk::Optimizer</a></code> to a <code><a href="https://mlr3tuning.mlr-org.com/reference/Tuner.html">mlr3tuning::Tuner</a></code>.
Just add the <code><a href="https://bbotk.mlr-org.com/reference/Optimizer.html">bbotk::Optimizer</a></code> to the <code>optimizer</code> field.
See <a href="https://github.com/mlr-org/mlr3tuning/blob/master/R/TunerRandomSearch.R"><code>mlr3tuning::TunerRandomSearch</code></a> for an example.</p>
</div>
<div id="tuner-test" class="section level3" number="7.4.6">
<h3>
<span class="header-section-number">7.4.6</span> Add unit tests<a class="anchor" aria-label="anchor" href="#tuner-test"><i class="fas fa-link"></i></a>
</h3>
<p>The new custom tuner should be thoroughly tested with unit tests.
<code><a href="https://mlr3tuning.mlr-org.com/reference/Tuner.html">mlr3tuning::Tuner</a></code>s can be tested with the <code>test_tuner()</code> helper function.
If you added the Tuner via a <code><a href="https://bbotk.mlr-org.com/reference/Optimizer.html">bbotk::Optimizer</a></code>, you should additionally test the <code><a href="https://bbotk.mlr-org.com/reference/Optimizer.html">bbotk::Optimizer</a></code> with the <code>test_optimizer()</code> helper function.</p>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="technical.html"><span class="header-section-number">6</span> Technical</a></div>
<div class="next"><a href="special-tasks.html"><span class="header-section-number">8</span> Special Tasks</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#extending"><span class="header-section-number">7</span> Extending</a></li>
<li>
<a class="nav-link" href="#extending-learners"><span class="header-section-number">7.1</span> Adding new Learners</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#setup"><span class="header-section-number">7.1.1</span> Setting-up mlr3extralearners</a></li>
<li><a class="nav-link" href="#create-learner"><span class="header-section-number">7.1.2</span> Calling create_learner</a></li>
<li><a class="nav-link" href="#learner_package_type_key.r"><span class="header-section-number">7.1.3</span> learner_package_type_key.R</a></li>
<li><a class="nav-link" href="#learner-meta-information"><span class="header-section-number">7.1.4</span> Meta-information</a></li>
<li><a class="nav-link" href="#param-set"><span class="header-section-number">7.1.5</span> ParamSet</a></li>
<li><a class="nav-link" href="#learner-train"><span class="header-section-number">7.1.6</span> Train function</a></li>
<li><a class="nav-link" href="#learner-predict"><span class="header-section-number">7.1.7</span> Predict function</a></li>
<li><a class="nav-link" href="#learner-control"><span class="header-section-number">7.1.8</span> Control objects/functions of learners</a></li>
<li><a class="nav-link" href="#learner-test"><span class="header-section-number">7.1.9</span> Testing the learner</a></li>
<li><a class="nav-link" href="#cleaning"><span class="header-section-number">7.1.10</span> Package Cleaning</a></li>
<li><a class="nav-link" href="#thanks-and-maintenance"><span class="header-section-number">7.1.11</span> Thanks and Maintenance</a></li>
<li><a class="nav-link" href="#learner-faq"><span class="header-section-number">7.1.12</span> Learner FAQ</a></li>
</ul>
</li>
<li><a class="nav-link" href="#extending-measures"><span class="header-section-number">7.2</span> Adding new Measures</a></li>
<li>
<a class="nav-link" href="#extending-pipeops"><span class="header-section-number">7.3</span> Adding new PipeOps</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#ext-pipeopcopy"><span class="header-section-number">7.3.1</span> General Case Example: PipeOpCopy</a></li>
<li><a class="nav-link" href="#ext-pipe-preproc"><span class="header-section-number">7.3.2</span> Special Case: Preprocessing</a></li>
<li><a class="nav-link" href="#special-case-preprocessing-with-simple-train"><span class="header-section-number">7.3.3</span> Special Case: Preprocessing with Simple Train</a></li>
<li><a class="nav-link" href="#ext-pipe-hyperpars"><span class="header-section-number">7.3.4</span> Hyperparameters</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#extending-tuners"><span class="header-section-number">7.4</span> Adding new Tuners</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#extending-tuners-summary"><span class="header-section-number">7.4.1</span> Adding a new Tuner</a></li>
<li><a class="nav-link" href="#tuner-template"><span class="header-section-number">7.4.2</span> Template</a></li>
<li><a class="nav-link" href="#tuner-optimize"><span class="header-section-number">7.4.3</span> Optimize method</a></li>
<li><a class="nav-link" href="#tuner-add-result"><span class="header-section-number">7.4.4</span> Assign result method</a></li>
<li><a class="nav-link" href="#tuner-from-optimizer"><span class="header-section-number">7.4.5</span> Transform optimizer to tuner</a></li>
<li><a class="nav-link" href="#tuner-test"><span class="header-section-number">7.4.6</span> Add unit tests</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/mlr-org/mlr3book/blob/main/bookdown/07-extending.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/mlr-org/mlr3book/edit/main/bookdown/07-extending.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>mlr3 book</strong>" was written by Marc Becker, Martin Binder, Bernd Bischl, Lars Kotthoff, Michel Lang, Florian Pfisterer, Nicholas G. Reich, Jakob Richter, Patrick Schratz, Raphael Sonabend, Damir Pulatov. It was last built on 2021-11-14.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
